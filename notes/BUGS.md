# BUGS

## BUG记录

来自调试：

* [X] 需要兼容整行或多行参数值中对双引号的特别转义
* [X] 需要兼容本地化文本中对左方括号的转义（`[[`）
* [ ] 在`PARAM = xxx`后面输入回车会产生不正确的自动缩进（应当与语言注入有关）
* [ ] `QuoteIdentifierIntention`和`UnquoteIdentifierIntention`不直接适用于用引号括起的参数值中的那些字面量（例如，`p = "\"v\""`中的的`\"v\"`）
* [ ] 对于用引号括起的参数值中的那些字面量（例如，`p = "\"v\""`中的的`\"v\"`），如果用引号括起，由于已被转义一次，会导致中断规则匹配 - IDEA自身BUG？
* [ ] 进行代码补全时，考虑优先补全那些不需要访问索引的，能够比较快速地计算出结果的项

来自Github仓库：

* [X] 无法及时检测项目本地的规则文件的更改？ - 基本修复？
* [ ] 无法正确注入`on_action`中事件引用的事件类型？ - 未复现，很神奇
* [ ] 重新打开项目后，IDE无法完成对脚本文件的解析？ - 可能是内存不足导致
* [ ] `scope[species]`应当始终可以匹配`this` - 如果无法准确匹配，需要直接匹配同类型的第一个规则 - 待验证
* [X] 作用域上下文的内嵌提示显示有问题 - 应当显示在`possible = {`后面，且要求`{`之后不存在空白以外的字符
* [X] `some_trigger = value`中的`value`不应当被特别高亮

来自CWTools的Github仓库：

* [X] [The tool cannot recognize in-script flag variables (Vic3) · Issue #76 · cwtools/cwtools-vscode (github.com)](https://github.com/cwtools/cwtools-vscode/issues/76)
* [X] [[Stellaris\] Could support tech@level grammar? · Issue #58 · cwtools/cwtools-vscode (github.com)](https://github.com/cwtools/cwtools-vscode/issues/58)
* [X] [Parsing issues in Vic3 · Issue #53 · cwtools/cwtools (github.com)](https://github.com/cwtools/cwtools/issues/53)

## BUG分析

### 涉及内联脚本与适用语言注入的参数时，IDE可能卡死的问题

结论：

应当是调用`LoadingCache.get`或者`ConcurrentMap.computeIfAbsent`导致，尝试改为调用`ConcurrentMap.getOrPut`，避免改变锁行为

堆栈：

```
"JobScheduler FJ pool 2/15" prio=0 tid=0x0 nid=0x0 waiting on condition
     java.lang.Thread.State: WAITING
 on com.google.common.util.concurrent.SettableFuture@538c2e7e
	at java.base@17.0.9/jdk.internal.misc.Unsafe.park(Native Method)
	at java.base@17.0.9/java.util.concurrent.locks.LockSupport.park(LockSupport.java:211)
	at com.google.common.util.concurrent.AbstractFuture.get(AbstractFuture.java:561)
	at com.google.common.util.concurrent.AbstractFuture$TrustedFuture.get(AbstractFuture.java:111)
	at com.google.common.util.concurrent.Uninterruptibles.getUninterruptibly(Uninterruptibles.java:247)
	at com.google.common.cache.LocalCache$LoadingValueReference.waitForValue(LocalCache.java:3628)
	at com.google.common.cache.LocalCache$Segment.waitForLoadingValue(LocalCache.java:2211)
	at com.google.common.cache.LocalCache$Segment.get(LocalCache.java:2075)
	at com.google.common.cache.LocalCache.get(LocalCache.java:4019)
	at com.google.common.cache.LocalCache$LocalManualCache.get(LocalCache.java:4933)
	at icu.windea.pls.core.util.CancelableCache.get(Caches.kt:33)
	at icu.windea.pls.config.CwtConfigContext.getConfigs(CwtConfigContext.kt:49)
	at icu.windea.pls.lang.CwtConfigHandler.doGetConfigs(CwtConfigHandler.kt:377)
	at icu.windea.pls.lang.CwtConfigHandler.getConfigs(CwtConfigHandler.kt:334)
	at icu.windea.pls.lang.CwtConfigHandler.getConfigs$default(CwtConfigHandler.kt:322)
	at icu.windea.pls.script.references.ParadoxScriptExpressionReferenceProvider.getReferencesByElement(ParadoxScriptExpressionReferenceProvider.kt:32)
	at com.intellij.psi.impl.source.resolve.reference.ReferenceProvidersRegistryImpl.getReferences(ReferenceProvidersRegistryImpl.java:184)
	at com.intellij.psi.impl.source.resolve.reference.ReferenceProvidersRegistryImpl.mapNotEmptyReferencesFromProviders(ReferenceProvidersRegistryImpl.java:165)
	at com.intellij.psi.impl.source.resolve.reference.ReferenceProvidersRegistryImpl.doGetReferencesFromProviders(ReferenceProvidersRegistryImpl.java:144)
	at com.intellij.psi.impl.source.resolve.reference.ReferenceProvidersRegistry.lambda$getReferencesFromProviders$0(ReferenceProvidersRegistry.java:44)
	at com.intellij.psi.impl.source.resolve.reference.ReferenceProvidersRegistry$$Lambda$4826/0x00000008021a17f8.compute(Unknown Source)
	at com.intellij.psi.util.CachedValuesManager$1.compute(CachedValuesManager.java:158)
	at com.intellij.psi.impl.PsiCachedValueImpl.doCompute(PsiCachedValueImpl.java:37)
	at com.intellij.util.CachedValueBase.lambda$getValueWithLock$3(CachedValueBase.java:240)
	at com.intellij.util.CachedValueBase$$Lambda$2217/0x000000080148d768.compute(Unknown Source)
	at com.intellij.util.CachedValueBase.computeData(CachedValueBase.java:43)
	at com.intellij.util.CachedValueBase.lambda$getValueWithLock$4(CachedValueBase.java:240)
	at com.intellij.util.CachedValueBase$$Lambda$2216/0x000000080148d4f8.compute(Unknown Source)
	at com.intellij.openapi.util.RecursionGuard$$Lambda$1726/0x00000008011713d0.compute(Unknown Source)
	at com.intellij.openapi.util.RecursionManager$1.computePreventingRecursion(RecursionManager.java:111)
	at com.intellij.openapi.util.RecursionGuard.doPreventingRecursion(RecursionGuard.java:27)
	at com.intellij.openapi.util.RecursionManager.doPreventingRecursion(RecursionManager.java:66)
	at com.intellij.util.CachedValueBase.getValueWithLock(CachedValueBase.java:241)
	at com.intellij.psi.impl.PsiCachedValueImpl.getValue(PsiCachedValueImpl.java:27)
	at com.intellij.util.CachedValuesManagerImpl.getCachedValue(CachedValuesManagerImpl.java:69)
	at com.intellij.psi.util.CachedValuesManager.getCachedValue(CachedValuesManager.java:155)
	at com.intellij.psi.util.CachedValuesManager.getCachedValue(CachedValuesManager.java:121)
	at com.intellij.psi.impl.source.resolve.reference.ReferenceProvidersRegistry.getReferencesFromProviders(ReferenceProvidersRegistry.java:42)
	at com.intellij.psi.PsiReferenceServiceImpl.doGetReferences(PsiReferenceServiceImpl.java:32)
	at com.intellij.psi.PsiReferenceServiceImpl.getReferences(PsiReferenceServiceImpl.java:25)
	at com.intellij.psi.PsiReferenceService.getContributedReferences(PsiReferenceService.java:33)
	at icu.windea.pls.script.psi.impl.ParadoxScriptPsiImplUtil.getReferences(ParadoxScriptPsiImplUtil.kt:864)
	at icu.windea.pls.script.psi.impl.ParadoxScriptPropertyKeyImpl.getReferences(ParadoxScriptPropertyKeyImpl.java:100)
	at icu.windea.pls.lang.index.ParadoxDynamicValueIndexSupport.indexScriptElement(ParadoxExpressionIndexSupports.Core.kt:60)
	at icu.windea.pls.core.index.ParadoxExpressionIndex$indexDataForScriptFile$1.visitElement(ParadoxExpressionIndex.kt:55)
	at com.intellij.psi.impl.PsiElementBase.accept(PsiElementBase.java:270)
	at icu.windea.pls.script.psi.impl.ParadoxScriptPropertyKeyImpl.accept(ParadoxScriptPropertyKeyImpl.java:34)
	at com.intellij.psi.PsiWalkingState.visit(PsiWalkingState.java:53)
	at com.intellij.psi.PsiWalkingState.visit(PsiWalkingState.java:10)
	at com.intellij.util.WalkingState.walkChildren(WalkingState.java:65)
	at com.intellij.util.WalkingState.elementStarted(WalkingState.java:42)
	at com.intellij.psi.PsiWalkingState.elementStarted(PsiWalkingState.java:62)
	at com.intellij.psi.PsiRecursiveElementWalkingVisitor.visitElement(PsiRecursiveElementWalkingVisitor.java:34)
	at icu.windea.pls.core.index.ParadoxExpressionIndex$indexDataForScriptFile$1.visitElement(ParadoxExpressionIndex.kt:82)
	at com.intellij.psi.impl.PsiElementBase.accept(PsiElementBase.java:270)
	at icu.windea.pls.script.psi.impl.ParadoxScriptRootBlockImpl.accept(ParadoxScriptRootBlockImpl.java:30)
	at com.intellij.psi.impl.source.tree.SharedImplUtil.acceptChildren(SharedImplUtil.java:183)
	at com.intellij.psi.impl.source.PsiFileImpl.acceptChildren(PsiFileImpl.java:748)
	at icu.windea.pls.core.index.ParadoxExpressionIndex.indexDataForScriptFile(ParadoxExpressionIndex.kt:52)
	at icu.windea.pls.core.index.ParadoxExpressionIndex.indexData(ParadoxExpressionIndex.kt:42)
	at icu.windea.pls.core.index.ParadoxFileBasedIndex.buildFileData(ParadoxFileBasedIndex.kt:86)
	at icu.windea.pls.core.index.ParadoxFileBasedIndex.getIndexer$lambda$0(ParadoxFileBasedIndex.kt:21)
	at icu.windea.pls.core.index.ParadoxFileBasedIndex$$Lambda$1237/0x0000000800c294b8.map(Unknown Source)
	at com.intellij.util.indexing.impl.MapReduceIndex.mapByIndexer(MapReduceIndex.java:318)
	at com.intellij.util.indexing.impl.MapReduceIndex.mapInput(MapReduceIndex.java:309)
	at com.intellij.util.indexing.impl.MapReduceIndex.mapInputAndPrepareUpdate(MapReduceIndex.java:254)
	at com.intellij.indexing.composite.CompositeInvertedIndexBase.updateBaseIndex(CompositeInvertedIndexBase.java:284)
	at com.intellij.indexing.composite.CompositeInvertedIndexBase.mapInputAndPrepareUpdate(CompositeInvertedIndexBase.java:64)
	at com.intellij.indexing.composite.CompositeInvertedIndexBase.mapInputAndPrepareUpdate(CompositeInvertedIndexBase.java:30)
	at com.intellij.util.indexing.FileBasedIndexImpl.updateIndexInNonCancellableSection(FileBasedIndexImpl.java:1029)
	at com.intellij.util.indexing.FileBasedIndexImpl.lambda$indexUnsavedDocument$15(FileBasedIndexImpl.java:1003)
	at com.intellij.util.indexing.FileBasedIndexImpl$$Lambda$6371/0x0000000802963760.run(Unknown Source)
	at com.intellij.openapi.fileTypes.impl.FileTypeManagerImpl.freezeFileTypeTemporarilyWithProvidedValueIn(FileTypeManagerImpl.java:678)
	at com.intellij.openapi.fileTypes.impl.FileTypeManagerImpl.freezeFileTypeTemporarilyIn(FileTypeManagerImpl.java:661)
	at com.intellij.util.indexing.FileBasedIndexImpl.indexUnsavedDocument(FileBasedIndexImpl.java:992)
	at com.intellij.util.indexing.RegisteredIndexes$DocumentUpdateTask.doProcess(RegisteredIndexes.java:189)
	at com.intellij.util.indexing.RegisteredIndexes$DocumentUpdateTask.doProcess(RegisteredIndexes.java:180)
	at com.intellij.util.indexing.UpdateTask.process(UpdateTask.java:63)
	at com.intellij.util.indexing.UpdateTask.processAll(UpdateTask.java:32)
	at com.intellij.util.indexing.FileBasedIndexImpl.lambda$indexUnsavedDocuments$14(FileBasedIndexImpl.java:959)
	at com.intellij.util.indexing.FileBasedIndexImpl$$Lambda$6366/0x0000000802962380.compute(Unknown Source)
	at com.intellij.util.indexing.StorageBufferingHandler.runUpdate(StorageBufferingHandler.java:22)
	at com.intellij.util.indexing.FileBasedIndexImpl.indexUnsavedDocuments(FileBasedIndexImpl.java:959)
	at com.intellij.util.indexing.FileBasedIndexImpl.ensureUpToDate(FileBasedIndexImpl.java:790)
	at com.intellij.util.indexing.FileBasedIndexEx.processExceptions(FileBasedIndexEx.java:303)
	at com.intellij.util.indexing.FileBasedIndexEx.getFileData(FileBasedIndexEx.java:196)
	at icu.windea.pls.core.index.ParadoxFileBasedIndex.getFileData(ParadoxFileBasedIndex.kt:106)
	at icu.windea.pls.core.index.ParadoxExpressionIndex.getFileData(ParadoxExpressionIndex.kt:167)
	at icu.windea.pls.core.search.ParadoxInlineScriptUsageSearcher.processQuery$lambda$1(ParadoxInlineScriptUsageSearcher.kt:34)
	at icu.windea.pls.core.search.ParadoxInlineScriptUsageSearcher$$Lambda$5103/0x0000000802312140.process(Unknown Source)
	at com.intellij.psi.search.FileTypeIndex.processFiles(FileTypeIndex.java:55)
	at icu.windea.pls.core.search.ParadoxInlineScriptUsageSearcher.doProcessFiles(ParadoxInlineScriptUsageSearcher.kt:48)
	at icu.windea.pls.core.search.ParadoxInlineScriptUsageSearcher.processQuery(ParadoxInlineScriptUsageSearcher.kt:29)
	at icu.windea.pls.core.search.ParadoxInlineScriptUsageSearcher.processQuery(ParadoxInlineScriptUsageSearcher.kt:19)
	at com.intellij.openapi.application.QueryExecutorBase.execute(QueryExecutorBase.java:76)
	at com.intellij.util.ExecutorsQuery.processResults(ExecutorsQuery.java:30)
	at com.intellij.util.AbstractQuery.doProcessResults(AbstractQuery.java:83)
	at com.intellij.util.AbstractQuery.delegateProcessResults(AbstractQuery.java:100)
	at icu.windea.pls.core.search.ParadoxQuery.forEach(ParadoxQuery.kt:81)
	at icu.windea.pls.lang.ParadoxInlineScriptHandler.doGetInferredContextConfigsFromUsages(ParadoxInlineScriptHandler.kt:266)
	at icu.windea.pls.lang.ParadoxInlineScriptHandler.doGetInferredContextConfigs(ParadoxInlineScriptHandler.kt:161)
	at icu.windea.pls.lang.ParadoxInlineScriptHandler.getInferredContextConfigs(ParadoxInlineScriptHandler.kt:149)
	at icu.windea.pls.lang.config.CwtInlineScriptConfigContextProvider.getConfigs(CwtConfigContextProviders.kt:187)
	at icu.windea.pls.config.CwtConfigContext.doGetConfigs(CwtConfigContext.kt:65)
	at icu.windea.pls.config.CwtConfigContext.getConfigs$lambda$2$lambda$1$lambda$0(CwtConfigContext.kt:50)
	at icu.windea.pls.config.CwtConfigContext$$Lambda$4939/0x0000000801c6c6d0.call(Unknown Source)
	at com.google.common.cache.LocalCache$LocalManualCache$1.load(LocalCache.java:4938)
	at com.google.common.cache.LocalCache$LoadingValueReference.loadFuture(LocalCache.java:3576)
	at com.google.common.cache.LocalCache$Segment.loadSync(LocalCache.java:2318)
	at com.google.common.cache.LocalCache$Segment.lockedGetOrLoad(LocalCache.java:2191)
	at com.google.common.cache.LocalCache$Segment.get(LocalCache.java:2081)
	at com.google.common.cache.LocalCache.get(LocalCache.java:4019)
	at com.google.common.cache.LocalCache$LocalManualCache.get(LocalCache.java:4933)
	at icu.windea.pls.core.util.CancelableCache.get(Caches.kt:33)
	at icu.windea.pls.config.CwtConfigContext.getConfigs(CwtConfigContext.kt:49)
	at icu.windea.pls.lang.config.CwtInlineScriptConfigContextProvider.getConfigs(CwtConfigContextProviders.kt:181)
	at icu.windea.pls.config.CwtConfigContext.doGetConfigs(CwtConfigContext.kt:65)
	at icu.windea.pls.config.CwtConfigContext.getConfigs$lambda$2$lambda$1$lambda$0(CwtConfigContext.kt:50)
	at icu.windea.pls.config.CwtConfigContext$$Lambda$4939/0x0000000801c6c6d0.call(Unknown Source)
	at com.google.common.cache.LocalCache$LocalManualCache$1.load(LocalCache.java:4938)
	at com.google.common.cache.LocalCache$LoadingValueReference.loadFuture(LocalCache.java:3576)
	at com.google.common.cache.LocalCache$Segment.loadSync(LocalCache.java:2318)
	at com.google.common.cache.LocalCache$Segment.lockedGetOrLoad(LocalCache.java:2191)
	at com.google.common.cache.LocalCache$Segment.get(LocalCache.java:2081)
	at com.google.common.cache.LocalCache.get(LocalCache.java:4019)
	at com.google.common.cache.LocalCache$LocalManualCache.get(LocalCache.java:4933)
	at icu.windea.pls.core.util.CancelableCache.get(Caches.kt:33)
	at icu.windea.pls.config.CwtConfigContext.getConfigs(CwtConfigContext.kt:49)
	at icu.windea.pls.lang.CwtConfigHandler.doGetConfigs(CwtConfigHandler.kt:377)
	at icu.windea.pls.lang.CwtConfigHandler.getConfigs(CwtConfigHandler.kt:334)
	at icu.windea.pls.lang.CwtConfigHandler.getConfigs$default(CwtConfigHandler.kt:322)
	at icu.windea.pls.script.references.ParadoxScriptExpressionReferenceProvider.getReferencesByElement(ParadoxScriptExpressionReferenceProvider.kt:32)
	at com.intellij.psi.impl.source.resolve.reference.ReferenceProvidersRegistryImpl.getReferences(ReferenceProvidersRegistryImpl.java:184)
	at com.intellij.psi.impl.source.resolve.reference.ReferenceProvidersRegistryImpl.mapNotEmptyReferencesFromProviders(ReferenceProvidersRegistryImpl.java:165)
	at com.intellij.psi.impl.source.resolve.reference.ReferenceProvidersRegistryImpl.doGetReferencesFromProviders(ReferenceProvidersRegistryImpl.java:144)
	at com.intellij.psi.impl.source.resolve.reference.ReferenceProvidersRegistry.lambda$getReferencesFromProviders$0(ReferenceProvidersRegistry.java:44)
	at com.intellij.psi.impl.source.resolve.reference.ReferenceProvidersRegistry$$Lambda$4826/0x00000008021a17f8.compute(Unknown Source)
	at com.intellij.psi.util.CachedValuesManager$1.compute(CachedValuesManager.java:158)
	at com.intellij.psi.impl.PsiCachedValueImpl.doCompute(PsiCachedValueImpl.java:37)
	at com.intellij.util.CachedValueBase.lambda$getValueWithLock$3(CachedValueBase.java:240)
	at com.intellij.util.CachedValueBase$$Lambda$2217/0x000000080148d768.compute(Unknown Source)
	at com.intellij.util.CachedValueBase.computeData(CachedValueBase.java:43)
	at com.intellij.util.CachedValueBase.lambda$getValueWithLock$4(CachedValueBase.java:240)
	at com.intellij.util.CachedValueBase$$Lambda$2216/0x000000080148d4f8.compute(Unknown Source)
	at com.intellij.openapi.util.RecursionGuard$$Lambda$1726/0x00000008011713d0.compute(Unknown Source)
	at com.intellij.openapi.util.RecursionManager$1.computePreventingRecursion(RecursionManager.java:111)
	at com.intellij.openapi.util.RecursionGuard.doPreventingRecursion(RecursionGuard.java:27)
	at com.intellij.openapi.util.RecursionManager.doPreventingRecursion(RecursionManager.java:66)
	at com.intellij.util.CachedValueBase.getValueWithLock(CachedValueBase.java:241)
	at com.intellij.psi.impl.PsiCachedValueImpl.getValue(PsiCachedValueImpl.java:27)
	at com.intellij.util.CachedValuesManagerImpl.getCachedValue(CachedValuesManagerImpl.java:69)
	at com.intellij.psi.util.CachedValuesManager.getCachedValue(CachedValuesManager.java:155)
	at com.intellij.psi.util.CachedValuesManager.getCachedValue(CachedValuesManager.java:121)
	at com.intellij.psi.impl.source.resolve.reference.ReferenceProvidersRegistry.getReferencesFromProviders(ReferenceProvidersRegistry.java:42)
	at com.intellij.psi.PsiReferenceServiceImpl.doGetReferences(PsiReferenceServiceImpl.java:32)
	at com.intellij.psi.PsiReferenceServiceImpl.getReferences(PsiReferenceServiceImpl.java:25)
	at com.intellij.psi.PsiReferenceService.getContributedReferences(PsiReferenceService.java:33)
	at icu.windea.pls.script.psi.impl.ParadoxScriptPsiImplUtil.getReferences(ParadoxScriptPsiImplUtil.kt:864)
	at icu.windea.pls.script.psi.impl.ParadoxScriptPropertyKeyImpl.getReferences(ParadoxScriptPropertyKeyImpl.java:100)
	at icu.windea.pls.script.psi.impl.ParadoxScriptPsiImplUtil.getReference(ParadoxScriptPsiImplUtil.kt:858)
	at icu.windea.pls.script.psi.impl.ParadoxScriptPropertyKeyImpl.getReference(ParadoxScriptPropertyKeyImpl.java:94)
	at icu.windea.pls.script.codeInsight.hints.ParadoxDefinitionReferenceInfoHintsProvider.collect(ParadoxDefinitionReferenceInfoHintsProvider.kt:37)
	at icu.windea.pls.script.codeInsight.hints.ParadoxDefinitionReferenceInfoHintsProvider.collect(ParadoxDefinitionReferenceInfoHintsProvider.kt:17)
	at icu.windea.pls.script.codeInsight.hints.ParadoxScriptHintsProvider$getCollectorFor$1.collect(ParadoxScriptHintsProvider.kt:36)
	at com.intellij.codeInsight.hints.CollectorWithSettings.collectHints(InlayHintsUtils.kt:91)
	at com.intellij.codeInsight.hints.InlayHintsPass.doCollectInformation$lambda$1(InlayHintsPass.kt:60)
	at com.intellij.codeInsight.hints.InlayHintsPass$$Lambda$5785/0x00000008026c63f0.process(Unknown Source)
	at com.intellij.concurrency.ApplierCompleter.execAndForkSubTasks(ApplierCompleter.java:139)
	at com.intellij.concurrency.ApplierCompleter.execAndForkSubTasks(ApplierCompleter.java:152)
	at com.intellij.concurrency.ApplierCompleter$$Lambda$5788/0x00000008026c68c0.run(Unknown Source)
	at com.intellij.openapi.application.impl.ApplicationImpl.tryRunReadAction(ApplicationImpl.java:1075)
	at com.intellij.concurrency.ApplierCompleter.lambda$wrapInReadActionAndIndicator$1(ApplierCompleter.java:96)
	at com.intellij.concurrency.ApplierCompleter$$Lambda$5772/0x00000008026ba9a0.run(Unknown Source)
	at com.intellij.openapi.progress.impl.CoreProgressManager.lambda$executeProcessUnderProgress$12(CoreProgressManager.java:610)
	at com.intellij.openapi.progress.impl.CoreProgressManager$$Lambda$933/0x00000008009a0f78.compute(Unknown Source)
	at com.intellij.openapi.progress.impl.CoreProgressManager.registerIndicatorAndRun(CoreProgressManager.java:685)
	at com.intellij.openapi.progress.impl.CoreProgressManager.computeUnderProgress(CoreProgressManager.java:641)
	at com.intellij.openapi.progress.impl.CoreProgressManager.executeProcessUnderProgress(CoreProgressManager.java:609)
	at com.intellij.openapi.progress.impl.ProgressManagerImpl.executeProcessUnderProgress(ProgressManagerImpl.java:78)
	at com.intellij.concurrency.ApplierCompleter.wrapInReadActionAndIndicator(ApplierCompleter.java:108)
	at com.intellij.concurrency.ApplierCompleter.compute(ApplierCompleter.java:89)
	at com.intellij.concurrency.JobLauncherImpl.invokeConcurrentlyUnderProgress(JobLauncherImpl.java:63)
	at com.intellij.codeInsight.hints.InlayHintsPass.doCollectInformation(InlayHintsPass.kt:52)
	at com.intellij.codeHighlighting.TextEditorHighlightingPass.collectInformation(TextEditorHighlightingPass.java:55)
	at com.intellij.codeInsight.daemon.impl.PassExecutorService$ScheduledPass.lambda$doRun$1(PassExecutorService.java:406)
	at com.intellij.codeInsight.daemon.impl.PassExecutorService$ScheduledPass$$Lambda$5748/0x00000008026b6b68.consume(Unknown Source)
	at com.intellij.platform.diagnostic.telemetry.helpers.TraceKt.runWithSpanIgnoreThrows(trace.kt:76)
	at com.intellij.platform.diagnostic.telemetry.helpers.TraceUtil.runWithSpanThrows(TraceUtil.java:34)
	at com.intellij.codeInsight.daemon.impl.PassExecutorService$ScheduledPass.lambda$doRun$2(PassExecutorService.java:401)
	at com.intellij.codeInsight.daemon.impl.PassExecutorService$ScheduledPass$$Lambda$5745/0x00000008026b66d8.run(Unknown Source)
	at com.intellij.openapi.application.impl.ApplicationImpl.tryRunReadAction(ApplicationImpl.java:1075)
	at com.intellij.codeInsight.daemon.impl.PassExecutorService$ScheduledPass.lambda$doRun$3(PassExecutorService.java:392)
	at com.intellij.codeInsight.daemon.impl.PassExecutorService$ScheduledPass$$Lambda$5743/0x00000008026b6248.run(Unknown Source)
	at com.intellij.openapi.progress.impl.CoreProgressManager.lambda$executeProcessUnderProgress$12(CoreProgressManager.java:610)
	at com.intellij.openapi.progress.impl.CoreProgressManager$$Lambda$933/0x00000008009a0f78.compute(Unknown Source)
	at com.intellij.openapi.progress.impl.CoreProgressManager.registerIndicatorAndRun(CoreProgressManager.java:685)
	at com.intellij.openapi.progress.impl.CoreProgressManager.computeUnderProgress(CoreProgressManager.java:641)
	at com.intellij.openapi.progress.impl.CoreProgressManager.executeProcessUnderProgress(CoreProgressManager.java:609)
	at com.intellij.openapi.progress.impl.ProgressManagerImpl.executeProcessUnderProgress(ProgressManagerImpl.java:78)
	at com.intellij.codeInsight.daemon.impl.PassExecutorService$ScheduledPass.doRun(PassExecutorService.java:391)
	at com.intellij.codeInsight.daemon.impl.PassExecutorService$ScheduledPass.lambda$run$0(PassExecutorService.java:367)
	at com.intellij.codeInsight.daemon.impl.PassExecutorService$ScheduledPass$$Lambda$5741/0x00000008026adb98.run(Unknown Source)
	at com.intellij.openapi.application.impl.ReadMostlyRWLock.executeByImpatientReader(ReadMostlyRWLock.java:200)
	at com.intellij.openapi.application.impl.ApplicationImpl.executeByImpatientReader(ApplicationImpl.java:184)
	at com.intellij.codeInsight.daemon.impl.PassExecutorService$ScheduledPass.run(PassExecutorService.java:365)
	at com.intellij.concurrency.JobLauncherImpl$VoidForkJoinTask$1.exec(JobLauncherImpl.java:187)
	at java.base@17.0.9/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:373)
	at java.base@17.0.9/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1182)
	at java.base@17.0.9/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1655)
	at java.base@17.0.9/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1622)
	at java.base@17.0.9/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:165)
```

```
is@stellaris:0#0#astral_rift/unlock_from_pool_if_relic_not_owned:if/limit/prev/NOT

WAITING
< icu.windea.pls.config.CwtConfigContext.getConfigs
 < icu.windea.pls.lang.index.ParadoxDynamicValueIndexSupport.indexScriptElement
 < icu.windea.pls.lang.index.ParadoxParameterIndexSupport.indexScriptElement
 < icu.windea.pls.lang.index.ParadoxLocalisationParameterParameterIndexSupport.indexScriptElement
```

### `ParadoxExpressionManager.getExpressionReferences`中使用的缓存可能不一致的问题

推测：

不好复现，可能是因为正在索引，不同线程中得到的来自索引的数据不同，因而最终解析得到的引用（`PsiReference`）列表不一致。

堆栈：

```
com.intellij.diagnostic.PluginException: Non-idempotent computation: it returns different results when invoked multiple times or on different threads:
  1 != 0
  which is length of [icu.windea.pls.script.references.ParadoxScriptExpressionPsiReference(ParadoxScriptString(value=nanotech_world):(0,14))] and []

Recomputation gives com.intellij.util.CachedValueBase$Data@599dd127 which is equivalent to 'fresh'
	at com.intellij.diagnostic.PluginProblemReporterImpl.createPluginExceptionByClass(PluginProblemReporterImpl.java:23)
	at com.intellij.diagnostic.PluginException.createByClass(PluginException.java:90)
	at com.intellij.util.IdempotenceChecker.reportFailure(IdempotenceChecker.java:98)
	at com.intellij.util.IdempotenceChecker.checkEquivalence(IdempotenceChecker.java:83)
	at com.intellij.util.CachedValueBase.getValueWithLock(CachedValueBase.java:246)
	at com.intellij.psi.impl.PsiCachedValueImpl$Direct.getValue(PsiCachedValueImpl.kt:81)
	at com.intellij.util.CachedValuesManagerImpl.getCachedValue(CachedValuesManagerImpl.java:83)
	at com.intellij.psi.util.CachedValuesManager.getCachedValue(CachedValuesManager.java:170)
	at icu.windea.pls.lang.util.ParadoxExpressionManager.doGetExpressionReferencesFromCache(ParadoxExpressionManager.kt:743)
	at icu.windea.pls.lang.util.ParadoxExpressionManager.getExpressionReferences(ParadoxExpressionManager.kt:731)
	at icu.windea.pls.script.references.ParadoxScriptExpressionReferenceProvider.getReferencesByElement(ParadoxScriptExpressionReferenceProvider.kt:23)
	at com.intellij.psi.impl.source.resolve.reference.ReferenceProvidersRegistryImpl.getReferences(ReferenceProvidersRegistryImpl.java:162)
	at com.intellij.psi.impl.source.resolve.reference.ReferenceProvidersRegistryImpl.mapNotEmptyReferencesFromProviders(ReferenceProvidersRegistryImpl.java:143)
	at com.intellij.psi.impl.source.resolve.reference.ReferenceProvidersRegistryImpl.doGetReferencesFromProviders(ReferenceProvidersRegistryImpl.java:122)
	at com.intellij.psi.impl.source.resolve.reference.ReferenceProvidersRegistry.getReferencesFromProviders(ReferenceProvidersRegistry.java:51)
	at com.intellij.psi.PsiReferenceServiceImpl.doGetReferences(PsiReferenceServiceImpl.java:32)
	at com.intellij.psi.PsiReferenceServiceImpl.getReferences(PsiReferenceServiceImpl.java:25)
	at com.intellij.codeInsight.highlighting.HyperlinkAnnotator.lambda$static$0(HyperlinkAnnotator.java:82)
	at com.intellij.psi.impl.PsiParameterizedCachedValue.doCompute(PsiParameterizedCachedValue.kt:23)
	at com.intellij.util.CachedValueBase.lambda$getValueWithLock$3(CachedValueBase.java:236)
	at com.intellij.util.CachedValueBase.computeData(CachedValueBase.java:43)
	at com.intellij.util.CachedValueBase.lambda$getValueWithLock$4(CachedValueBase.java:236)
	at com.intellij.openapi.util.RecursionManager$1.computePreventingRecursion(RecursionManager.java:111)
	at com.intellij.openapi.util.RecursionGuard.doPreventingRecursion(RecursionGuard.java:27)
	at com.intellij.openapi.util.RecursionManager.doPreventingRecursion(RecursionManager.java:66)
	at com.intellij.util.CachedValueBase.getValueWithLock(CachedValueBase.java:237)
	at com.intellij.psi.impl.PsiParameterizedCachedValue.getValue(PsiParameterizedCachedValue.kt:17)
	at com.intellij.psi.util.CachedValuesManager.getParameterizedCachedValue(CachedValuesManager.java:97)
	at com.intellij.codeInsight.highlighting.HyperlinkAnnotator.getReferences(HyperlinkAnnotator.java:94)
	at com.intellij.codeInsight.highlighting.HyperlinkAnnotator.annotateContributedReferences(HyperlinkAnnotator.java:64)
	at com.intellij.codeInsight.highlighting.HyperlinkAnnotator.annotate(HyperlinkAnnotator.java:59)
	at com.intellij.codeInsight.daemon.impl.AnnotationHolderImpl.runAnnotatorWithContext(AnnotationHolderImpl.java:216)
	at com.intellij.codeInsight.daemon.impl.AnnotatorRunner.lambda$runAnnotator$3(AnnotatorRunner.java:139)
	at com.intellij.codeInsight.daemon.impl.AnnotationSessionImpl.computeWithSession(AnnotationSessionImpl.java:87)
	at com.intellij.codeInsight.daemon.impl.AnnotatorRunner.runAnnotator(AnnotatorRunner.java:129)
	at com.intellij.codeInsight.daemon.impl.AnnotatorRunner.lambda$runAnnotatorsAsync$0(AnnotatorRunner.java:66)
	at com.intellij.openapi.application.impl.AnyThreadWriteThreadingSupport.tryRunReadAction(AnyThreadWriteThreadingSupport.kt:279)
	at com.intellij.openapi.application.impl.ApplicationImpl.tryRunReadAction(ApplicationImpl.java:965)
	at com.intellij.codeInsight.daemon.impl.AnnotatorRunner.lambda$runAnnotatorsAsync$1(AnnotatorRunner.java:66)
	at com.intellij.concurrency.JobLauncherImpl$2MyProcessQueueTask.lambda$call$0(JobLauncherImpl.java:494)
	at com.intellij.openapi.progress.impl.CoreProgressManager.lambda$executeProcessUnderProgress$13(CoreProgressManager.java:660)
	at com.intellij.openapi.progress.impl.CoreProgressManager.computeUnderProgress(CoreProgressManager.java:684)
	at com.intellij.openapi.progress.impl.CoreProgressManager.executeProcessUnderProgress(CoreProgressManager.java:659)
	at com.intellij.openapi.progress.impl.ProgressManagerImpl.executeProcessUnderProgress(ProgressManagerImpl.java:79)
	at com.intellij.concurrency.JobLauncherImpl$2MyProcessQueueTask.call(JobLauncherImpl.java:483)
	at com.intellij.concurrency.JobLauncherImpl$2MyProcessQueueTask.call(JobLauncherImpl.java:471)
	at com.intellij.concurrency.JobLauncherImpl$2.compute(JobLauncherImpl.java:456)
	at java.base/java.util.concurrent.CountedCompleter.exec(CountedCompleter.java:759)
	at java.base/java.util.concurrent.ForkJoinTask.doExec$$$capture(ForkJoinTask.java:507)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java)
	at java.base/java.util.concurrent.ForkJoinTask.invoke(ForkJoinTask.java:676)
	at com.intellij.concurrency.JobLauncherImpl.procInOrderAsync(JobLauncherImpl.java:554)
	at com.intellij.codeInsight.daemon.impl.AnnotatorRunner.runAnnotatorsAsync(AnnotatorRunner.java:67)
	at com.intellij.codeInsight.daemon.impl.GeneralHighlightingPass.collectHighlights(GeneralHighlightingPass.java:231)
	at com.intellij.codeInsight.daemon.impl.GeneralHighlightingPass.lambda$collectInformationWithProgress$10(GeneralHighlightingPass.java:176)
	at com.intellij.codeInsight.daemon.impl.HighlightVisitorRunner.createHighlightVisitorsFor(HighlightVisitorRunner.java:84)
	at com.intellij.codeInsight.daemon.impl.GeneralHighlightingPass.collectInformationWithProgress(GeneralHighlightingPass.java:109)
	at com.intellij.codeInsight.daemon.impl.ProgressableTextEditorHighlightingPass.doCollectInformation(ProgressableTextEditorHighlightingPass.java:84)
	at com.intellij.codeHighlighting.TextEditorHighlightingPass.collectInformation(TextEditorHighlightingPass.java:57)
	at com.intellij.codeInsight.daemon.impl.PassExecutorService$ScheduledPass.lambda$doRun$2(PassExecutorService.java:418)
	at com.intellij.platform.diagnostic.telemetry.helpers.TraceKt.runWithSpanIgnoreThrows(trace.kt:118)
	at com.intellij.platform.diagnostic.telemetry.helpers.TraceUtil.runWithSpanThrows(TraceUtil.java:36)
	at com.intellij.codeInsight.daemon.impl.PassExecutorService$ScheduledPass.lambda$doRun$3(PassExecutorService.java:413)
	at com.intellij.openapi.application.impl.AnyThreadWriteThreadingSupport.tryRunReadAction(AnyThreadWriteThreadingSupport.kt:291)
	at com.intellij.openapi.application.impl.ApplicationImpl.tryRunReadAction(ApplicationImpl.java:965)
	at com.intellij.codeInsight.daemon.impl.PassExecutorService$ScheduledPass.lambda$doRun$4(PassExecutorService.java:404)
	at com.intellij.openapi.progress.impl.CoreProgressManager.lambda$executeProcessUnderProgress$13(CoreProgressManager.java:660)
	at com.intellij.openapi.progress.impl.CoreProgressManager.registerIndicatorAndRun(CoreProgressManager.java:735)
	at com.intellij.openapi.progress.impl.CoreProgressManager.computeUnderProgress(CoreProgressManager.java:691)
	at com.intellij.openapi.progress.impl.CoreProgressManager.executeProcessUnderProgress(CoreProgressManager.java:659)
	at com.intellij.openapi.progress.impl.ProgressManagerImpl.executeProcessUnderProgress(ProgressManagerImpl.java:79)
	at com.intellij.codeInsight.daemon.impl.PassExecutorService$ScheduledPass.doRun(PassExecutorService.java:403)
	at com.intellij.codeInsight.daemon.impl.PassExecutorService$ScheduledPass.lambda$run$0(PassExecutorService.java:379)
	at com.intellij.openapi.fileTypes.impl.FileTypeManagerImpl.cacheFileTypesInside(FileTypeManagerImpl.java:802)
	at com.intellij.codeInsight.daemon.impl.PassExecutorService$ScheduledPass.lambda$run$1(PassExecutorService.java:379)
	at com.intellij.openapi.application.impl.AnyThreadWriteThreadingSupport.executeByImpatientReader(AnyThreadWriteThreadingSupport.kt:486)
	at com.intellij.openapi.application.impl.ApplicationImpl.executeByImpatientReader(ApplicationImpl.java:179)
	at com.intellij.codeInsight.daemon.impl.PassExecutorService$ScheduledPass.run(PassExecutorService.java:377)
	at com.intellij.concurrency.JobLauncherImpl$VoidForkJoinTask$1.exec(JobLauncherImpl.java:190)
	at java.base/java.util.concurrent.ForkJoinTask.doExec$$$capture(ForkJoinTask.java:507)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1491)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:2073)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:2035)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:187)
```