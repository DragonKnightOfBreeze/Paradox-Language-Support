# 笔记：问题解决

## 前端相关

### VuePress docs:dev 启动失败（Vite 7 与 Node 版本不兼容，crypto.hash is not a function）

- **背景**
  - 使用 VuePress 2 搭建文档，`docs/package.json` 主要版本：
    - `vuepress@2.0.0-rc.25`
    - `@vuepress/bundler-vite@2.0.0-rc.25`
    - `vuepress-theme-hope@2.0.0-rc.94`
    - 一些官方插件为 `2.0.0-rc.112`
  - 先前为修复 `TemplateRendererOutlet` 导出错误，已将 VuePress 核心统一到 `rc.25`，并显式使用 `viteBundler()`。

- **现象**
  - 启动开发服务器：
    ```powershell
    pnpm.cmd run docs:dev
    ```
  - 报错（摘要）：
    ```text
    TypeError: crypto.hash is not a function
        at getHash (.../docs/node_modules/.pnpm/vite@7.1.3.../vite/dist/node/chunks/dep-*.js:2649:21)
    ```

- **排查过程**
  - 查看 Vite 产物 `dep-*.js`，`getHash()` 使用 `crypto.hash("sha256", ...)`，你的当前 Node 版本为 `v20.10.0`，并不提供该 API。
  - 查看 `vite@7.1.3` 的 `package.json`：
    - `"engines": { "node": "^20.19.0 || >=22.12.0" }`
    - 结论：需要 Node `>=20.19.0`（或 `>=22.12.0`）。
  - 查看 `@vuepress/bundler-vite@2.0.0-rc.25/package.json`：
    - 依赖 `"vite": "~7.1.3"`，意味着 Bundler 锁定 Vite 7，不宜简单降级 Vite。
  - 运行安装日志存在大量 peer dependency 警告（主题/插件多数声明 `vuepress@2.0.0-rc.24`），但不影响当前报错，属于兼容范围提示。

- **结论**
  - 根因：Node 版本过低（`v20.10.0`），不满足 `vite@7.1.3` 的 engines 要求，导致 `crypto.hash` 不存在，从而在 dev 启动阶段抛错。
  - 方向：升级 Node 到满足要求的版本（推荐 `>=22.12.0`，或至少 `20.19.0`）。

- **解决方案（Windows / nvm）**
  - 使用 nvm（已安装 `1.1.12`）升级并切换 Node：
    ```powershell
    nvm install 22.12.0
    nvm use 22.12.0
    node -v     # 确认版本 ≥ v22.12.0
    pnpm.cmd run docs:dev
    ```
  - 若需最低满足要求：
    ```powershell
    nvm install 20.19.0
    nvm use 20.19.0
    node -v
    pnpm.cmd run docs:dev
    ```

- **补充说明**
  - 目前的 peer 警告（如主题/插件期望 `vuepress@rc.24`，而项目为 `rc.25`）非致命，可暂时忽略；`@vuepress/utils@rc.25` 已包含 `TemplateRendererOutlet`，与主题期望一致。
  - 若后续遇到奇怪缓存，可清理（若存在）`docs/node_modules/.vite` 后重试。
  - 在 PowerShell 上建议使用 `pnpm.cmd` 以绕过执行策略限制。

- **经验教训 / Checklist**
  - 先根据堆栈定位到具体包与实现位置，判断是运行时 API 缺失还是导出不匹配。
  - 检查第三方包的 `engines` 字段与本地运行时（Node）是否匹配。
  - 核对 Bundler/框架是否锁定底层工具版本（例如 `@vuepress/bundler-vite` 锁定 Vite 7）。
  - Windows 终端下注意用 `pnpm.cmd`，避免被执行策略阻挡。

### nvm use 后 node -v 仍输出旧版本（NVM_SYMLINK 非符号链接导致）

- **现象**
  - 执行 `nvm use 22.12.0` 后，`node -v` 仍显示 `v20.10.0`。

- **诊断**
  - `where node` 输出：`D:\Program Files\nodejs\node.exe`。
  - `fsutil reparsepoint query "D:\\Program Files\\nodejs"`：返回“不是重解析点（not a reparse point）”。
  - 环境变量：
    - `NVM_HOME=C:\Users\29442\AppData\Roaming\nvm`（存在 `v22.12.0/` 目录）。
    - `NVM_SYMLINK=D:\Program Files\nodejs`。
    - PATH 同时包含 `C:\Users\29442\AppData\Roaming\nvm` 与 `D:\Program Files\nodejs`，Node 实际解析为后者。

- **根因**
  - `NVM_SYMLINK` 指向的 `D:\Program Files\nodejs` 是一个普通目录而非符号链接/联接目录，导致 nvm 无法通过切换目标来更新 `node.exe` 指向的版本。

- **修复方案（推荐）**
  1) 以管理员权限打开 PowerShell/CMD，关闭占用 Node 的进程（IDE 终端等）。
  2) 备份原目录：
     ```powershell
     ren "D:\Program Files\nodejs" nodejs.bak
     ```
  3) 让 nvm 重建符号链接/联接：
     ```powershell
     nvm use 22.12.0
     ```
  4) 校验：
     ```powershell
     fsutil reparsepoint query "D:\Program Files\nodejs"   # 现在应为重解析点
     where node                                              # 仍是 D:\Program Files\nodejs\node.exe
     node -v                                                 # 预期 v22.12.0
     ```

- **替代方案**
  - 如 nvm 仍无法创建链接，可手动建立目录联接（需管理员）：
    ```cmd
    mklink /J "D:\Program Files\nodejs" "C:\Users\29442\AppData\Roaming\nvm\v22.12.0"
    ```
  - 临时绕过（仅当前会话）：将目标版本目录临时置于 PATH 前缀：
    ```powershell
    $env:Path = "C:\Users\29442\AppData\Roaming\nvm\v22.12.0;" + $env:Path
    node -v
    ```

- **注意事项**
  - 第三方工具（npm/pnpm/yarn）在 `nodejs` 目录下的包装脚本可能被替换为新版本发行包自带的脚本，如需可重新安装或 `corepack enable`。
  - 若遇到“Access is denied”，请确认以管理员身份运行，并排除安全软件阻拦对 `D:\Program Files\nodejs` 的链接写入。

- **验证通过后**
  - 执行：
    ```powershell
    pnpm.cmd run docs:dev
    ```
    预期不再出现 `crypto.hash is not a function` 报错。

### Prism 自定义语法（SSR 扩展，避免 window.Prism 依赖）

- **背景**
  - 文档中的代码块需要自定义高亮：**CWT config file**、Paradox Script、Paradox Localisation、Paradox CSV。
  - VuePress 2 使用 `@vuepress/plugin-prismjs` 在 SSR 阶段完成高亮，不会在浏览器端暴露 `window.Prism`。
  - 结论：不能在 `client.ts` 中通过 `window.Prism` 注册语言，需在 SSR 阶段注册。

- **落地方案**
  - 将自定义 Prism 语言定义拆分为可复用的纯 JS 文件，放置于 `docs/.vuepress/highlighters/`：
    - `prism-cwt.js` → `registerCwt(Prism)`
    - `prism-paradox-script.js` → `registerParadoxScript(Prism)`
    - `prism-paradox-localisation.js` → `registerParadoxLocalisation(Prism)`
    - `prism-paradox-csv.js` → `registerParadoxCsv(Prism)`
    - 以上脚本均支持浏览器直引（检测 `window.Prism` 自动注册），也支持模块化调用。
  - 为每种语言创建 VuePress 插件（SSR 阶段注册语言），放置于 `docs/.vuepress/plugins/`：
    - `prism-cwt-plugin.ts`
    - `prism-paradox-script-plugin.ts`
    - `prism-paradox-localisation-plugin.ts`
    - `prism-paradox-csv-plugin.ts`
    - 插件在其 `extendsMarkdown()` 中执行 `register*(Prism)`，直接修改由 `prismjs` 导入的同一 Prism 实例。
  - 在 `docs/.vuepress/config.ts` 中：
    - **显式启用** `@vuepress/plugin-prismjs`。
    - 注册以上 4 个自定义插件。
  - 在 `docs/.vuepress/client.ts` 中：
    - **移除** 一切对 `window.Prism` 的访问和客户端注册逻辑，仅保留组件注册。

- **语言标识（Markdown 代码块围栏）**
  - 使用以下语言键与定义保持一致：
    - `cwt`
    - `paradox_script`
    - `paradox_localisation`
    - `paradox_csv`
  - 文档中已按以上键编写，匹配无误（`docs/zh/*.md`、`docs/en/*.md`）。

- **目录与关键文件**
  - 语言定义脚本：`docs/.vuepress/highlighters/prism-*.js`
  - VuePress 插件：`docs/.vuepress/plugins/*.ts`
  - 配置：`docs/.vuepress/config.ts`
  - 客户端配置：`docs/.vuepress/client.ts`

- **常见问题与排查**
  - **未生效/无高亮**：检查语言键是否拼写一致；确认插件已在 `config.ts` 的 `plugins` 中启用。
  - **构建时报错找不到语言**：确保在 SSR 插件中已调用相应 `register*(Prism)`；不要依赖 `window.Prism`。
  - **顺序问题**：SSR 渲染前，所有插件的 `extendsMarkdown()` 都会执行；保证已在注册阶段修改了 `Prism.languages`。

- **验证**
  - 执行：
    ```powershell
    pnpm.cmd run docs:build
    ```
  - 预期构建成功，生成页面中 `cwt`、`paradox_script`、`paradox_localisation`、`paradox_csv` 代码块具备高亮。
