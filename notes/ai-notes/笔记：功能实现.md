# 笔记：功能实现

## 前端相关（参考文档）

### VuePress 2 + PrismJS 自定义语言高亮

- **目录结构**：
  - `docs/.vuepress/highlighters/prism/` 自定义语言定义（JS）：如 `prism-cwt.js`、`prism-paradox-script.js` 等。
  - `docs/.vuepress/plugins/prism/` VuePress Prism 插件脚本（TS）：如 `prism-cwt-plugin.ts`。
- **服务端注册（SSR）**：
  - 在插件的 `extendsMarkdown()` 中调用 `registerXxx(Prism)`，确保 SSR 渲染时也能高亮。
  - 语言定义文件同时支持浏览器端自动注册（检测 `window.Prism`）。
- **Markdown 用法（代码块语言 ID）**：
  - `cwt` / `paradox_script` / `paradox_localisation` / `paradox_csv`
  - 示例：
    - ```cwt
      types = { ... }
      ```
    - ```paradox_script
      effect = { ... }
      ```
- **参考**：
  - https://github.com/PrismJS/prism
  - https://prismjs.com
  - https://prismjs.com/extending#language-definitions

### VuePress 2 + Shiki 自定义语言高亮

- **目录结构**：
  - `docs/.vuepress/highlighters/text-mate/` TextMate 语法（`*.tmLanguage.json`）。
  - `docs/.vuepress/highlighters/shiki/` 语言注册工厂（TS）：如 `shiki-paradox-script.ts`。
  - `docs/.vuepress/plugins/shiki/` VuePress Shiki 插件脚本（TS）：如 `shiki-paradox-script-plugin.ts`。
- **注册方式**：
  - 使用 `@vuepress/plugin-shiki`，通过 `langs: [() => shikiXxx()]` 按需注册自定义语言。
  - 语言工厂内部读取并返回 TextMate JSON，补充 `name`、`scopeName`、`aliases` 等字段。
- **重要约定（scopeName 对齐）**：
  - `paradox_script`: `scopeName = source.paradoxscript`
  - `paradox_localisation`: `scopeName = source.paradoxlocalisation`
  - `paradox_csv`: `scopeName = source.paradoxcsv`
  - `cwt`: `scopeName = source.cwt`
- **与 theme-hope 集成**：
  - 若主题已配置 Shiki，可将自定义 `langs` 合并；或额外添加一个 shikiPlugin（VuePress 2 支持多实例）。
- **Markdown 用法**：同 Prism，代码块语言 ID 一致。
- **常见问题**：
  - SSR 警告如 `skipToContent`、`routerLocales` 与主题本地化相关，可后续在主题配置中补齐，和 Shiki/Prism 无关。
  - 自定义语言未生效：优先检查 `scopeName` 是否与 TextMate 语法一致、`langs` 是否为 lazy 工厂函数。

### TextMate 语法与 Prism 规则的对齐

- **未加引号字符串**：在 TextMate 中补充了 `string.unquoted.*` 规则，避免与 `# = { } [] () ,` 等冲突。
- **布尔/运算符/标点**：补齐了 `yes/no`、算术运算符、括号/方括号/逗号等标记，匹配 Prism 行为。
- **本地化语言**：保留在引号内的颜色标记（`§X...§!`）、参数（`$name$`）、方括号命令（`[Get...]`）、文本格式与图标等规则。

### 参考链接

- **Shiki**：
  - https://github.com/shikijs/shiki
  - https://shiki.style/guide/load-lang#custom-languages
- **PrismJS**：
  - https://github.com/PrismJS/prism
  - https://prismjs.com
- **项目内参考**：
  - `docs/.vuepress/plugins/` 与 `docs/.vuepress/highlighters/` 目录
  - `docs/en/ref-syntax.md`、`docs/zh/ref-syntax.md`
