# 规范：代码风格

## `icu.windea.pls.config.configExpression`

> 本文总结 `icu.windea.pls.config.configExpression` 子包的代码风格与设计约定，作为后续持续维护与重构的依据。

### 目标与原则

- **API 稳定**：以接口为中心，对外暴露稳定 API；实现细节内聚在 `impl/` 包。
- **高容错**：解析失败优雅回退，保证功能可用性；必要信息通过 `UserData` 附加。
- **性能优先**：缓存 + 快速失败策略，降低重复解析的成本。

### 架构与命名

- **接口优先**：`CwtConfigExpression` 为基类；具体表达式：`CwtDataExpression`、`CwtTemplateExpression`、`CwtCardinalityExpression`、`CwtImageLocationExpression`、`CwtLocalisationLocationExpression`、`CwtSchemaExpression`。
- **Resolver 模式**：接口内嵌 `Resolver`，并由 `companion object : Resolver by XxxImpl()` 暴露静态入口。
- **实现内聚**：实现类与解析器位于 `impl/` 包，类可见性多用 `internal`/`private`。
- **命名约定**：`CwtXxxExpression[Impl]`、`CwtXxxExpressionResolverImpl`、内部解析函数 `doResolve*`。

### 标识与相等性

- **唯一标识**：所有表达式实现均含 `expressionString`，作为缓存键与相等性依据。
- **相等与哈希**：`equals/hashCode` 仅基于 `expressionString`；`toString()` 返回原始字符串。
- **解构友好**：必要处提供 `operator fun componentN()`（如 `CwtCardinalityExpression`）。

### 解析与缓存

- **多级解析**：
  - `CwtDataExpression` 同时支持 `resolve()`（键/值）、`resolveTemplate()`（模板）、`resolveBlock()`（块占位）。
  - `CwtTemplateExpression` 与 `CwtSchemaExpression` 分别聚焦各自语义域。
- **分场景缓存**：`CwtDataExpression` 为键/值/模板分别维护缓存（Guava `CacheBuilder`），`maximumSize(4096)` + `expireAfterAccess(10min)`。
- **快速失败**：空字符串直接返回空表达式；无规则匹配时回退为 `Constant` 并记录 `value`。
- **扩展点委托**：通过 `icu.windea.pls.ep.configExpression.CwtDataExpressionResolver` 等 EP 进行实际规则解析。

### 元数据与扩展

- **UserDataHolder**：表达式实现继承 `UserDataHolderBase`；扩展元数据通过 `KeyRegistry` + 委托属性实现：
  - `value: String?`（常量/回退值）
  - `intRange: TypedTuple2<Int?>?`、`floatRange: TypedTuple2<Float?>?`
  - `ignoreCase: Boolean?`
- **延迟求值**：如 `CwtImageLocationExpression.ResolveResult` 使用 `lazy` 获取 PSI 结果，避免无效解析。

### 模板与位置表达式要点

- **模板表达式（`CwtTemplateExpression`）**：
  - 不允许空白；仅当包含多个片段（常量 + 动态）时才算有效模板。
  - 采用“最左最早匹配”拆分动态片段（如 `value[...]` / `enum[...]` / `scope[...]` / `icon[...]` / `<definition>`）。
  - 暴露 `snippetExpressions` 与 `referenceExpressions`，便于后续引用解析、导航与高亮。
- **图片/本地化位置表达式**：
  - 统一 `location|args` 语法；`$` 参数表示“名称来源”，其余为“帧数来源”。
  - 结果使用 `ResolveResult` 封装，并提供懒解析的 PSI 访问。

### 文档注释与示例

- **KDoc 风格**：中英文注释并举，结构化小节：用途/语义/示例/约束/参见。
- **示例充足**：对典型规则给出一至两条最小示例，有助于 IDE 提示与使用者理解。

### 依赖与边界

- **尽量解耦**：解析层面不直接依赖具体 PSI；只有在 `ResolveResult` 等场景下提供可选的 PSI 访问。
- **工具依赖**：缓存使用 Guava；区间等基础类型统一走核心工具包（如 `TypedTuple2`）。

### 实践建议（供后续重构参考）

- **仅经由 Resolver 构造**：避免直接 new 实现类，统一走 `XxxExpression.resolve(...)`。
- **判空与回退优先**：入口尽早处理空串与非法输入，保证后续逻辑的前置条件。
- **扩展属性集中管理**：新增元数据时统一在 `_extensions.kt` 中定义键与注释。
- **缓存尺寸与时效可调**：如遇大型项目，可考虑通过配置项暴露缓存策略。
- **单元测试建议**：对边界输入（空/空白/非法字符/不匹配规则）与典型组合（混合片段、多参数）各给出用例。
