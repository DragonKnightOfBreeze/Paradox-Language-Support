# 模组依赖域（Dependency）命名与包结构提案（Root/Set/Loadout 架构）

> 目的：在不立即实现高级功能的前提下，为“模组依赖”从单组列表演进为多组集合与运行集提供清晰的领域术语、命名与包结构；确保与 IntelliJ 插件开发语境（Service/State/Storage）契合，并与现有模型 `ParadoxRootInfo` 保持一致。

## 背景与约束

- **现状**
  - `ParadoxModDependencySettingsState`（`src/main/kotlin/icu/windea/pls/lang/settings/PlsProfilesSettings.kt`）仅表达“单条依赖项”，并被 `ParadoxGameOrModSettingsState.modDependencies: MutableList<...>` 组合成“单组依赖列表”。
  - `ParadoxModDescriptorInfo`（`src/main/kotlin/icu/windea/pls/model/ParadoxModDescriptorInfo.kt`）不包含依赖字段；`ParadoxModMetadataInfo.Relationship` 表达了来自外部源（如 Steam）的依赖关系，但未纳入“可多组管理”的用户域模型。
  - 相关 UI 如 `ParadoxModDependenciesTable*` 已面向“单组列表”交互。
- **目标**
  - Game/Mod（统一称为 Root）均可维护多组“依赖集合”（Dependency Set）。
  - 支持面向运行/检查的“运行集”（Loadout：集合 + 顺序 + 启用状态）。
  - 预留启动游戏、冲突检测、导入导出等高级功能的扩展点。
- **不做事项（当前阶段）**
  - 不编写具体功能实现与 UI 大改；仅完成命名/结构与存储层铺垫。

## 领域术语与界定

- **Root**：Game/Mod 的统一上层抽象（对应 `ParadoxRootInfo`）。
- **Dependency Entry**：单条模组依赖项（指向某个 Mod Root）。
- **Dependency Set**：一组依赖项的定义（无强制顺序语义，用于组织与复用）。
- **Loadout**：面向运行/检查的一次性“方案”，包含依赖项的加载顺序与启用状态（可由某个 Set 派生）。

建议对外（玩家语境）可使用“播放集/方案（Playset/Loadout）”，对内代码保持 **Dependency Set / Loadout** 中性命名。

## 命名方案（类型与字段）

- **条目级**
  - `ParadoxModDependencySettingsState` → `ParadoxDependencyEntryState`
    - 字段建议：
      - `modDirectory: String`（必需）
      - `enabled: Boolean = true`
      - `required: Boolean = false`（可选，表达“强依赖”）
      - `versionConstraint: String? = null`（可选，如 `>= 3.12`）
      - `notes: String? = null`
- **集合级**
  - 新增 `ParadoxDependencySetState`
    - `id: String`（UUID）
    - `name: String`
    - `ownerRootPath: String`（所属 Root 的路径）
    - `entries: MutableList<ParadoxDependencyEntryState>`
    - `createdAt: Long`、`updatedAt: Long`
- **运行级**
  - 新增 `ParadoxLoadoutState`
    - `id: String`、`name: String`、`ownerRootPath: String`
    - `entries: MutableList<ParadoxLoadoutEntryState>`
    - `createdAt: Long`、`updatedAt: Long`
  - 新增 `ParadoxLoadoutEntryState`
    - `modDirectory: String`
    - `enabled: Boolean`
    - `order: Int`（加载顺序）
- **Root 级配置**（替换“单组依赖列表”）
  - `ParadoxGameOrModSettingsState`：
    - 移除/淡化 `modDependencies`（保留兼容期）
    - 新增 `selectedDependencySetId: String?`
    - 新增 `selectedLoadoutId: String?`

## 包结构建议（领域聚合与分层）

```
icu.windea.pls.profiles/                 # 或 icu.windea.pls.roots/
  dependency/
    state/                               # 可序列化的数据对象
      ParadoxDependencyEntryState.kt
      ParadoxDependencySetState.kt
      ParadoxLoadoutState.kt
      ParadoxLoadoutEntryState.kt
    service/                             # 应用服务（不做重后端化）
      RootDependenciesService.kt         # 统一管理 Set/Loadout
    storage/                             # 存储抽象与实现
      DbBackedStateMap.kt                # 或重命名 DbStateMap
      codec/StateXmlCodec.kt
      sqlite/ProfilesDatabase.kt         # 或 ProfilesSqliteStorage
    importer/                            # 导入/导出（后续）
      DependencySetImporter.kt
      LoadoutImporter.kt
      ParadoxLauncherJsonV3Importer.kt   # 迁移至此
      ParadoxDlcLoadImporter.kt          # 迁移至此
    resolver/                            # 预留：解析/冲突/顺序
      DependencyGraphBuilder.kt
      LoadOrderResolver.kt
      ConflictDetector.kt
    ui/                                  # 预留：新 UI 容器
      DependencySetsPanel.kt             # 集合管理
      LoadoutEditor.kt                   # 顺序与启用
```

> 现有 UI `ParadoxModDependenciesTable*` 可先迁移至 `profiles/dependency/ui/` 并作为集合/运行集的明细子视图复用。

## 存储与键设计（SQLite + XmlStateCodec）

- 继续沿用 `DbBackedStateMap` + `ProfilesDatabase`，新增类别（category）：
  - `dependencySets`：key = `"$ownerRootPath/$setId"`
  - `loadouts`：key = `"$ownerRootPath/$loadoutId"`
  - `rootSelections`：key = `"$ownerRootPath"`，value = `{ selectedDependencySetId, selectedLoadoutId }`
- 将类别集中到常量/枚举（如 `ProfilesCategory`），避免硬编码字符串散落。
- 现有四张表（game/mod descriptor/settings）保持不变；新类别可共用同一结构（`key_path`, `value_xml`, `updated_at`）。

## 服务与 API 草案

- `RootDependenciesService`（Application Service）
  - Set：
    - `listDependencySets(ownerRootPath: String): List<ParadoxDependencySetState>`
    - `getDependencySet(ownerRootPath: String, id: String): ParadoxDependencySetState?`
    - `saveDependencySet(set: ParadoxDependencySetState)`
    - `deleteDependencySet(ownerRootPath: String, id: String)`
  - Loadout：
    - `listLoadouts(ownerRootPath: String): List<ParadoxLoadoutState>`
    - `saveLoadout(loadout: ParadoxLoadoutState)`
    - `deleteLoadout(ownerRootPath: String, id: String)`
    - `deriveLoadoutFromSet(setId: String): ParadoxLoadoutState`（从 Set 生成 Loadout）
  - Selection：
    - `getSelection(ownerRootPath: String): RootSelection?`
    - `saveSelection(ownerRootPath: String, selection: RootSelection)`
- `PlsFacade` 增加薄封装（保留旧方法 `@Deprecated` 过渡）。

## 与现有搜索域/工具的联动

- `ParadoxGameWithDependenciesSearchScope`（`src/main/kotlin/icu/windea/pls/lang/search/scope/...`）未来可从：
  - `selectedLoadoutId` → `Loadout` → `dependencyDirectories`
  - 无 `Loadout` 时回退到 `selectedDependencySetId`（按输入顺序或名称排序）

## 迁移与演进路线（不破坏行为）

- **阶段 A：铺垫与包迁移（低风险）**
  - 新建 `profiles/dependency/state|service|storage|importer|ui` 结构。
  - 移动 `DbBackedStateMap`、`ProfilesDatabase`（及 `XmlStateCodec`）到 `profiles/dependency/storage/`（仅移动不改名）。
  - 将 `ParadoxModDependenciesTable*` 迁移到 `profiles/dependency/ui/`。
- **阶段 B：引入 Set（中风险，可同时兼容旧字段）**
  - 新增 `ParadoxDependencySetState` 与 `dependencySets` 类别；提供 CRUD API。
  - `ParadoxGameOrModSettingsState` 新增 `selectedDependencySetId`；旧字段 `modDependencies` 暂保留（双写或读时桥接）。
- **阶段 C：引入 Loadout（中风险）**
  - 新增 `ParadoxLoadoutState` 与 `loadouts` 类别；支持从 Set 派生。
  - `ParadoxGameOrModSettingsState` 新增 `selectedLoadoutId`；SearchScope、检查等读取 Loadout。
- **阶段 D：命名收敛（可选）**
  - 重命名 `ParadoxModDependencySettingsState` → `ParadoxDependencyEntryState`。
  - 清理 `modDependencies`，只保留 Selection。

## 兼容性策略

- Facade 层保留旧 API 并标注 `@Deprecated`，内部桥接到新服务。
- DB 类别字符串通过集中映射保留兼容（如读取旧 key 后写回新 key）。
- UI 渐进式：先提供“集合选择器”，后引入 Loadout 编辑器；原表格继续复用。

## 与 IntelliJ 插件语境的契合

- `Service`（应用服务） + `State`（序列化对象） + `Storage`（SQLite + XML）的轻量分层，避免 Repository/DAO 等过重后端模式。
- App 级 Service 管理跨项目数据；若未来需要项目级隔离，可引入 `@Service(Level.PROJECT)` 的代理层。

## 面向未来的扩展点（仅架构预留）

- **启动游戏**：`LoadoutLauncher`（由 `LoadOrderResolver` 产出顺序与启用集 → 启动参数/配置）。
- **冲突检测**：`ConflictDetector`（基于 Loadout 的覆盖关系/定义冲突图）。
- **导入导出**：`DependencySetImporter/Exporter`、`LoadoutImporter/Exporter`（统一 EP，聚合 `ParadoxLauncherJsonV3Importer` 等实现）。
- **校验**：`DependencyValidator`（缺失依赖、版本约束、循环依赖）。

## 附：参考代码位置

- `ParadoxModDependencySettingsState`：`src/main/kotlin/icu/windea/pls/lang/settings/PlsProfilesSettings.kt`
- `ParadoxModDependenciesTable*`：`src/main/kotlin/icu/windea/pls/lang/ui/tools/`
- `ParadoxGameWithDependenciesSearchScope`：`src/main/kotlin/icu/windea/pls/lang/search/scope/ParadoxGameWithDependenciesSearchScope.kt`
- `ParadoxModDescriptorInfo`：`src/main/kotlin/icu/windea/pls/model/ParadoxModDescriptorInfo.kt`
- `ParadoxModMetadataInfo`：`src/main/kotlin/icu/windea/pls/model/ParadoxModMetadataInfo.kt`

---

如接受本提案，我可先提交“阶段 A”的包迁移 PR（不改行为与命名），随后按阶段推进 Set/Loadout 的引入与旧字段的兼容迁移。
