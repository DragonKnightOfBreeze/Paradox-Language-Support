# 性能优化笔记

## 索引时的性能

> 以下统计数据是对Stellaris游戏目录进行一次完整的索引之后的统计数据

索引耗时：

* `icu.windea.pls.core.index.hierarchy.ParadoxValueSetValueFastIndex.indexData(PsiFile, Map)` 53s
  * `icu.windea.pls.lang.ParadoxValueSetValueHandler.getInfos(ParadoxScriptStringExpressionElement)` 50.156s 95.3%
    * `icu.windea.pls.lang.ParadoxConfigHandler.getConfigContext(PsiElement)` 23.213s
      * `icu.windea.pls.lang.ParadoxDefinitionHandler.getInfo(ParadoxScriptDefinitionElement)` 12.115s
    * `icu.windea.pls.lang.model.ParadoxConfigContext.getConfigs(int)` 16.799s
      * `icu.windea.pls.lang.ParadoxConfigMatcher.matches(PsiElement, ParadoxDataExpression, CwtDataExpression, CwtConfig, CwtConfigGroup, int)` 3.972s
* `icu.windea.pls.core.index.hierarchy.ParadoxComplexEnumValueIndex.indexData(PsiFile, Map)` 12s
* `icu.windea.pls.core.index.hierarchy.ParadoxDefinitionHierarchyIndex.indexData(PsiFile, Map)` 5s
* `icu.windea.pls.core.index.hierarchy.ParadoxInlineScriptUsageIndex.indexData(PsiFile, Map)` 2s

内存使用：

* 总计：650M
* 保留的内存：
  * `icu.windea.pls.script.psi.impl.ParadoxScriptPropertyImpl` 30472 227.88M
  * `icu.windea.pls.lang.cwt.config.CwtPropertyConfigImpls$ImplB` 81877 192.44M
  * `icu.windea.pls.lang.cwt.CwtConfigGroupImpl` 9 151.57M
  * `icu.windea.pls.lang.cwt.config.CwtDeclarationConfig` 11,121 130.01M - 相关缓存应当使用softValues
  * `icu.windea.pls.lang.cwt.config.CwtDeclarationConfigContext` 162 110.76M
* 关键点：
  * `icu.windea.pls.lang.cwt.config.CwtDeclarationConfigContext.contextElementPointer` - 这个pointer可能会被保存作为很多propertyConfig的userData

## 代码检查时的性能

> 以下堆栈的执行时间是启用所有代码检查的情况下对Stellaris的common目录进行一次完整的代码检查后的执行时间

自1.1.0开始：

* `icu.windea.pls.script.psi.ParadoxScriptParser.parse(IElementType, PsiBuilder)` 142s - 文件解析耗时，目前仅作记录
* `icu.windea.pls.localisation.psi.ParadoxLocalisationParser.parse(IElementType, PsiBuilder)` 104s - 文件解析耗时，目前仅作记录
* `icu.windea.pls.script.inspections.general.UnusedParameterInspection$buildVisitor$1.visitElement(PsiElement)` 342s - 考虑减少实际需要查找引用的次数，或者不使用引用查找？
* `icu.windea.pls.localisation.references.ParadoxLocalisationPropertyPsiReference.multiResolve(int)` 191s
  * `icu.windea.pls.lang.parameter.ParadoxLocalisationParameterSupport$INSTANCE.resolveParameter(ParadoxLocalisationPropertyReference)` 185s
    * `icu.windea.pls.lang.ParadoxDefinitionHierarchyHandler.processQuery(Project, String, ParadoxGameType, GlobalSearchScope, Function2)` 185s
      * `icu.windea.pls.lang.ParadoxDefinitionHierarchyHandler$$Lambda$4695.0x000000080254b8f8.process(Object)` 146s
        * `icu.windea.pls.core.index.ParadoxDefinitionHierarchyIndexKt.readDefinitionHierarchyInfos(DataInput)` 77s
          * `com.intellij.openapi.util.ThreadLocalCachedValue.getValue()` 9.6s
      * `java.util.Spliterators$1Adapter.hasNext()` 36s
        * `icu.windea.pls.core.search.scope.ParadoxGameWithDependenciesSearchScope.contains(VirtualFile)` 7.7s
          * `icu.windea.pls.lang.ParadoxFileHandler.canReference(VirtualFile, VirtualFile)` 6.9s
        * `com.intellij.openapi.fileTypes.impl.FileTypeManagerImpl.isFileOfType(VirtualFile, FileType)` 6.8s
* `icu.windea.pls.lang.ParadoxConfigHandler.getConfigs(PsiElement, boolean, int)` 94s
  * `icu.windea.pls.lang.model.ParadoxDefinitionInfo.doGetDeclaration(int)` 5.4s
    * `icu.windea.pls.lang.cwt.config.CwtDeclarationConfigContext.<init>(PsiElement, String, String, List, CwtConfigGroup, int)` 4.2s
  * `icu.windea.pls.lang.ParadoxDefinitionHandler.doMatchDefinition(ParadoxScriptDefinitionElement, CwtPropertyConfig, CwtConfigGroup, int)` 11.7s
    * `icu.windea.pls.script.psi.impl.ParadoxScriptPropertyImpl.getBlock()` 11.6s - 除非使用LighterAST，否则难以避免，而使用LighterAST实现又太过麻烦
* `icu.windea.pls.lang.model.ParadoxConfigContext.getConfigs(int)` 35s
  * `icu.windea.pls.lang.ParadoxConfigHandler.getConfigsFromConfigContext(ParadoxScriptMemberElement, List, ParadoxElementPath, CwtConfigGroup, int)` 25s
* `icu.windea.pls.lang.ParadoxDefinitionHandler.getInfo(ParadoxScriptDefinitionElement)` 11.2s
  * `icu.windea.pls.lang.ParadoxDefinitionHandler.doGetInfo(ParadoxScriptDefinitionElement, PsiFile)` 7.8s
    * `icu.windea.pls.lang.ParadoxDefinitionHandler.getMatchedTypeConfig(ParadoxScriptDefinitionElement, ParadoxPath, ParadoxElementPath, String, CwtConfigGroup)` 5.6s
