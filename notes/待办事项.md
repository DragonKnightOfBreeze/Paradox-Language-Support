# TODO

## 待办事项

* [ ] 有些地方获取的作用域是可能的（`from = country?`）
* [ ] 确认重命名功能能够预期正确进行（如果对应的声明/引用支持重命名）
* [ ] 基于引用的重命名需要考虑存在前后缀的情况（主要是为图标引用考虑）
* [ ] ~~一些检查可以基于当前文件、文件路径（相对于游戏或模组根目录）、定义类型（例如，`event`）、定义成员路径（例如，`event.abc`）等来部分禁用~~（已经没有必要）
* [ ] 可扩展的对本地化命令、本地化命令作用域的支持（包括引用解析、作用域获取、代码补全等）
* [ ] ~~兼容CWT规则文件中的错误级别`severity = warning`或`## severity = warning`~~（PLS和CWTools实现有所不同，需要分析）
* [ ] CWT规则文件中有些之前被认为必定是常量字符串的地方（如枚举值的名字），也可能是一个表达式而非仅仅是常量字符串
* [ ] （待确定）作为trigger的值的CWT规则`scope_field` `scope[xxx]` `scope_group[xxx]`也可以匹配一个布尔值？
* [X] 基于使用处推断一些定义（如`scripted_effect`）的作用域上下文
* [ ] 基于使用处推断本地化命令的作用域上下文
* [ ] ~~可以通过特殊注释强制指定定义类型（基于文件路径或者基于直接的类型+子类型） - 用于实现差异比较等功能~~（不考虑）
* [X] 新增操作：从指定的本地化文件生成其他语言区域的本地化文件（右键菜单&项目视图&工具栏操作，考虑支持指定多个或者整个目录的情况）
* [ ] 新增操作：从封装变量/定义/本地化/文件进行重载（通过对话框选择生成的位置）
* [ ] （待确定）实现对`*.gui`文件中的GUI定义的UI预览（参考IDEA的Markdown插件的实现）
* [ ] （待确定）实现对`*.txt`文件中的定义的UI预览（参考游戏中的效果以及灰机Wiki的实现）
* [ ] （低优先级）对于封装变量、定义、本地化和内联脚本实现安全删除功能
* [ ] （低优先级）对于封装变量、scripted_trigger、scripted_effect、inline_script等实现内联功能
* [ ] #46 优化：尝试基于使用推断特定类型的`valueSetValue`对应的作用域上下文（如`event_target`和`global_event_target`）
* [X] 提供一种项目视图，用于显示合并后的所有用于自定义规则分组的CWT文件（`Project Pane > CWT Config Files`）
* [X] 兼容直接在键或字符串中使用参数条件块（`foo_[[bar]bar]_desc`） - 兼容语法以及相关功能
* [X] 完善对定义的作用域上下文推断的支持 - 完善实现逻辑，优化性能，支持`scripted_trigger`、`scripted_effect`和`event`
* [ ] DDS文件路径以及符合条件的快速文档链接也能作为html/markdown等文件中的图片超链接使用，从而渲染DDS图片和本地化
* [ ] ~~改为基于语言注入功能（`Language Injection`）支持脚本文件中的各种复杂表达式以及本地化文件中的本地化命令表达式~~
* [X] 将获取作用域上下文的代码提取成扩展点
* [ ] 对任何带有作用域上下文的声明或引用（包括CWT规则的引用），统一提示作用域上下文
* [X] 参照Irony Mod Manager的实现，实现扩展点以在查询时，如果有必要，按照覆盖顺序排序封装变量/定义/本地化
* [ ] 添加代码检查，基于下列规则检查脚本文件中是否存在可能的BUG
  * [X] ~~scripted_trigger/scripted_effect不能递归调用~~（已实现对应的代码检查）
  * [X] scripted_trigger/scripted_effect的调用层数最大只能有5层
  * [X] ~~内联数学表达式（inline_math）在每个scripted_trigger/scripted_effect中最多只能使用1次~~（当前游戏版本已无此限制）
  * [ ] 对于valueSetValue，只能通过后缀的`@xxx`切换flag和event_target的作用域
  * [X] ~~不能在asset文件中使用scripted_variable和inline_math~~（已实现对应的代码检查）
* [X] 在更多情况下尝试推断脚本参数对应的CWT规则，从而提供各种高级语言功能（如，基于CWT规则的代码高亮、引用解析和代码补全）
* [ ] 支持语法`$ARG1|ARG2$`（在3.10.0的更新日志中被提及，但是太过神秘，暂不考虑兼容）

## 待办事项 - 追踪中

* [ ] 尝试优化插件性能
* [ ] 提供关于插件使用的CWT规则文件的基本语法和编写规范的参考文档
* [ ] 新功能：冲突检测 & 代码合并（初步支持）
* [ ] 优化：支持模组本地的规则分组
* [ ] 优化：导入规则分组后，尝试优化为仅需重新解析和重新索引必要的文件
* [ ] 优化：为Stellaris提供较为完善的适用于`define`的CWT规则文件
* [ ] 优化：基于覆盖顺序对本地化进行排序时，位于目录`replace`中的同名本地化应当拥有更高的优先级（尽管目前没有相关的代码检查）
* [ ] 优化：对于`K = V`中的`K`，进行代码补全时，也需要先匹配其中的`V`
* [ ] BUG修复：修复通过扩展的规则文件推断作为整个表达式的参数的规则上下文的场合，如果与表达式所在位置的规则上下文不匹配，相关的代码检查不生效的问题
* [ ] BUG修复：修复通过扩展的规则文件推断内联脚本参数中的内联脚本参数中的规则上下文的场合，相关功能可能不生效的问题（如代码补全）
  * 搁置 - IDEA不支持嵌套的语言注入
* [ ] #60 BUG修复：兼容用引号括起的参数值中的那些用转义后的引号括起的字面量，正常进行规则匹配（例如，`p = "\"v\""`中的的`\"v\"`）
  * 搁置 - IDEA自身BUG或者IDEA设计如此
  * 参见：`com.intellij.psi.impl.source.tree.injected.DocumentWindowImpl.calcText`
* [ ] #81 扩展CWT规则：允许引用指定路径的已存在的规则
* [ ] （待定）扩展CWT规则：支持通过扩展的选项指定规则的子规则的继承关系（基于`## inherit_configs`，初步支持，忽略选项不合法的情况）
* [ ] （待定）扩展CWT规则：支持通过扩展的选项指定规则的选项的继承关系（基于`## inherit_options`，初步支持，忽略选项不合法的情况）
* [ ] （待定）扩展CWT规则：支持通过扩展的选项指定规则的文档注释的继承关系（基于`## inherit_doc`，初步支持，忽略选项不合法的情况）
* [X] 扩展CWT规则：优化定义规则与复杂枚举规则的路径匹配的逻辑（基于`path`字段的值，可以是一个ANT路径表达式，可以有多个）
* [ ] 进行规则文件的代码补全时，也提示各种数据表达式
* [ ] 进行规则文件的代码补全时，也提示各种选项

## 待办事项 - 规则文件

* CK2 - 搁置
* CK3 - 搁置
* EU4 - 搁置
* HOI4 - 搁置
* IR - 搁置
* Stellaris - 3.12.2
  * [X] 基于日志文件的规则
  * [X] 基于游戏文件的规则
  * [X] 检查官方更新日志
  * [X] 检查作用域
* VIC2 - 搁置
* VIC3 - 搁置