# 功能实现笔记

## 语言支持

### CWT规则文件

### 脚本语言

### 本地化语言

对于本地化语言中引用的命令（`[Root.GetName]`）

* 可以对应内置命令（详见：`Stellaris\logs\script_documentation\localizations.log`）
* 可以对应类型为`scripted_loc`的定义（引用方式：`SCOPE.NAME`，`SCOPE`是作用域名称，`NAME`是定义的名字）
* 重复的左方括号可以进行转义（`[[Text]`，这会被渲染为`[Text]`）

对于本地化语言中引用的图标（`£energy£`）：

* 前后缀必须要匹配，否则会显示为问号图标（原版游戏文件中有许多这样的解析错误）
* 可以对应内置图标
* 可以对应同名的`gfx/interface/icons`下的dds文件（引用方式：`£NAME£`，`NAME`是不包括文件后缀名的文件名）
* 可以对应名为`GFX_text_NAME`，类型为`sprite_type`的定义（引用方式：`£NAME£`，`NAME`是图标的名字）

注意事项：

* `localisation_synced`中不能通过`$KEY$`的方式引用`localisation`

[Localisation modding](https://stellaris.paradoxwikis.com/Localisation_modding)

有用的命令：

```
reload text - 重载本地化文本表
switchlanguage $language - 切换使用的语言并且重载本地化文本表（$language为语言名，如：l_english）
```

### 覆盖规则

对于定义（definition）：

* 相对路径相同的文件中的同一定义，按照加载顺序，后加载的会覆盖先加载的
* 相对路径不同的文件中的同一定义，按照文件名的字母排序顺序，UTF8编码大的会覆盖UTF编码小的（一般来说，中文文件名拥有更高的优先级）

对于本地化文本（localisation）：

* 相对路径相同的文件中的同一本地化文本，按照加载顺序，后加载的会覆盖先加载的
* 相对路径不同的文件中的同一本地化文本，按照文件名的字母排序顺序，UTF8编码大的会覆盖UTF编码小的（一般来说，中文文件名拥有更高的优先级）
* 位于`localisation/replace`目录中的文本化文本，相对于位于`localisation`目录中的本地化文本，拥有更高的优先级
* 相对于`localisation/replace`目录或`localisation`的父路径相同才能进行覆盖（文件名可以不同）

相对路径：相对于游戏根目录或模组根目录的路径，包括文件名

注意：以上规则不准确，存在一些先序覆盖的情况，需要确认

## 代码补全

### 脚本文件

* 基于cwt规则文件

### 本地化文件

* 键入locale时，提示locale
* 键入commandField时，提示类型为`scripted_loc`的`definition`，以及由cwt规则文件定义的`localisation_command`（TODO 匹配scope）

## 代码检验

### 脚本文件

* 基于CWT规则文件

### 本地化文件

* 验证locale是否支持，始终提供intention：更改locale
* 验证serialNumber是否支持，始终提供intention：更改serialNumber
* 验证color是否支持，始终提供intention：更改color

## 应用规则文件

### 应用内置的规则文件

* 解析插件内置的规则文件（`config/internal`目录中的配置文件），用于获取全局声明数据（如：本地化语言区域、本地化颜色）

### 应用CWT规则文件

* 解析cwt规则文件（`*.cwt`），用于验证脚本文件
* 日志文件、表格文件等（`*.log` `*.csv`），需要先转换为cwt规则文件后，再进行解析

特殊处理：

* stellaris：`alias_name[modifier]`除了匹配`<static_modifier>`，还匹配从日志文件中解析得到的`modifierDefinitions`

### 应用扩展的CWT规则文件

插件补充的CWT规则文件。提供缺失的规则和额外的规则。

```cwt
types = {
  type[some_type] = {
    # ...
    localisation = {
      # TODO key可以重名
      # TODO 按优先级排序（从上往下优先级降低）
      loc2 = "#desc" # TODO 对应此定义的名为"desc"的属性的值，所对应的本地化
      loc1 = "$_desc" # "$"是定义名称的占位符，对应名为"${definitionName}_desc"的本地化
    }
    pictures = {
      # TODO key可以重名
      # TODO 按优先级排序（从上往下优先级降低）
      # primary # 当其他定义需要基于另一个定义得到对应的DDS图片，而另一个定义有多种对应的DDS图片时，使用此DDS图片
      pic1 = "#icon" # TODO 对应此定义的名为"icon"的属性的值，所对应的DDS图片（基于值的类型）
      pic2 = "#icon|#icon_frame,#frame" # TODO icon_frame，对应此定义的名为"icon_frame"的属性的值，用于对DDS图片进行分割，获取最终需要的DDS图片
      pic3 = "gfx/interfaces/icons/$.dds" # TODO "$"是定义名称的占位符，对应相对于游戏或模组目录，其所对应的DDS图片
      # pic4 = "#" # 如果此定义的值是字符串，则直接基于此定义的值，查找对应的DDS图片
    }
    # ...
  }
}
```

## 其他

### 渲染dds图片

转换dds文件为png文件，然后渲染到文档注释中。

#### 方案1

使用`dds2png`工具（小巧，但是生成需要一定时间，并且生成的PNG文件可能存在错误）

* 在插件的jar的顶级目录下放入一个压缩包`dds2png.zip`，这是一个用于将dds转化为png的小工具
* 定义一个工具类`DdsToPngConverter`
* 第一次使用到这个类时：
  * 确定用户目录（linux是`~`，windows是`C://Users/xxx`，需要确定获取方式）
  * 确定用户目录下存在文件`dds2png/dds2png.exe`，不存在的情况下，将jar包中的`dds2png`解压到用户目录
  * 如果后续执行转化命令时没有转化成功，也进行上述操作
* 需要渲染dds文件时：
  * 确定dds文件的`paradoxPath`，得到对应的png文件的`paradoxPath`，如果`~/dds2png/tmp`目录中存在对应的png文件，则直接使用
  * 如果没有，则需要确定dds文件的绝对路径
  * 执行转化命令：`~/dds2png/dds2png.exe -y <dds_name> <png_name>`
  * png文件保存在`~/dds2png/tmp`这个目录中 
* 未知图标（`unknown.png`，44x44）需要保存到`~/dds2png/tmp`的顶级目录下，以便必要时直接使用

```
spriteType = {
    name = "GFX_text_army_ship"
    texturefile = "gfx/interface/icons/text_icons/text_icon_military_transport.dds"
}
```

#### 方案2（选用）

使用`DDS4J`（高效，但仍然不兼容某些dds图片）

[vincentzhang96/DDS4J: Java library for reading and decoding DDS files to raw ARGB and PNG](https://github.com/vincentzhang96/DDS4J)

* 根据图标名解析：基于形如`£unity£`的本地化文本中的图标的名字，查找对应的名称为`GFX_text_${iconName}`、类型为`sprite`或`spriteType`的定义，然后得到名为`textureFile`的属性的值，将其作为相对于游戏或模组目录的路径，得到对应的DDS文件路径。如果无法获取，则查找文件名为`${iconName}.dds`（大小写敏感），位于游戏或模组目录中（或者其子目录中）的DDS文件，得到对应的DDS文件路径。
* 根据类型为`sprite`的定义解析：得到名为`textureFile`（不区分大小写）的属性的值，将其作为相对于游戏或模组目录的路径，得到对应的DDS文件路径。
* 根据文件名为`${iconName}.dds`（不区分大小写），位于游戏或模组目录中（或者其子目录中）的DDS文件解析：得到对应的DDS文件路径。
* 得到DDS文件路径后，将其转化为PNG文件，然后保存到`~/.pls/images`目录中（或者其子目录中，如果存在相对于游戏或模组目录的父路径的话）。
* 渲染图标时2，使用PNG文件的绝对路径。