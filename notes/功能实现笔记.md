# 功能实现

## 语言支持

### CWT规则文件

### 脚本语言

### 本地化语言

对于本地化语言中引用的命令（`[Root.GetName]`）

* 可以对应内置命令（详见：`Stellaris\logs\script_documentation\localizations.log`）
* 可以对应类型为`scripted_loc`的定义（引用方式：`SCOPE.NAME`，`SCOPE`是作用域名称，`NAME`是定义的名字）
* 重复的左方括号可以进行转义（`[[Text]`，这会被渲染为`[Text]`）

对于本地化语言中引用的图标（`£energy£`）：

* 前后缀必须要匹配，否则会显示为问号图标（原版游戏文件中有许多这样的解析错误）
* 可以对应内置图标
* 可以对应同名的`gfx/interface/icons`下的dds文件（引用方式：`£NAME£`，`NAME`是不包括文件后缀名的文件名）
* 可以对应名为`GFX_text_NAME`，类型为`sprite_type`的定义（引用方式：`£NAME£`，`NAME`是图标的名字）

注意事项：

* `localisation_synced`中不能通过`$KEY$`的方式引用`localisation`

[Localisation modding](https://stellaris.paradoxwikis.com/Localisation_modding)

有用的命令：

```
reload text - 重载本地化文本表
switchlanguage $language - 切换使用的语言并且重载本地化文本表（$language为语言名，如：l_english）
```

### 覆盖规则

对于定义（definition）：

* 相对路径相同的文件中的同一定义，按照加载顺序，后加载的会覆盖先加载的
* 相对路径不同的文件中的同一定义，按照文件名的字母排序顺序，UTF8编码大的会覆盖UTF编码小的（一般来说，中文文件名拥有更高的优先级）

对于本地化文本（localisation）：

* 相对路径相同的文件中的同一本地化文本，按照加载顺序，后加载的会覆盖先加载的
* 相对路径不同的文件中的同一本地化文本，按照文件名的字母排序顺序，UTF8编码大的会覆盖UTF编码小的（一般来说，中文文件名拥有更高的优先级）
* 位于`localisation/replace`目录中的文本化文本，相对于位于`localisation`目录中的本地化文本，拥有更高的优先级
* 相对于`localisation/replace`目录或`localisation`的父路径相同才能进行覆盖（文件名可以不同）

相对路径：相对于游戏根目录或模组根目录的路径，包括文件名

注意：以上规则不准确，存在一些先序覆盖的情况，需要确认

## 代码补全

### 脚本文件

* 基于cwt规则文件

### 本地化文件

* 键入locale时，提示locale
* 键入commandField时，提示类型为`scripted_loc`的`definition`，以及由cwt规则文件定义的`localisation_command`（TODO 匹配scope）

## 代码检验

### 脚本文件

* 基于CWT规则文件

### 本地化文件

* 验证locale是否支持，始终提供intention：更改locale
* 验证serialNumber是否支持，始终提供intention：更改serialNumber
* 验证color是否支持，始终提供intention：更改color

## CWT规则文件支持

* 解析cwt规则文件（`*.cwt`）
* 解析插件自定义的定文件（`guidance.md`）   TODO：验证
* 有必要解析保留的日志文件，提取某些硬编码的规则，但最终仍然基于cwt规则文件（`*.log`）

特殊处理：

* （stellaris）`alias_name[modifier]`除了匹配`<static_modifier>`，还匹配从日志文件中解析得到的`modifierDefinitions`

## 其他

### 渲染dds图片

* 渲染dds图片到文档注释中
* 在插件的jar的顶级目录下放入一个压缩包`dds2png.zip`，这是一个用于将dds转化为png的小工具
* 定义一个工具类`DdsToPngConverter`
* 第一次使用到这个类时：
  * 确定用户目录（linux是`~`，windows是`C://Users/xxx`，需要确定获取方式）
  * 确定用户目录下存在文件`dds2png/dds2png.exe`，不存在的情况下，将jar包中的`dds2png`解压到用户目录
  * 如果后续执行转化命令时没有转化成功，也进行上述操作
* 需要渲染dds文件时：
  * 确定dds文件的`paradoxPath`，得到对应的png文件的`paradoxPath`，如果`~/dds2png/tmp`目录中存在对应的png文件，则直接使用
  * 如果没有，则需要确定dds文件的绝对路径
  * 执行转化命令：`~/dds2png/dds2png.exe -y <dds_name> <png_name>`
  * png文件保存在`~/dds2png/tmp`这个目录中 
* 未知图标（`unknown.png`，44x44）需要保存到`~/dds2png/tmp`的顶级目录下，以便必要时直接使用

```
	spriteType = {
		name = "GFX_text_army_ship"
		texturefile = "gfx/interface/icons/text_icons/text_icon_military_transport.dds"
	}
```