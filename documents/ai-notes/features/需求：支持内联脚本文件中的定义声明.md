# 需求：支持内联脚本文件中的定义声明

## 背景与问题

Paradox 引擎支持“内联脚本”（inline_script），可在调用处通过 `inline_script = { script = <path> ... }` 将脚本片段展开到当前上下文。典型示例：

```paradox_script
# in events/some_event.txt
event = {
    id = some_event.1
    # ...
}
```

等价于：

```paradox_script
# in events/some_event.txt
inline_script = {
    script = dir/event_snippet
    EVENT_ID = some.event.1
}

# in common/inline_scripts/dir/event_snippet.txt
event = {
    id = $EVENT_ID$
    # ...
}
```

当前插件仅能识别第一种“直接定义”的情况（定义名：`some.event.1`，类型：`event`），无法识别第二种“经由内联脚本间接定义”的情况。导致的影响：
- **定义解析/索引不完整**：找定义/跳转/重命名等功能在内联场景下失效。
- **引用解析不稳定**：基于定义名的引用在内联展开后无法正确定位。

## 目标（Must）
- **解析与索引通过内联脚本间接声明的定义**，保证与直接声明的定义具备一致的 IDE 能力（跳转、查找用法、重命名、导航、着色等）。
- 同时兼容两类定义名来源：
  - 定义名通过调用处参数传入（如：`EVENT_ID = event.id`）。
  - 定义名直接写在内联脚本文件中（常量字符串）。
- 在不破坏现有存根索引前提下，**增量**扩展解析/查询能力。

## 非目标（Won't）
- 不实现完整的运行时宏/变量求值，仅支持与定义名解析相关的参数替换与最小化表达式处理。
- 不在本迭代重构所有定义解析器，只针对内联脚本相关路径做“可插拔式增强”。

## 现状与限制
- 主要相关代码：
  - `icu.windea.pls.model.ParadoxDefinitionInfo`
  - `icu.windea.pls.lang.util.ParadoxDefinitionManager`
  - `icu.windea.pls.lang.util.ParadoxInlineScriptManager`
  - `icu.windea.pls.lang.util.ParadoxExpressionManager`
- 现有“定义”主要来源于直接 PSI/Stub 的结构扫描与索引；内联展开的跨文件信息（调用点参数 + 模板文件内容）未被联结处理。

## 设计约束与兼容性
- 与现存存根索引、文件索引与 PSI 结构兼容。
- 不要求所有替换表达式完整求值，仅覆盖与“定义名”相关的最小替换。
- 性能可控（索引期 O(n)，查询期惰性联结与缓存）。
- 与多游戏/多规则（CWT config）场景兼容，路径与类型映射应可扩展。

## 示例重述
- 调用处：
  ```paradox_script
  inline_script = {
      script = dir/event_snippet
      EVENT_ID = some.event.1
  }
  ```
- 模板处：
  ```paradox_script
  event = {
      id = $EVENT_ID$
  }
  ```
- 解析目标：在索引/查询时，将调用处参数 `EVENT_ID` 替换到模板 `id` 上，生成“合成的定义信息”（名称 `some.event.1`，类型 `event`），供所有下游能力使用。

## 方案概览（草案）

### 方案 A：双索引 + 查询期联结（推荐）
- 索引一：Inline Script“模板索引”记录模板文件中的“定义模板信息”。
  - 内容：`scriptPath -> (defType, nameExprParts, idPropertyLocation, file, offset, more...)`。
- 索引二：Inline Script“调用索引”记录调用点使用信息。
  - 内容：`scriptPath -> (callsiteFile, callsiteOffset, paramsMap)`，可一对多。
- 查询时：按 `scriptPath` 进行联结，取 `nameExprParts` + `paramsMap` 进行最小替换，得到 `resolvedName`，构造“合成定义信息”。
- 导航：优先跳转到模板处的定义形态与 `id` 位置；也可提供回跳到调用点的能力（如在结构视图或 QuickDoc 中展示“来源于内联调用”）。

优点：
- 与现有存根解耦，逐步接入；性能与缓存点明确；实现复杂度可控。

风险：
- 需要谨慎设计键值与归一化（`scriptPath` 规格、大小写、扩展名、省略规则等）。

### 方案 B：合成 PSI（FakePsiElement）+ 即时解析
- 在文件解析阶段探测内联调用并“就地”生成 `FakePsiElement` 表示的合成定义。
- 通过轻量缓存与弱引用管理生命周期。

优点：
- 导航体验自然，调用处就可看到“虚拟定义”。

风险：
- 生命周期与一致性管理更复杂；与索引能力的集成难度高。

### 方案 C：存根增强（不推荐）
- 让存根在模板文件侧产出“待替换的半成品定义”，在调用侧再补齐。

风险：
- 存根应尽量与“单文件可确定信息”耦合，跨文件联结放在 FileBasedIndex/查询期更合理。

### 方案对比小结
- 首选 A；B 可作为后续增强；C 放弃。

## 数据模型与索引设计

- 新增数据模型（概念/草案）：
  - `InlineScriptTemplateInfo`
    - `scriptPath: String`（归一化）
    - `defType: String`
    - `nameExprParts: List<NamePart>`（文字片段与占位符片段，如：`[Text(""), Placeholder("EVENT_ID"), Text("")]`）
    - `idPsiRange: TextRange`（模板文件中 `id` 的 PSI 区间）
    - `file: VirtualFile` / `filePath: String`
  - `InlineScriptUsageInfo`
    - `scriptPath: String`
    - `callsiteFile: VirtualFile` / `filePath: String`
    - `callsiteOffset: Int`
    - `params: Map<String, String>`（如：`{"EVENT_ID": "some.event.1"}`）
  - `InlineResolvedDefinitionInfo`（查询期合成，供 `ParadoxDefinitionInfo` 消费）
    - `origin = Inline`
    - `type = defType`
    - `name = resolvedName`
    - `navigation = { templateIdRange or callsite }`
    - `source = { scriptPath, callsiteFile, callsiteOffset, params }`

- 新增索引（FileBasedIndex）：
  - `InlineScriptTemplateIndex`
    - Key：`scriptPath: String`
    - Value：`InlineScriptTemplateInfo`（可做轻量可序列化结构）
  - `InlineScriptUsageIndex`
    - Key：`scriptPath: String`
    - Value：`InlineScriptUsageInfo`（支持多值）

路径归一化建议：
- 去除前置 `common/inline_scripts/` 前缀；统一分隔符；小写；忽略后缀 `.txt`；保留子目录（如 `dir/event_snippet`）。

## 解析与查询流程（推荐实施顺序）

1) 模板索引构建（遍历 `common/inline_scripts/**.txt`）：
- 找到“定义性结构”（如 `event = { id = ... }`）。
- 抽取 `id` 的“名称表达式”：将 `$VAR$` 识别为占位符片段，其他为文本片段。
- 记录 `defType`、`nameExprParts`、`idPsiRange`、`filePath` 等。

2) 调用索引构建（遍历所有脚本文件）：
- 匹配 `inline_script = { ... }` 结构。
- 读取 `script = <path>` 与所有 `key = value` 形式参数，形成 `paramsMap`。
- 记录 `callsiteFile/callsiteOffset/params`。

3) 查询阶段（找定义/引用解析）：
- 按 `scriptPath` 联结两个索引得到候选模板。
- 用 `paramsMap` 替换 `nameExprParts` 的占位符得到 `resolvedName`。
- 构造 `InlineResolvedDefinitionInfo` 并交给 `ParadoxDefinitionManager` 的检索逻辑。
- 导航优先指向模板文件中 `idPsiRange`（可附带“来自内联调用”的提示/标记）。

4) UI 与使用场景：
- 结构视图/导航条/查找用法应与直接定义一致。
- QuickDoc 可展示“定义来自内联脚本调用”，并显示调用点列表（可选）。

## 与现有组件的集成点
- `ParadoxInlineScriptManager`
  - 提供 `scriptPath` 归一化、模板文件定位、内联调用识别的公共方法。
- `ParadoxExpressionManager`
  - 提供最小表达式替换能力（占位符 -> 字面量），避免引入完整求值。
- `ParadoxDefinitionManager`
  - 在查询逻辑中增加“内联联结路径”，并将 `InlineResolvedDefinitionInfo` 映射/封装成 `ParadoxDefinitionInfo`（或增加 origin 字段）。
- `ParadoxDefinitionInfo`
  - 需要能表达 `origin=Inline`、`navigationTarget` 双位点（模板处/调用处）。若不便修改，可通过扩展包装对象或 `UserData` 承载附加信息。

## 性能与缓存策略
- 索引结果由 IDEA 框架管理；查询期对 `(scriptPath -> 模板/调用集合)` 建立 LRU 缓存。
- 最终名称解析使用 Guava Cache，建议策略：`maximumSize(4096)` + `expireAfterAccess(10 MINUTES)`（与项目中现有表达式解析缓存保持一致）。
- 大项目中按需分页/限制候选数量，避免一次性联结过多调用点。

## 风险与回退策略
- 路径归一化差异导致无法联结：加入诊断日志与 Telemetry（可选）。
- 模板文件中存在多个定义或多重占位符：以“最小替换 + 全量枚举”策略处理，必要时提示不确定性。
- 回退：当替换失败或信息不足时，不产生命名合成定义，仅保留模板文件原生能力。

## 测试计划
- 单元测试：
  - 模板索引构建（占位符解析、路径归一化）。
  - 调用索引构建（参数抽取、偏移记录）。
  - 名称解析（占位符替换、边界：缺参/空参/多参）。
- 集成测试：
  - 通过调用点能“找定义/跳转”到模板 `id`。
  - 通过引用名能定位到合成定义。
  - 结构视图与重命名在内联场景下正常工作（必要时限制重命名范围）。
- 性能回归：
  - 大型项目样本下索引与查询耗时可接受。

## 验收标准（Acceptance Criteria）
- 在包含内联脚本调用的项目中：
  - 通过调用点形成的定义名可被“查找定义/跳转”正确识别。
  - 通过文本/引用解析能定位到该合成定义。
  - 结构视图/导航条中显示与直接定义一致的类型与名称。
  - 在模板 `id` 处可见来源标识（可选 UI）。
  - 新增测试全部通过，现有测试不回归。

## 里程碑与任务拆分
- M1 需求沉淀与范围确认（本笔记）
  - 明确路径归一化与占位符模型；补充边界样例。
- M2 建立索引骨架（Template/Usage 两个 FileBasedIndex）
  - 暂不接入查询，仅能用工具类读取索引内容并做断言。
- M3 集成查询与名称解析
  - 在 `ParadoxDefinitionManager` 中新增联结路径；产出合成定义信息。
- M4 IDE 能力接入与 UI 优化
  - 跳转/查找用法/结构视图；可选 QuickDoc 提示。
- M5 稳定性与性能调优
  - 缓存与诊断；补充边界测试。

## 开放问题（待进一步调研）
- 模板中存在多个定义时如何判定“主要定义”？是否全部产出合成定义？
- 参数值若包含进一步的模板/变量，是否需要一层“解引用”？
- 多游戏类型/多路径规范下的 `scriptPath` 取值与归一化是否需要引入策略接口？

## 相关代码位置
- `icu.windea.pls.model.ParadoxDefinitionInfo`
- `icu.windea.pls.lang.util.ParadoxDefinitionManager`
- `icu.windea.pls.lang.util.ParadoxInlineScriptManager`
- `icu.windea.pls.lang.util.ParadoxExpressionManager`

## 可扩展内容
- **更丰富的 UI 反馈**：在模板/调用点之间提供“来源/去向”导航按钮。
- **重命名联动策略**：在内联场景下限制或提示重命名影响范围。
- **诊断面板**：展示联结链路与替换细节，便于排查。

## 参考链接
- Issue：支持内联脚本文件中的定义声明 https://github.com/DragonKnightOfBreeze/Paradox-Language-Support/issues/194
- 项目 README（了解整体结构与能力）
