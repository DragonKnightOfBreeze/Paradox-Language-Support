# 需求（二版）：支持内联脚本文件中的定义声明

> 在深入阅读现有源码后，对第一版方案进行校正与细化，提出更贴合当前架构、更易于落地的实现路径。

## 一、现状复盘（基于源码）

- 定义解析与索引
  - `icu.windea.pls.lang.util.ParadoxDefinitionManager`
    - 在 `doGetInfo` / `createStub` 中显式跳过 `inline_script` 调用点：当 `rootKey.isInlineUsage()` 时返回 `null`（不产出定义/存根）。
    - 允许在“内联脚本文件”中为定义产出存根，但不会处理“名称中的参数替换”。例如 `event { id = $EVENT_ID$ }` 会产出 `definitionName = "$EVENT_ID$"`（占位符未替换）。
  - `icu.windea.pls.lang.search.ParadoxDefinitionSearcher`
    - 仅基于“定义名/类型”的存根索引与文件级定义进行查找，不包含任何“内联联结”逻辑。
- 内联脚本能力
  - `icu.windea.pls.lang.util.ParadoxInlineScriptManager`
    - 能识别调用点与模板：`getUsageInfo`（用于索引）、`getInlineScriptExpression[FromInlineConfig]`、`getInlineScriptFile(Path)`。
    - 已有“推断上下文配置”的能力（`getInferredContextConfigs`），可基于模板或使用位置推断配置，但并未产出“已替换定义名”。
  - `icu.windea.pls.lang.index.ParadoxInlineScriptUsageIndex`
    - 已索引调用点，但仅记录 `expression`（脚本路径表达式）、`elementOffsets`、`gameType`，未记录参数映射。
  - `icu.windea.pls.ep.parameter.ParadoxInlineScriptParameterSupport`
    - 在 UI/参数侧可读到调用点 block 内的参数列表（跳过 `script`），说明“参数映射”可在 PSI 级别即时抽取。
- 其他索引
  - `icu.windea.pls.lang.index.ParadoxMergedIndex`
    - 面向多种信息的“文件内”索引器，支持懒索引（内联脚本文件也懒索引）。不适合做跨文件联结（调用点 ↔ 模板）。

小结：
- 现有“调用点索引”已具备；模板侧缺少“名称模板（含占位符）”的索引；查询端缺少“联结 + 占位符替换”的路径。
- 直接在 Definition 存根中存储“已解析名”不可行（需跨文件求值）。

## 二、问题定义与目标

- 目标：
  - 在 IDE 中，像对“直接定义”一样，支持“经由内联脚本间接声明的定义”的导航与引用解析（找定义/跳转/查找用法/重命名等）。
  - 同时兼容两类命名来源：
    - 调用处传参与模板 `$VAR$` 占位符替换。
    - 模板内直接常量名（该类已基本可通过现有存根工作）。
- 关键约束：
  - 不修改现有“Definition Stub”的基本职责与边界（尽量保持单文件确定性）。
  - 将“跨文件联结 + 占位符替换”放到“查询期”（search-time），并辅以轻量索引与缓存。

## 三、第二版总体方案（查询期联结 + 单侧增强索引）

- 核心思路：
  - 新增“模板侧索引”：记录内联脚本文件中“定义类型 + 名称表达式（含占位符）+ 导航位置”。
  - 复用现有“调用点索引”：用 `ParadoxInlineScriptUsageSearch` 快速定位所有调用点；参数映射在查询期从 PSI 即时抽取（避免再建索引）。
  - 在 `ParadoxDefinitionSearcher` 的查询流程中，追加一条“内联联结路径”：当常规存根查询未命中或需要补全结果时，按 `scriptPath` 将“模板记录”与“调用点”联结，执行占位符替换，匹配目标定义名与类型，产出 PSI 结果（指向模板中的定义/名称处）。

- 组件新增/改造：
  1) 新增 FileBasedIndex：`ParadoxInlineScriptTemplateIndex`
     - Key：`scriptPath: String`（即 `ParadoxInlineScriptManager.getInlineScriptExpression(file)` 的表达式）
     - Value（可序列化轻量结构）：`InlineScriptTemplateInfo.Compact`
       - `type: String`
       - `nameFieldPath: String?`（如 `id`；若 `nameFromFile` 或 `nameField == null` 则为 null）
       - `nameExprParts: List<Part>`（文本与占位符分段，如 `Text(""), Placeholder("EVENT_ID"), Text("")`）
       - `idNameTextRange: TextRange`（模板文件中用于生成名字的文本区间，便于导航高亮）
       - `filePath` 或 `fileId`（供反查 PSI）
     - 构建逻辑：
       - 仅对“内联脚本文件”（`getInlineScriptExpression(file)!=null`）生效。
       - 遍历文件内“定义性结构”（借助 `ParadoxDefinitionManager.matchesType(...)`）。
       - 依据 `typeConfig` 获取名字来源：
         - `nameFromFile`：固定为 `fileName`（无占位符）。
         - `nameField == null`：固定为 `rootKey.removePrefix(starts_with)`（无占位符）。
         - `nameField == "-"` 或具体字段：从对应属性字符串中解析 `$VAR$` 占位符，切分为 `nameExprParts`；记录该文本区间。
       - 若完全无占位符（常量名），也可记录（便于统一查询逻辑，同时可与现有存根结果去重）。
  2) 查询期参数映射抽取（不建索引）
     - 基于 `ParadoxInlineScriptUsageSearch` 获取某表达式的所有调用点（已由 `ParadoxInlineScriptUsageIndex` 提供）。
     - 在 PSI 层读取调用点 block 中的键值（跳过 `script`），形成 `params: Map<String,String>`；参考 `ParadoxInlineScriptParameterSupport` 的实践。
     - 仅对简单文本值（字符串/标识符）进行替换；遇到再次参数化或复杂表达式暂不求值（回退）。
  3) `ParadoxDefinitionSearcher` 增强
     - 在 `processQueryForDefinitions` 之后，追加 `processQueryForInlineResolvedDefinitions`：
       - 若已有结果可选早停（避免重复）；否则继续。
       - 由 `typeExpression`（若提供）筛选 `ParadoxInlineScriptTemplateIndex` 中的模板；否则全量模板（可设上限/按游戏类型筛）。
       - 对每个模板，取 `scriptPath`，用 `ParadoxInlineScriptUsageSearch` 获取调用点；对每个调用点读取 `params`；以 `nameExprParts` 执行占位符替换，得到 `resolvedName`；
       - 若 `resolvedName == query.name` 且类型匹配，则产出模板 PSI 元素（指向定义或其 `id` 文本区间），作为查询结果。
     - 去重策略：若常规存根已产出与 `resolvedName` 同名的结果，忽略重复（或以模板结果补充“来源提示”）。
  4) 缓存与性能
     - 对 `(templateId, callsiteOffset)` 的一次替换结果做 LRU 缓存（Guava：`maximumSize(4096) + expireAfterAccess(10m)`）。
     - 查询时支持“只取最相关”（`onlyMostRelevant`）的快速路径（遇到首个匹配即停）。

## 四、与第一版方案的差异与改进

- 第一版建议“模板索引 + 调用索引（含参数）”双索引。第二版基于现状改为：
  - 只新增“模板索引”；调用参数不再建索引，改为查询期从 PSI 提取，复用 `ParadoxInlineScriptUsageSearch` 的结果。
- 优点：
  - 降低索引复杂度与体积；避免版本升级后索引迁移开销；实现量更小、贴合现有代码。
- 取舍：
  - 查询期间会读取 PSI 获取参数映射，开销略增；可通过缓存与“只取最相关”策略缓解。

## 五、边界与回退策略（精化）

- 名称来源判定：
  - `nameFromFile` / `nameField==null`：视为“常量名”，无需占位符替换；若现有存根已能覆盖，结果仅用于对齐与去重。
  - `nameField=="-"` / 指定字段：从该字段的字符串中提取占位符并替换。
- 参数值复杂度：
  - 仅支持“简单文本”值；若参数缺失、空值、或再次参数化（如 `$X$`），则跳过该调用点（保持“最小可行”）。
- 多定义/多占位符：
  - 同一模板文件可能存在多个定义与多个占位符：逐一定义产生命名候选，执行替换；必要时限制每模板输出的候选上限。
- 去重与一致性：
  - 与存根产生的“常量名定义”结果去重；优先保留存根（稳定，具备更多派生能力）。

## 六、影响面与需要的重构点

- `ParadoxDefinitionSearcher`
  - 增加一段“内联联结”的处理逻辑；建议抽取为 `InlineResolvedDefinitionSearcher` 工具类，避免膨胀。
- `ParadoxInlineScriptManager`
  - 新增：`getArgumentMap(property: ParadoxScriptProperty): Map<String,String>`（或同等工具方法），复用 `ParadoxInlineScriptParameterSupport` 的读取方式，跳过 `script` 键。
  - 新增：`parseNameExprParts(text: String): List<Part>`（委托或复用 `ParadoxExpressionManager.getParameterRanges`）。
- 新增索引：`ParadoxInlineScriptTemplateIndex`
  - 按 `InlineScriptUsageIndex` 的风格实现 `Compact` 序列化；确保 `useLazyIndex(...)` 对内联文件返回 `true`。
- 可选：`ParadoxDefinitionInfo` 无需修改；如需 UI 展示“来源：内联脚本调用”，可通过 `UserData` 或 QuickDoc 注入。

## 七、实施步骤（里程碑）

- M1：模板索引
  - [ ] 设计并实现 `ParadoxInlineScriptTemplateIndex` 与 `InlineScriptTemplateInfo(Compact)`。
  - [ ] 实现名称来源解析与占位符切分；编写单元测试（边界：空名、纯常量、多个占位符）。
- M2：查询期联结
  - [ ] 实现 `InlineResolvedDefinitionSearcher`，集成到 `ParadoxDefinitionSearcher.processQuery`。
  - [ ] 复用 `ParadoxInlineScriptUsageSearch`；在 PSI 读取参数映射，完成替换与匹配；实现 LRU 缓存。
  - [ ] 集成/单元/性能测试：从调用点跳转、按名查找；大项目采样。
- M3：体验优化（可选）
  - [ ] QuickDoc/导航处展示“来自内联脚本：<path>”；
  - [ ] 在结构视图中对模板内的定义显示“占位符名”提示。

## 八、测试计划（精化）

- 单元测试
  - 模板索引：`event { id = $X$ }`、`id = CONST`、多占位符、空/缺失情况。
  - 替换器：`parts + params -> resolvedName` 的边界（缺参/空参/特殊字符/转义）。
- 集成测试
  - `inline_script` 调用传参命中 `event.id` 的解析，`ParadoxDefinitionSearch` 能找到模板定义 PSI。
  - 常量名模板与存根结果并存时，去重/一致性验证。
- 性能测试
  - 大项目下搜索典型定义名的耗时与索引体积评估；缓存命中率观测。

## 九、开放问题

- 是否需要为“调用参数”建立索引以减少 PSI 读取？建议先观察性能再决定（如需则引入 `ParadoxInlineScriptArgumentsIndex`）。
- 名称来源涉及复杂表达式（如条件块 `[[...]]`）时如何处理？第二版暂不支持，后续可在表达式求值层面增强。

## 十、参考代码位置

- `icu.windea.pls.lang.util.ParadoxDefinitionManager`（跳过内联调用点；名称来源逻辑）
- `icu.windea.pls.lang.search.ParadoxDefinitionSearcher`（定义查询入口，需新增“内联联结”路径）
- `icu.windea.pls.lang.util.ParadoxInlineScriptManager`（表达式/文件/使用查询，新增参数映射工具）
- `icu.windea.pls.lang.index.ParadoxInlineScriptUsageIndex` + `ParadoxInlineScriptUsageSearch`（调用点索引与查询）
- `icu.windea.pls.ep.parameter.ParadoxInlineScriptParameterSupport`（参数读取方式参考）
- `icu.windea.pls.lang.index.ParadoxMergedIndex`（仅文件内信息，非跨文件联结）

## 十一、验收标准

- 在含有 `inline_script` 的项目中：
  - 通过“定义名 + 类型”查询，能定位到模板文件中的定义 PSI；
  - 从调用点触发的引用解析/跳转可命中模板定义 PSI；
  - 与直接定义的导航体验一致；
  - 新增测试覆盖主要边界，现有测试不回归；
  - 性能与索引体积在可接受范围内（提供指标）。
