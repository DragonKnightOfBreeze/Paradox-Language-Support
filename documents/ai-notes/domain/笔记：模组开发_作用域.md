# 笔记：模组开发_作用域

> 参考来源（群星模组教程）：
> - https://main--pdxdoc-next.netlify.app/guides/event_modding/scope/
> - https://main--pdxdoc-next.netlify.app/guides/event_modding_advanced/overview/
> - https://main--pdxdoc-next.netlify.app/guides/event_modding_advanced/border_of_event/
> - https://main--pdxdoc-next.netlify.app/guides/event_modding_advanced/how_to_find_scope/

## 前言

- **作用域（scope）** 又称 **范围**，是蠢驴脚本（事件/触发/效应等）描述语义的“主语”。
- 在语义上，“scope”既可能指代一个“**作用域链接（scope link）**”（例如 `root.owner`，用于获取或切换到目标作用域），也可能指代一个“**作用域类型（scope type）**”（例如 `country`、`planet`），后者一般不会直接出现在脚本中，而是由上下文推断。
- 群星脚本中还存在四个特殊的 **系统作用域（system scope）**：`THIS`、`ROOT`、`FROM`、`PREV`。它们不区分大小写，可写作任意大小写形式。

## 核心概念

**作用域：**

一切触发（trigger）与效应（effect）都在“一个具体对象”上执行，这个对象就是当前作用域（scope）。作用域是“主语”，不是类型名；它通过事件的默认 ROOT、系统作用域（THIS/ROOT/FROM/PREV）、以及遍历/流程/属性跳跃被确定与传递。

**系统作用域：**

指向“当前或上下文相关”的保留关键字：`THIS`、`ROOT`、`FROM`、`PREV`。用于在事件链中可靠地回到、或引用之前已知的对象。大小写不敏感，`PREV` 可堆叠最多 4 层。详见下节“系统作用域”。

**作用域链接：**

用点号 `.` 串联属性作用域，形如 `a.b.c`。每一步都在 `THIS` 基础上取得“唯一的关联对象”，最终指向单一对象（非集合）。建议链深 ≤ 5。例：`capital_scope.solar_system.star`。

**作用域类型：**

对象的静态类别（如 `country`、`planet`、`ship` 等），决定可用的触发/效应集合。可用 `is_scope_type = <type>` 检测 `THIS` 是否为该类型。类型名很少直接写在脚本里，通常由上下文或属性跳跃隐式确定。

## 系统作用域

- **THIS（当前作用域）**：当前代码块正在操作的对象。很多 effect/trigger 的目标默认就是 `THIS`。
- **ROOT（根作用域）**：事件的默认/基础作用域。例如 `country_event` 的 `ROOT` 是触发者国家。可随时在事件内部引用。
- **FROM（来源作用域）**：触发/调用当前事件的“上级作用域”。其含义取决于触发来源（尤其是 `on_action`，需查阅官方注释以判定 FROM 映射）。
- **PREV（上一步作用域）**：在进入当前 `THIS` 之前的那个作用域。支持堆叠，常见到 `PREVPREV...`，最多回溯 4 层（`PREVPREVPREVPREV`）。
- **作用域链接（点链式）**：使用 `.` 将若干“属性作用域”串联，例如 `capital_scope.solar_system.star`（首都星球 → 其星系 → 该星系主恒星）。
  - 系统作用域也可以参与点链，如 `owner.prev`。
  - 链式解析最终只指向“**一个具体作用域对象**”，不是集合；最多嵌套 5 层。
- **作用域类型**：`country`、`planet`、`fleet`、`ship`、`system`、`starbase`、`species`、`leader` 等。可用 `is_scope_type = <scope>` 判断。

## 作用域跳跃与调用（如何“找到目标”）

> 在蠢驴语中，可以认为“scope 是主语，effect/trigger 是谓语”。寻找或指代目标的过程，主要依靠三类语句：遍历型、流程型、属性型。

### 遍历型（Traversal Jump）

- **Effect 中**使用：前缀 `every_...`、`random_...`，如 `every_owned_planet`、`random_system`。进入块体后，`THIS` 变为被遍历/抽取到的那个对象。
- **trigger 中**使用：前缀 `any_...`，如 `any_owned_pop`。`any_*` 只能出现在条件中，不能出现在 effect 中。
- **limit**：在遍历块体内用 `limit = { ... }` 进一步筛选（内部填 trigger）。
- 示例：
```cwt
immediate = {
    random_system = {
        every_system = {
            limit = {
                distance = {
                    source = prev    # 回溯到 random_system 抽到的系统
                    max_jumps = 5
                }
            }
            # 在此处 THIS = 被筛选出的 system
        }
    }
}
```

### 流程型（Process Jump / 调用）

- 代表“**已知**/之前找到”的目标；既可单独用作跳跃（`ROOT = { ... }`），也常在多目标语句中作为参数。
- **THIS**：当前作用域；也可用于需要“显式目标”的 effect 参数（如 `destroy_fleet = this`）。
- **ROOT**：事件的默认作用域；可作为参数（如 `who = ROOT`），也可跳回 `ROOT` 执行一段代码。
- **PREV**：进入当前 `THIS` 前的那个作用域；可堆叠回溯，最多 4 层。
- **FROM**：触发者/调用者；尤其在 `on_action` 中由官方注释定义其语义映射（如“进入战斗”时 FROM 表示“第二支舰队的所有者”）。
- 示例（多目标 effect）：
```cwt
immediate = {
    every_country = {
        add_trust = {
            who = ROOT     # 以 ROOT（发起国）为对方
            amount = -50
        }
    }
}
```

### 属性型（Property Jump）

- 基于 `THIS` 的“**属性关系**”跳到另一个具体对象。如 `owner`（所有者国），`ruler`（统治者），`solar_system`（所在星系），`star`（主恒星）等。
- 有些属性名直接就是“作用域类型名”，如在 `pop` 作用域中可用 `planet`，在 `planet` 作用域中可用 `starbase`。但须满足“**唯一性**”：`THIS` 必须只对应一个该类型的对象时才成立。
- 示例：
```cwt
immediate = {
    capital_scope.solar_system.star = {
        # 此处 THIS = 该帝国首都 → 其星系 → 该星系主恒星
    }
}
```

### event_target（系统化用法）

当需要“在后续步骤复用”某个找到的对象，或“跨多层嵌套/子事件”传递目标时，可使用事件目标（event target）。它与流程型/属性型互补：

- 流程/属性更适合“就地临时引用”（如 ROOT/PREV/owner）。
- event_target 更适合“保存后复用/跨作用域边界传递”。

保存方式：

- 本地事件目标（仅在未中断的事件链内可用）：
  - `save_event_target_as = my_target`（保存 `THIS`）
  - `save_event_target_as = my_target@from` / `@root` / `@prev`（保存特定系统作用域）
- 全局事件目标（全局可见，直到清理）：
  - `save_global_event_target_as = my_target` / `my_target@from`
  - `clear_global_event_target = my_target`（清除单个）
  - `clear_global_event_targets = yes`（清除全部）

引用方式：

- 作为参数：`who = event_target:my_target`
- 作为接收者：`event_target:my_target = { ... }`

示例 1：固定双方后执行多目标 effect

```cwt
immediate = {
    save_event_target_as = src@root           # 固定发起国为 src
    random_country = {
        limit = { NOT = { is_same_value = ROOT } }
        save_event_target_as = dst            # 固定随机国为 dst（THIS）
    }
    event_target:dst = {
        add_trust = { who = event_target:src amount = 50 }
    }
}
```

示例 2：解耦深层查找，延后在其他块内使用

```cwt
immediate = {
    every_owned_pop = {
        limit = { is_unemployed = yes }
        save_event_target_as = unemployed_pop   # 记住失业人口
    }
    ROOT = {
        random_owned_planet = {
            limit = { free_jobs > 0 }
            save_event_target_as = dst_planet   # 记住目标星球
        }
    }
    resettle_pop = {
        pop = event_target:unemployed_pop
        planet = event_target:dst_planet
    }
}
```

最佳实践：

- 使用有前缀的名字避免冲突（如 `mymod_dst_planet`）。
- 本地目标适合短流程；需要跨事件/长期存在的使用全局目标并在合适时机清理。
- 就近优先用 `ROOT/THIS/PREV`；确需跨块/多处复用时再用 `event_target`。
- 结合遍历/属性精准定位后再保存，减少过深链式与歧义。

## 事件与 ROOT（基础作用域）

- 常见事件类型与其 ROOT：
  - `country_event` → 触发国家（推荐入门使用）
  - `planet_event` → 触发星球（剧情文本常用）
  - `ship_event` → 触发舰船（坟类事件常用）
  - `fleet_event`、`system_event`、`starbase_event`、`pop_event`、`pop_faction_event`、`observer_event`、`first_contact_event`、`espionage_operation_event`
  - `event` → 无 ROOT（多用于全局设置或特殊 on_action 限制）

## 语法与约束要点

- **大小写不敏感**：`THIS/ROOT/PREV/FROM` 均不区分大小写。
- **链式层数**：点链式作用域最多嵌套 **5 层**；最终指向单个对象。
- **PREV 回溯**：最多 **4 层**（`PREVPREVPREVPREV`）。
- **遍历位置**：`every_/random_` 只在 effect；`any_` 只在 trigger。
- **limit 用法**：只能出现在块体内部（如遍历、`if/while` 等），内部书写 trigger。
- **THIS/ROOT 跳转**：可写 `THIS = { ... }`、`ROOT = { ... }`，分别在当前/根作用域内执行一段代码。
- **FROM 的判定**：由触发来源（尤其 `on_action`）决定，务必查阅官方注释判断其映射含义。

## 常见模式与实战范例

- **排除发起者国家的战争参与国**（`every_war` → `every_war_participant`）：
```cwt
immediate = {
    every_war = {
        every_war_participant = {
            limit = { NOT = { is_same_value = ROOT } }
            # 此处 THIS = 参战国（非发起者）
        }
    }
}
```

- **“自动人口迁移”核心片段**（找失业人口与有空岗星球并迁移）：
```cwt
immediate = {
    every_owned_pop = {
        limit = { is_unemployed = yes }
        ROOT = {
            random_owned_planet = {
                limit = { free_jobs > 0 }
                resettle_pop = {
                    pop = PREVPREV   # 回到 every_owned_pop 找到的那个 pop
                    planet = THIS    # 目标星球 = 当前随机到且通过 limit 的星球
                }
            }
        }
    }
}
```

## 速查表（片段）

- **系统作用域**：
  - `THIS` 当前作用域
  - `ROOT` 事件根作用域
  - `FROM` 触发来源（查注释）
  - `PREV` 上一步作用域（最多 4 层）
- **常用属性作用域**：
  - `owner`、`controller`、`space_owner`
  - `solar_system`、`star`、`starbase`
  - `capital_scope`、`orbit`
  - `ruler`、`leader`、`owner_species`
  - `planet`、`species`、`army`
  - `ship`、`fleet`、`design`
  - `federation`/`alliance`、`war`
  - `last_created_*`（最近创建）
- **遍历与筛选**：
  - effect：`every_*`、`random_*`
  - trigger：`any_*`
  - 常配合 `limit = { ... }`

## 常见误区

- **把 `any_*` 用在 effect** 或把 `every_/random_` 用在 trigger。
- **忽略 `FROM` 的真实含义**：不同 `on_action` 的 `FROM/THIS` 映射不同。
- **把属性作用域当作集合**：属性作用域必须能唯一确定一个对象，如 `pop` 只能在 `THIS` 为 `planet`（或唯一可解析的场景）时才成立。
- **链式过深/过度依赖**：层数超过 5 或语义可读性差时，优先拆分或使用 `event_target` 临时存储。

## 小结

- **一句话理解**：在蠢驴语中，“**scope 是主语**”，“**effect/trigger 是谓语**”。围绕“如何找到目标（scope）”展开，再应用正确的谓语（effect/trigger），就能稳定实现复杂逻辑。
- **建议**：先明确事件 `ROOT`，再按“遍历 → 限定 → 存取/调用（THIS/ROOT/PREV/FROM 或 event_target） → 执行 effect”的套路推进。
