# 笔记：规则系统_规则

> 目标：作为“规则参考文档”的预研/准备笔记，系统梳理 PLS 的规则（CWT 规则）建模、解析与文档化的关键点。笔记较参考文档更详尽，并包含对应的代码与文档的引用位置，便于快速跳转与校验。

- 代码入口（规则接口与核心实现）：
  - `src/main/kotlin/icu/windea/pls/config/config/CwtConfig.kt`
  - `src/main/kotlin/icu/windea/pls/config/config/CwtMemberConfig.kt`
  - `src/main/kotlin/icu/windea/pls/config/config/CwtOptionMemberConfig.kt`
  - `src/main/kotlin/icu/windea/pls/config/config/CwtPropertyConfig.kt`
  - `src/main/kotlin/icu/windea/pls/config/config/CwtValueConfig.kt`
  - `src/main/kotlin/icu/windea/pls/config/config/CwtOptionConfig.kt`
  - `src/main/kotlin/icu/windea/pls/config/config/CwtOptionValueConfig.kt`
  - `src/main/kotlin/icu/windea/pls/config/config/CwtFileConfig.kt`
  - `src/main/kotlin/icu/windea/pls/config/config/CwtDelegatedConfig.kt`
  - `src/main/kotlin/icu/windea/pls/config/config/CwtDetachedConfig.kt`
  - 常用扩展与存取器：
    - `src/main/kotlin/icu/windea/pls/config/config/_accessors.kt`
    - `src/main/kotlin/icu/windea/pls/config/config/_extensions.kt`
- 文档与指南：
  - PLS 规则系统说明：`docs/zh/config.md`
  - CWT 指引（CWTools）：`references/cwt/guidance.md`
  - 作用域（Scope）领域知识：`documents/ai-notes/笔记：模组开发_作用域.md`

---

## 一、术语与约定

- **规则 / 扩展规则（config / extended config）**：对应 `.cwt` 文件中的条目与插件扩展条目（如 inline scripts、parameters 等）。
- **规则表达式（config expression）**：用于匹配/约束规则关键数据的表达式（见 `configExpression` 与 `valueExpression`）。
- **选项（options）**：以 `##` 形式声明的元信息，如 `## cardinality = 0..1`、`## push_scope = country`。
- **作用域上下文（scope context）**：由系统作用域（THIS/ROOT/FROM/PREV）与 `push_scope`/`replace_scopes` 等选项共同决定的“主语环境”。
- **定位与命名**：采用 ANT 风格路径表达式与 `{}` 参数占位习惯来描述规则所在位置及命名，示例：
  - 类型规则：`types/type[{type}]`
  - 子类型规则：`types/type[{type}]/subtype[{subtype}]`
  - 别名规则：`alias[{name}:{subName}]`
  - 系统作用域规则：`scopes/$`

> 规范参考：`.windsurf/rules/docstring.md`（中文 KDoc、简介优先、@property 汇总字段、参数尽量内联描述）。

---

## 二、规则接口总览（Model）

- `CwtConfig<T : PsiElement>`：规则统一抽象。
  - 关键属性：
    - `pointer: SmartPsiElementPointer<out T>`：指向对应 PSI 的智能指针（跨线程/缓存安全）。
    - `configGroup: CwtConfigGroup`：所属规则分组（按项目/游戏类型）。
    - `configExpression: CwtDataExpression?`：绑定的数据表达式（默认 null，由不同实现覆写）。
  - 关联：`CwtFileConfig`、`CwtMemberConfig`、`CwtOptionMemberConfig`、`CwtDelegatedConfig`、`CwtDetachedConfig`。

- `CwtMemberConfig<T : CwtMemberElement>`：成员规则（属性或值）。
  - 关键属性：`value`、`valueType: CwtType`、`configs`（子规则）、`optionConfigs`（选项成员规则）、`parentConfig`、`valueExpression`、`configExpression`。
  - 典型扩展：
    - 值访问：`booleanValue/intValue/floatValue/stringValue`（仅在类型匹配时解析）。
    - 子项过滤：`values`、`properties`。
    - 选项读取：`optionFlags: CwtOptionFlags`、`optionData { ... }`。
    - 附加元信息：`originalConfig`（被覆写前的原始规则）、`overriddenProvider`（覆写提供者）、`declarationConfigContext` 与 `declarationConfigCacheKey`（声明规则上下文）。
    - 其他：`isBlock`（是否存在子规则）、`memberConfig`（归一到属性规则）、`toOccurrence(...)`（由 `cardinality` 生成展示区间并可被 define 覆盖）。

- `CwtOptionMemberConfig<T>`：选项成员规则（来自 `## ...` 注释块）。
  - 值访问：`booleanValue/intValue/floatValue/stringValue`。
  - 子项过滤：`options`、`optionValues`。

- `CwtPropertyConfig` / `CwtValueConfig` / `CwtOptionConfig` / `CwtOptionValueConfig`：具体形态。
  - 关联扩展存取字段（填充于解析阶段，便于溯源与文档）：
    - `CwtPropertyConfig.singleAliasConfig: CwtSingleAliasConfig?`
    - `CwtPropertyConfig.aliasConfig: CwtAliasConfig?`
    - `CwtPropertyConfig.inlineConfig: CwtInlineConfig?`
    - `CwtValueConfig.tagType: CwtTagType?`

- `CwtDelegatedConfig` / `CwtDetachedConfig`：扩展规则抽象。
  - 前者：面向“某处”的规则扩展（如 `types/type[{type}]` 下的 `localisation`、`images` 等）。
  - 后者：文件级松散扩展（如 `definitions`、`game_rules`、`inline_scripts` 等）。

> 代码参考：`config/config/*.kt`；扩展与辅助：`config/config/_accessors.kt`、`config/config/_extensions.kt`。

---

## 三、规则分类与“路径定位”范式

> 路径采用 ANT 风格，参数用 `{}` 包裹，`$` 表示“当前规则名”。

- **类型与子类型（Types/Subtypes）**
  - 路径：`types/type[{type}]`、`types/type[{type}]/subtype[{subtype}]`
  - 关键选项：`path`、`type_per_file`、`starts_with`、`type_key_filter`、`unique`、`severity` 等。
  - 子类型可附 `## push_scope`、`## display_name`、`## abbreviation`。

- **别名与单别名（Aliases/Single Aliases）**
  - 路径：`alias[{name}]` 或 `alias[{group}:{name}]`，`single_alias[{name}]`
  - 用途：复用规则结构（如 effect/trigger），常见于 `immediate`、`potential`、`modifier` 等块内。

- **声明类（Declarations）**
  - 路径：`declarations/$`（或按扩展定义）
  - 用途：声明定义/本地化/复杂枚举等的派生或额外元信息。

- **枚举与复杂枚举（Enums/Complex Enums）**
  - 路径：`enums/enum[$]`、`enums/complex_enum[{name}]`
  - 复杂枚举：通过 `path` 与 `name` 结构在脚本中“收集”枚举值。

- **动态值（Dynamic Values）**
  - 路径：`dynamic_values/{type}/$`
  - 典型：`event_target`（参见“作用域笔记”与 `script-docs`）。

- **内联脚本（Inline Scripts）**
  - 路径：`inline_scripts/$`
  - 支持声明上下文配置与 `replace_scopes`。

- **参数（Parameters）**
  - 路径：`parameters/$`
  - 关键选项：`context_key`、`replace_scopes`、`inherit` 等。

- **修正（Modifiers）与修正类别**
  - 路径：`modifiers/$`、`modifier_categories/$`

- **链接（Links）与系统作用域（Scopes/System Scopes）**
  - 文件：`links.cwt`、`scopes.cwt`（CWTools 核心魔法文件，PLS 内置/同步）

> 详细指南：`references/cwt/guidance.md`；PLS 具体扩展请对照 `docs/zh/config.md` 的“编写规范（扩展的 CWT 规则）”。

---

## 四、规则选项（Options）

- **出现次数**：`## cardinality = 0..1`、`## cardinality = ~1..2`（放宽下限为 warning）
- **作用域上下文**：
  - `## push_scope = country`（压入 THIS 作用域）
  - `## replace_scopes = { this = planet root = country from = ship }`（替换上下文中的系统作用域，PREV 不支持）
  - `## scope = country` 或 `## scope = { country planet }`（限定当前上下文可用范围）
- **类型定位与过滤**：`path`、`path_strict`、`path_file`、`path_extension`、`type_key_filter`、`starts_with`、`type_per_file`、`unique`、`severity`。
- **本地化**：类型级 `localisation` 块（`primary`、`required`）与占位 `$` 规则。

> 在 PLS 中，`toOccurrence(...)` 会结合 `cardinalityMinDefine`/`cardinalityMaxDefine` 的 define 值实时覆盖 UI 展示（参见 `_extensions.kt`）。

---

## 五、作用域上下文与脚本层面的“Scope”

- 脚本域（THIS/ROOT/FROM/PREV、链式 owner.prev 等）与规则域（push/replace_scopes）概念相互呼应：
  - 规则的 `push_scope` 相当于“在解析/校验时把 THIS 切为某类型”。
  - 规则的 `replace_scopes` 提供了与 `ROOT/FROM` 对应的上下文替换，便于在规则中对跨作用域引用进行静态约束。
- 快速复习脚本 Scope（详见：`documents/ai-notes/笔记：模组开发_作用域.md`）：
  - 系统作用域：THIS/ROOT/FROM/PREV（大小写不敏感，PREV 回溯 ≤ 4）
  - 点链式：`a.b.c`（最多 5 层，唯一对象）
  - 遍历/流程/属性型跳跃与 `event_target` 的互补关系

---

## 六、规则表达式与数据表达式（Expressions）

- 入口包：`src/main/kotlin/icu/windea/pls/config/configExpression/`
  - 推荐参考：`CwtConfigExpression`、`CwtCardinalityExpression`
- 能力：
  - 模板表达式：`a_<job>_b`、`a_enum[weight_or_base]_b`、`a_value[anything]_b`
  - ANT 表达式：`ant:/foo/bar?/*`、`ant.i:/foo/bar?/*`
  - 正则表达式：`re:foo.*`、`re.i:foo.*`
- 在规则接口中的体现：
  - `valueExpression`：成员规则右值的数据表达式
  - `configExpression`：绑定到整条规则的表达式（例如属性键/值的组合）

---

## 七、覆盖策略与来源追踪（Overrides）

- 覆盖策略：按“文件路径 + 规则 ID”后序覆盖（见 `docs/zh/config.md` → 覆盖策略）。
- PLS 扩展字段：
  - `originalConfig`：保留被覆写前的原始规则
  - `overriddenProvider`：记录覆写来源（远程/本地/项目本地等）
- 典型流程：
  1) 读取内置规则分组 → 读取本地/项目本地规则分组
  2) 根据路径与 ID 进行合并/覆盖
  3) 解析阶段填充扩展元信息（single alias/alias/inline/tagType 等）

---

## 八、常见“定位与命名”模板（KDoc 友好）

- **类型规则**：
  - 定位与命名：`types/type[{type}]`
  - 示例：`stellaris:common/technologies_consolidated.cwt`
- **子类型规则**：
  - 定位与命名：`types/type[{type}]/subtype[{subtype}]`
- **别名规则**：
  - 定位与命名：`alias[{name}:{subName}]`
  - 示例：`stellaris:common/effects.cwt`（effect/trigger 族）
- **复杂枚举**：
  - 定位与命名：`enums/complex_enum[{name}]`
  - 示例：`stellaris:enums.cwt`
- **系统作用域**：
  - 定位与命名：`scopes/$`
  - 示例：`stellaris:scopes.cwt`

> 注：示例路径采用“游戏标识:文件（或逻辑路径）”简写，仅用于说明；以实际仓库/安装路径为准。

---

## 九、与脚本文档（script-docs）的映射

- 典型对照：
  - `effects.log`：Effect 支持的目标、参数与作用域要求（见仓库 `cwt/cwtools-stellaris-config/script-docs/`）
  - `triggers.log`：Trigger 支持的作用域与参数
  - `localisations.log`/`modifiers.log`：本地化与修正的结构
- 规则侧的体现：
  - 利用 `alias`/`single_alias` 对 effect/trigger 栈进行建模
  - 利用 `types`/`enums`/`complex_enum` 约束引用
  - 利用作用域选项（push/replace）与 `scope[...]`/`event_target[...]` 类型表达式校验上下文

---

## 十、最佳实践与注意事项

- **KDoc 风格**：
  - 中文，简介优先；参数尽量内联描述；字段用 `@property` 汇总。
  - 可在 KDoc 尾部添加 `@see` 引用相关管理器/解析器。
- **作用域**：
  - 仅在需要跨块/跨事件重用时使用 `event_target`；就近优先 `THIS/ROOT/PREV`。
  - 链式不宜过深（≤ 5），能拆就拆；规则侧可通过 `replace_scopes` 降低歧义。
- **覆盖**：
  - 遵循覆盖策略；保留 `originalConfig` 便于回溯。
- **表达式**：
  - 模板/ANT/正则的选择：优先模板（可读性），路径匹配用 ANT，复杂匹配再考虑正则。

---

## 十一、后续工作（面向“参考文档”）

- 按“规则分类”生成结构化参考文档（简短版），本笔记作为备查依据。
- 从 `docs/zh/config.md` 的“编写规范（扩展的 CWT 规则）”迁移/收敛必要说明到参考文档。
- 整理 `on_action` 的 `THIS/ROOT/FROM/PREV` 语义映射速查表，挂到“作用域”附录。
- 将示例对齐到 Stellaris 内置/常见文件，补充“定位与命名”片段。
