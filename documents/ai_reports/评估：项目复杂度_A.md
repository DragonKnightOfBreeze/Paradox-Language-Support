# 评估：项目复杂度

> 评估日期：2026-02-14
> 数据来源：README、code_stats.py、config_stats.py、plugin.xml 及其引用的全部 18 个 XML 配置文件
> 模型：Claude Opus 4.6 Thinking

## 一、项目定位

Paradox Language Support（PLS）是一个面向 Paradox 游戏模组开发者的 **IntelliJ IDEA 语言支持插件**，基于 IntelliJ Platform SDK 构建，采用 Kotlin + Java 开发，通过 PSI（而非 LSP）实现深度语言解析与操作。

**核心价值：** 为 Paradox 游戏（Stellaris、Victoria 3、CK3、EU4、EU5、HOI4 等）的脚本语言、本地化语言、CSV 语言提供全功能 IDE 支持，并通过自定义的 CWT 规则系统驱动语义理解。

---

## 二、代码规模

### 2.1 源代码统计

| 范围 | 语言 | 文件数 | 总行数 | 代码行数（非空行） | 最大单文件行数 |
|------|------|--------|--------|---------------------|----------------|
| src（全部） | Kotlin | 2,016 | 152,552 | 133,978 | 1,508 |
| src（全部） | Java | 157 | 16,323 | 13,559 | 1,180 |
| **src 合计** | **—** | **2,173** | **168,875** | **147,537** | **—** |
| src/main | Kotlin | 1,849 | 131,669 | 115,920 | 1,508 |
| src/main | Java | 157 | 16,323 | 13,559 | 1,180 |
| **生产代码合计** | **—** | **2,006** | **147,992** | **129,479** | **—** |
| src/test | Kotlin | 167 | 20,883 | 18,058 | 652 |

- **总代码量约 14.8 万行**（生产代码），属于**大型单体插件项目**。
- Java 文件主要为 JFlex/BNF 生成的词法/语法解析器代码（157 个文件）。
- Kotlin 平均文件行数 71 行（生产端），说明**模块拆分粒度较细**。
- 测试代码 167 个文件 / 1.8 万行，测试覆盖率相对有限。

### 2.2 CWT 规则文件统计

| 游戏 | 文件数 | 总行数 | 代码行数 | 最大单文件行数 |
|------|--------|--------|----------|----------------|
| core | 10 | 596 | 555 | 317 |
| stellaris | 163 | 41,537 | 37,238 | 9,536 |
| vic3 | 189 | 32,164 | 28,710 | 5,082 |
| eu5 | 158 | 35,447 | 30,892 | 5,577 |
| eu4 | 75 | 33,366 | 28,973 | 5,904 |
| hoi4 | 110 | 33,120 | 29,752 | 3,858 |
| ck3 | 102 | 22,388 | 19,861 | 7,720 |
| ck2 | 80 | 21,258 | 17,496 | 3,787 |
| ir | 83 | 11,745 | 10,054 | 3,461 |
| vic2 | 43 | 3,254 | 2,925 | 475 |
| **合计** | **~1,013** | **~234,875** | **~205,456** | **—** |

- CWT 规则文件本身合计约 **23.5 万行**，超过了插件代码量。
- 涵盖 **9 款游戏 + 1 个 core 公共模块**，每款游戏都有独立的完整规则集。
- 单个规则文件最大可达 9,536 行（stellaris），说明部分游戏的规则系统极为复杂。

---

## 三、架构复杂度

### 3.1 插件配置文件结构

plugin.xml 通过 `xi:include` 引入 **15 个子配置文件**，另有 **3 个可选依赖配置文件**，共计 **18 个 XML 配置文件**：

| 文件 | 职责 | 行数 | 复杂度评级 |
|------|------|------|------------|
| plugin.xml | 入口，声明依赖与 include | 34 | 低 |
| pls-lang.xml | **核心语言服务层**（搜索、补全、导航、重构、索引、提示、层级、差异比较等） | 666 | **极高** |
| pls-ep.xml | **自定义扩展点与实现注册** | 281 | **极高** |
| pls-inspections.xml | 代码检查 | 348 | 高 |
| pls-intentions.xml | 意图动作 | 190 | 中 |
| pls-inject.xml | 字节码注入 / 代码注入器 | 82 | 高 |
| pls-images.xml | DDS/TGA 图片支持与转换 | 86 | 中 |
| pls-script.xml | Paradox Script 语言基础设施 | 59 | 中 |
| pls-localisation.xml | Paradox Localisation 语言基础设施 | 76 | 中 |
| pls-cwt.xml | CWT 语言基础设施 | 43 | 低 |
| pls-csv.xml | Paradox CSV 语言基础设施 | 27 | 低 |
| pls-config.xml | 规则组管理与同步 | 31 | 低 |
| pls-ai.xml | AI 辅助（翻译/润色） | 56 | 低 |
| pls-tools.xml | 工具菜单整合（启动游戏、生成规则等） | 60 | 中 |
| pls-extensions.xml | 扩展设置 | 7 | 低 |
| pls-integrations.xml | 外部工具集成（ImageMagick、Tiger 等） | 27 | 低 |
| pls-extension-markdown.xml | Markdown 集成（可选） | 16 | 低 |
| pls-extension-diagram.xml | 图表支持（可选） | 34 | 中 |
| pls-extension-translation.xml | 翻译插件集成（可选） | 6 | 低 |

### 3.2 关键指标汇总

| 维度 | 数量 | 说明 |
|------|------|------|
| **支持的自定义语言** | 4 | CWT、Paradox Script、Paradox Localisation、Paradox CSV |
| **自定义扩展点** | ~69 | 分布在 5 个 XML 中，主要集中在 pls-ep.xml（48）和 pls-lang.xml（14） |
| **扩展实现注册** | ~230+ | pls-ep.xml 注册了约 180 个实现，其余分散在各 XML 中 |
| **代码检查（Inspection）** | ~77 | 覆盖脚本（通用/作用域/复杂表达式/事件/内联脚本/定义注入）、本地化、CSV、覆写、Lint |
| **意图动作（Intention）** | ~40 | 覆盖 CWT/Script/Localisation/CSV + AI 辅助 |
| **内嵌提示（Inlay Hints）** | ~28 | 11 个声明式 + 14 个经典 + 3 个自定义设置 |
| **行标记（Line Marker）** | ~12 | 脚本/本地化相关的导航标记 |
| **补全贡献者** | 4 | 每种语言各一个，内部包含大量子 Provider |
| **代码注入器** | ~30 | 核心修复/功能增强/内存优化/性能优化四大类 |
| **Stub 索引** | 10 | 封装变量、本地化名称（含分区索引）、定义命名空间等 |
| **文件索引** | 7 | 规则符号、文件路径、定义、定义注入、复杂枚举值等 |
| **自定义搜索器** | 13 | 定义/本地化/封装变量/动态值/参数等维度 |
| **Action 注册** | ~90+ | 导航/重构/差异比较/操作/生成/设置/路径管理/启动游戏等 |
| **图表 Provider** | 10 | 为各游戏提供事件树/科技树图表 |
| **游戏类型** | 9 | CK2/CK3/EU4/EU5/HOI4/IR/Stellaris/VIC2/VIC3 |

---

## 四、复杂度维度分析

### 4.1 语言工程复杂度 ★★★★★

- **4 种自定义语言**，每种都需要完整的词法分析（JFlex）、语法解析（BNF/PSI）、语法高亮、代码折叠、括号匹配、注释器、格式化器、结构视图、导航栏、面包屑等基础设施。
- 脚本语言和本地化语言还需要**复杂表达式解析**（作用域字段、值字段、变量字段、数据库对象、名称格式等）。
- **参数化和内联机制**（内联脚本、参数条件、定义注入）引入了上下文相关的语义解析。

### 4.2 语义理解复杂度 ★★★★★

- 核心语义能力由 **CWT 规则系统**驱动，需要解析约 23.5 万行的规则文件。
- **作用域推断**系统需要在定义、事件、on_action 等元素之间建立调用关系并传播作用域上下文。
- **类型系统**支持定义类型/子类型/继承/互换类型，通过规则配置驱动。
- **匹配与解析框架**通过 ~69 个扩展点实现高度可插拔的表达式匹配、配置上下文推断、参数推断等。

### 4.3 索引与搜索复杂度 ★★★★☆

- 17 个自定义索引（10 Stub + 7 FileBasedIndex），覆盖定义、本地化、封装变量、内联脚本、参数等各个维度。
- 13 个自定义搜索查询，均通过扩展点机制实现。
- 支持跨模组、跨游戏文件的全局符号导航和搜索。

### 4.4 代码质量保障复杂度 ★★★★☆

- 77 个代码检查覆盖了脚本语法正确性、作用域正确性、复杂表达式正确性、事件机制正确性、内联脚本正确性、定义注入正确性、本地化规范、CSV 规范、覆写冲突等。
- 检查分为 **7 个子类别**（通用、作用域、复杂表达式、事件、内联脚本、定义注入、Lint），结构清晰但数量庞大。
- 集成外部 Lint 工具（Tiger）。

### 4.5 工具集成复杂度 ★★★☆☆

- **图片处理**：支持 DDS/TGA 文件预览、编辑器、格式转换，集成 ImageMagick/texconv。
- **翻译**：集成 Translation Plugin，AI 辅助翻译/润色（LangChain4j）。
- **Lint**：集成 Tiger 静态分析器（CK3/IR/VIC3）。
- **图表**：10 个图表 Provider，支持事件树和科技树可视化。
- **Steam 集成**：打开/复制 Steam 路径/URL、启动游戏。

### 4.6 平台对抗复杂度 ★★★★☆

- **代码注入器**（~30 个）通过字节码修改实现平台层面无法通过正常 API 达成的功能，包括：
  - 修复平台 Bug（4 个 fix 注入器）
  - 优化内存和性能（PSI 节点字段优化、缓存注入）
  - 增强功能（DDS/TGA 图片读取器、文件渲染、注入注册）
- 这种方式带来了极高的**平台版本兼容性维护成本**。

### 4.7 多游戏支持复杂度 ★★★★☆

- 支持 9 款游戏，每款游戏有独立的 CWT 规则集。
- 部分游戏有特殊机制（如 Stellaris 的名称格式表达式、科技等级、脚本化修正）需要专门的 Support 实现。
- 图表功能为每款游戏提供独立的事件树 Provider。

---

## 五、总体复杂度评估

| 维度 | 评级 |
|------|------|
| 代码规模 | ★★★★☆（14.8 万行生产代码 + 23.5 万行规则） |
| 语言工程 | ★★★★★（4 种自定义语言，完整 IDE 支持） |
| 语义理解 | ★★★★★（规则驱动 + 作用域推断 + 类型系统） |
| 架构扩展性 | ★★★★★（69 个扩展点，高度可插拔） |
| 索引与搜索 | ★★★★☆（17 个索引 + 13 个搜索器） |
| 代码检查 | ★★★★☆（77 个检查，7 个子类别） |
| 平台对抗 | ★★★★☆（~30 个代码注入器） |
| 工具集成 | ★★★☆☆（图片/翻译/AI/Lint/Steam） |
| 多游戏支持 | ★★★★☆（9 款游戏） |
| **综合评级** | **★★★★★** |

### 结论

**Paradox Language Support 是一个极高复杂度的 IntelliJ 插件项目。**

其复杂度主要体现在：

1. **自建语言工具链**：4 种自定义语言的完整 IDE 支持链路（词法 → 语法 → 语义 → 检查 → 补全 → 导航 → 重构 → 提示 → 文档），每个环节都需要深入理解 IntelliJ Platform SDK。
2. **规则驱动的语义引擎**：23.5 万行 CWT 规则文件构成了一个类似 JSON Schema 的验证/推断体系，需要在运行时解析、缓存并应用到各个语言功能中。
3. **高度可插拔的扩展架构**：69 个自定义扩展点 + 230+ 实现注册，使得功能模块之间高度解耦但也增加了理解和维护的心智负担。
4. **平台底层改造**：代码注入器体系直接修改 IntelliJ 平台行为，带来功能提升的同时也承担了平台版本升级时的兼容性风险。
5. **领域知识深度**：开发者需要同时精通 IntelliJ 插件开发、Paradox 游戏模组脚本语言及其规则系统、作用域/触发器/效果/修正等领域概念。

在 JetBrains 插件生态中，这一复杂度等级与 Kotlin 插件、Rust 插件等一线语言插件相当，属于**社区插件中的顶级复杂度**。
