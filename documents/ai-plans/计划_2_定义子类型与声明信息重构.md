# 计划：重构与规范化定义/定义注入的子类型信息和声明信息

## 目标

重构 `ParadoxDefinitionInfo` 和 `ParadoxDefinitionInjectionInfo` 中子类型信息（subtypeConfigs）和声明信息（declaration）的获取与缓存机制，使其符合 manager → service 的分层架构规范。

## 核心变更

### 1. ParadoxDefinitionInfo

- **`name`**：从 `by lazy { name0 ?: doGetName() }` 改为构造器属性 `val name: String`。移除 `name0` 参数。
- **`subtypeConfigs`**：从 `by lazy` 改为计算属性 `get() = getSubtypeConfigs()`。移除 `subtypeConfigs0` 参数。
- **`declaration`**：从 `by lazy` 改为计算属性 `get() = getDeclaration()`。
- **移除内部缓存**：删除 `subtypeConfigsCache` 和 `declarationConfigsCache`（ConcurrentHashMap）。
- **`getSubtypeConfigs(options)` / `getDeclaration(options)`**：委托给 `ParadoxDefinitionManager`。
- 可移除 `UserDataHolderBase` 基类（内部缓存移除后不再需要）。

### 2. ParadoxDefinitionService

- **`resolveInfo`**：在构造 info 前先调用 `resolveName` 解析 name，传入构造器。
- **新增 `getDeclarationModificationTracker(definitionInfo)`**：返回子类型/声明所依赖的 ModificationTracker。
  - 依赖：类型规则的路径模式匹配的脚本文件 + 内联脚本文件（+ 继承相关 tracker）。
  - 实现：基于 `typeConfig.paths` 构建 `FilePathBasedModificationTracker`，合并 `InlineScripts` tracker。

### 3. ParadoxDefinitionManager

- **简化 `getInfo`**：仅依赖 file（定义信息本身不需要依赖子类型/声明的变更追踪器）。
- **新增 `getSubtypeConfigs(definitionInfo, options)`**：
  - options 为 null/default → 经过 PSI 上的 CachedValue 缓存，依赖 `getDeclarationModificationTracker`。
  - options 非 default → 直接解析，不缓存。
- **新增 `getDeclaration(definitionInfo, options)`**：同上模式。
- **新增 Keys**：`cachedDefinitionSubtypeConfigs`、`cachedDefinitionDeclaration`。

### 4. ParadoxDefinitionInjectionInfo

- **`subtypeConfigs`** / **`declaration`**：保持委托给 `ParadoxDefinitionInjectionManager`。
- **`getSubtypeConfigs(options)` / `getDeclaration(options)`**：同上委托。

### 5. ParadoxDefinitionInjectionManager

- **实现 `getSubtypeConfigs`**（当前为 TODO 2.1.3）：
  - 通过目标定义（`ParadoxDefinitionSearch.searchProperty`）获取 definitionInfo，再取其 subtypeConfigs。
  - options 为 null/default → 缓存，否则不缓存。
- **实现 `getDeclaration`**：添加缓存逻辑，同上模式。
- **新增 Keys**：`cachedDefinitionInjectionSubtypeConfigs`、`cachedDefinitionInjectionDeclaration`。

### 6. ParadoxDefinitionInjectionService

- **新增 `resolveSubtypeConfigs`**：从目标定义获取子类型信息。
- **`resolveDeclaration`**：保持现有逻辑，但使用解析的 subtypeConfigs。

## 缓存依赖关系

| 缓存项 | 依赖 |
|---|---|
| definitionInfo | file |
| subtypeConfigs (default options) | element + declarationModificationTracker |
| declaration (default options) | element + declarationModificationTracker |
| definitionInjectionInfo | file |
| injection subtypeConfigs | element + declarationModificationTracker |
| injection declaration | element + declarationModificationTracker |

## ModificationTracker 构建

`declarationModificationTracker` 基于：
1. 类型规则的 `paths` → 构建路径模式（如 `common/events/**/*.txt`）→ `ScriptFile(pattern)`
2. `ParadoxModificationTrackers.InlineScripts`
3. 继承相关的 tracker（`getModificationTrackerFromInherit`）
4. 合并为 `MergedModificationTracker`

## 执行顺序

1. 修改 `ParadoxDefinitionInfo`（构造器、计算属性、移除内部缓存）
2. 修改 `ParadoxDefinitionService.resolveInfo`（提前解析 name）
3. 修改 `ParadoxDefinitionService`（新增 `getDeclarationModificationTracker`）
4. 修改 `ParadoxDefinitionManager`（简化 getInfo、新增 getSubtypeConfigs/getDeclaration）
5. 修改 `ParadoxDefinitionInjectionInfo`（调整委托）
6. 修改 `ParadoxDefinitionInjectionManager`（实现完整逻辑）
7. 修改 `ParadoxDefinitionInjectionService`（新增 resolveSubtypeConfigs）
8. 编译验证 & 运行测试
