# 计划_1_内联脚本定义声明支持

## 概述
为 PLS 实现“支持内联脚本文件（inline_script）中的定义声明”的能力。该能力应使通过内联脚本间接声明的定义在 IDE 中具备与直接定义一致的解析、索引与导航体验。

详见需求笔记：`documents/ai-notes/features/需求：支持内联脚本文件中的定义声明.md`。

## 目标
- **Must**：识别并索引内联脚本间接声明的定义（支持传参与模板常量两种命名来源）。
- **Must**：集成到 `ParadoxDefinitionManager` 的查询路径中，保证跳转/查找用法/结构视图可用。
- **Should**：最小表达式替换，不实现完整运行时求值。
- **Should**：保持与现有存根索引兼容，采用双索引 + 查询期联结方案。

## 里程碑与任务

- M1 需求沉淀（完成）
  - [x] 创建需求笔记并确定首选方案（A：双索引 + 查询期联结）。
  - [ ] 明确路径归一化与占位符模型（`scriptPath` 规格、`NamePart` 结构）。

- M2 索引骨架
  - [ ] 设计 `InlineScriptTemplateIndex` 数据结构与序列化格式。
  - [ ] 设计 `InlineScriptUsageIndex` 数据结构与序列化格式。
  - [ ] 实现两类 FileBasedIndex 的索引器与数据外化器（不接入查询）。
  - [ ] 添加基础单元测试（索引构建与读取）。

- M3 查询联结与缓存
  - [ ] 在 `ParadoxDefinitionManager` 增加联结查询路径，产出合成定义信息。
  - [ ] 基于 Guava Cache 实现结果缓存（`maximumSize(4096) + expireAfterAccess(10m)`）。
  - [ ] 增补单元/集成测试（名称替换、边界：缺参/空参/多占位符）。

- M4 IDE 能力接入
  - [ ] 导航目标与结构视图集成（模板 `id` 区间为主定位）。
  - [ ] QuickDoc/提示中注明“来自内联脚本”。

- M5 稳定与性能
  - [ ] 大项目样本性能采样与回归。
  - [ ] 风险与回退策略验证（联结失败/信息不足不产生命名合成定义）。

## 技术要点
- 路径归一化：去 `common/inline_scripts/` 前缀、统一分隔符、小写、忽略 `.txt` 后缀、保留子目录。
- 占位符模型：将 `$VAR$` 识别为占位符，名称由调用点参数 `VAR = value` 替换；其余为字面量片段。
- 数据模型：`InlineScriptTemplateInfo` / `InlineScriptUsageInfo` / `InlineResolvedDefinitionInfo`（查询期合成）。

## 测试清单
- 单元：模板索引、调用索引、名称解析（占位符替换）。
- 集成：从调用点跳转到模板 `id`；通过引用名找到合成定义；结构视图显示正确。
- 规范：遵循 `t_syntax_*` / `t_{gameType}_syntax_*` 命名约定。

## 风险与回退
- 路径不一致导致无法联结：提供诊断日志并回退到“仅模板能力”。
- 多定义/多占位符：最小替换 + 全量枚举策略，必要时提示不确定性。

## 参考
- `icu.windea.pls.model.ParadoxDefinitionInfo`
- `icu.windea.pls.lang.util.ParadoxDefinitionManager`
- `icu.windea.pls.lang.util.ParadoxInlineScriptManager`
- `icu.windea.pls.lang.util.ParadoxExpressionManager`
- 需求笔记：`documents/ai-notes/features/需求：支持内联脚本文件中的定义声明.md`
