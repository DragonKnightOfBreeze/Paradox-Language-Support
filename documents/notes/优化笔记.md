# 优化笔记

## 索引时

> 以下是对Stellaris游戏目录进行一次完整的索引之后的统计数据

### 测试#1 2024/8/29 V1.3.20

#### 性能优化

```
icu.windea.pls.lang.index.ParadoxFileBasedIndex.buildFileData(PsiFile) - 300.941s
icu.windea.pls.lang.index.ParadoxExpressionIndex.indexData(PsiFile, Map) - 300.941s
icu.windea.pls.lang.index.ParadoxExpressionIndex.indexDataForScriptFile(ParadoxScriptFile, Map) - 296.040s
icu.windea.pls.script.psi.impl.ParadoxScriptPsiImplUtil.getReferences(PsiElement) - 188.480s
icu.windea.pls.ep.index.ParadoxDynamicValueIndexSupport.indexScriptElement(PsiElement, Map) - 185.980s
icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 163.636s
icu.windea.pls.script.references.ParadoxScriptExpressionReferenceProvider.getReferencesByElement(PsiElement, ProcessingContext) - 131.825s
icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigContext(PsiElement) - 57.743s
icu.windea.pls.lang.index.ParadoxExpressionIndex.indexDataForLocalisationFile(ParadoxLocalisationFile, Map) - 4.841s
```

#### 内存优化

```
Class Count Shallow Retained
icu.windea.pls.localisation.psi.ParadoxLocalisationFile 168 10.75KB 23.88MB
icu.windea.pls.config.configGroup.CwtConfigGroup 11 instances 11 440B 23.49MB
icu.windea.pls.script.psi.ParadoxScriptFile 33 instances 33 2.11KB 10.4MB
icu.windea.pls.model.ParadoxFileInfo 32,696 instances 32696 1.05MB 9.46MB
```

### 测试#2 2025/3/10 V1.3.31

#### 性能优化

```
icu.windea.pls.lang.index.ParadoxFileBasedIndex.buildFileData(PsiFile) - 170.987s, 56% of all
-icu.windea.pls.lang.index.ParadoxMergedIndex.indexData(PsiFile, Map) - 162.223s
--icu.windea.pls.lang.util.ParadoxDefinitionManager.doGetInfo(ParadoxScriptDefinitionElement, PsiFile) - 10.640s, 6% of all
---icu.windea.pls.lang.util.ParadoxDefinitionManager.getMatchedTypeConfig(ParadoxScriptDefinitionElement, CwtConfigGroup, ParadoxPath, String, ParadoxExpressionPath) - 14.938s, 80%
----icu.windea.pls.lang.util.ParadoxDefinitionManager.matchesType(ParadoxScriptDefinitionElement, CwtTypeConfig, CwtConfigGroup, ParadoxPath, String, ParadoxExpressionPath) - 11.580s, 62.1%
-----icu.windea.pls.config.util.CwtConfigManager.matchesFilePath(CwtPathMatchableConfig, ParadoxPath) - 9.888s, 53%
---icu.windea.pls.lang.util.ParadoxExpressionPathManager.get(PsiElement, int) - 2.310s, 12.4%
--icu.windea.pls.ep.index.ParadoxDynamicValueIndexInfoSupport.indexScriptElement(PsiElement, Map) - 91.551s, 30% of all
---icu.windea.pls.script.references.ParadoxScriptExpressionReferenceProvider.getReferencesByElement(PsiElement, ProcessingContext) - 58.020s, 63.4%
----icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 50.832s, 86.4%
icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 80.734s, 27% of all
```

关键点：

```
icu.windea.pls.ep.index.ParadoxDynamicValueIndexInfoSupport.indexScriptElement(PsiElement, Map) - 91.551s
-icu.windea.pls.script.references.ParadoxScriptExpressionReferenceProvider.getReferencesByElement(PsiElement, ProcessingContext) - 58.846s

icu.windea.pls.lang.util.ParadoxDefinitionManager.getMatchedTypeConfig(ParadoxScriptDefinitionElement, CwtConfigGroup, ParadoxPath, String, ParadoxExpressionPath) - 14.938s
icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 80.734s
icu.windea.pls.lang.util.ParadoxExpressionMatcher.matches(PsiElement, ParadoxDataExpression, CwtDataExpression, CwtConfig, CwtConfigGroup, int) - 16.314s
```

优化思路：

- 在`ParadoxScriptExpressionReferenceProvider`与`ParadoxLocalisationExpressionReferenceProvider`中使用缓存数据（`CachedValue`）
- 如果需要获取的仅是脚本或者本地化的表达式的引用列表，考虑使用`ParadoxExpressoinManager.getExpressionReferences`，而非`PsiElement.references`
- 预计节省的索引时间：22s, 13% of all

### 测试#3 2025/3/11 V1.3.31

#### 性能优化

```
icu.windea.pls.lang.index.ParadoxFileBasedIndex.buildFileData(PsiFile) - 214.115s, 55% of all
-icu.windea.pls.lang.index.ParadoxMergedIndex.indexData(PsiFile, Map) - 202.028s, 94.4%
--icu.windea.pls.ep.index.ParadoxIndexInfoSupport.indexScriptElement(PsiElement) - 131.851s
---icu.windea.pls.ep.index.ParadoxDynamicValueIndexInfoSupport.indexScriptElement(PsiElement) - 73.066s
----icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int)
---icu.windea.pls.ep.index.ParadoxParameterIndexInfoSupport.indexScriptElement(PsiElement) - 45.655s
--icu.windea.pls.lang.util.ParadoxDefinitionManager.getInfo(ParadoxScriptDefinitionElement) - 28.205s, 13.2%
--icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 34.456s, 16.1%
-icu.windea.pls.lang.index.ParadoxInlineScriptUsageIndex.indexData(PsiFile, Map) - 12.070s, 5.6%
icu.windea.pls.lang.util.ParadoxDefinitionManager.createStub(LighterAST, LighterASTNode, StubElement<?>) - 21.441s, 5.49% of all
-icu.windea.pls.lang.util.ParadoxDefinitionManager.getMatchedTypeConfig(LighterASTNode, LighterAST, CwtConfigGroup, ParadoxPath, String, ParadoxExpressionPath) - 16.133%, 75.2%
--icu.windea.pls.config.util.CwtConfigManager.matchesFilePath(CwtPathMatchableConfig, ParadoxPath) - 10.459%, 48.8%
-icu.windea.pls.lang.util.ParadoxExpressionPathManager.get(LighterASTNode, LighterAST, VirtualFile, int) - 2.491s - 11.6%
icu.windea.pls.lang.index.ParadoxFileLocaleIndex.getIndexer$lambda$0(FileContent) - 9.746s, 2.49% of all
```

关键点：

```
icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 95.551s - 24% of all
-icu.windea.pls.ep.configContext.CwtBaseConfigContextProvider.getContext(ParadoxScriptMemberElement, ParadoxExpressionPath, PsiFile) - 7.594s
icu.windea.pls.lang.util.ParadoxDefinitionManager.getInfo(ParadoxScriptDefinitionElement) - 32.059s, 8% of all
-icu.windea.pls.lang.util.ParadoxDefinitionManager.doGetInfo(ParadoxScriptDefinitionElement, PsiFile) - 24.878s, 77.6%
--icu.windea.pls.lang.util.ParadoxDefinitionManager.getMatchedTypeConfig(ParadoxScriptDefinitionElement, CwtConfigGroup, ParadoxPath, String, ParadoxExpressionPath) - 19.369s, 60.4%
---icu.windea.pls.config.util.CwtConfigManager.matchesFilePath(CwtPathMatchableConfig, ParadoxPath)
--icu.windea.pls.lang.util.ParadoxExpressionPathManager.get(PsiElement, int) - 3.440s, 10.7%
icu.windea.pls.config.util.CwtConfigManager.matchesFilePath(CwtPathMatchableConfig, ParadoxPath) - 26.130s, 7% of all
```

最终需要考虑优化的地方：

```
icu.windea.pls.config.util.CwtConfigManager.matchesFilePath(CwtPathMatchableConfig, ParadoxPath)
```

优化思路：

- 考虑如何更快速地匹配规则（定义或者复杂枚举的）与文件路径
- 考虑把`CwtPathMatchableConfig`中的`Set<String>`替换成`Array<String>`，预计节省的时间：7s, 30%

### 测试#4 2025/9/2 V2.0.2

#### 性能优化

```
icu.windea.pls.lang.index.ParadoxFileBasedIndex.buildFileData(PsiFile) - 49.153s
-icu.windea.pls.ep.index.ParadoxDynamicValueIndexInfoSupport.indexScriptElement(PsiElement, Map) - 31.073s, 63.22% of root
-icu.windea.pls.ep.index.ParadoxComplexEnumValueIndexInfoSupport.indexScriptElement(PsiElement, Map) - 2.8s 
-icu.windea.pls.lang.util.ParadoxDefinitionManager.doGetInfo(ParadoxScriptDefinitionElement, PsiFile) - 3.440s, 7% of root
# 结论：索引动态值太过耗时

icu.windea.pls.ep.index.ParadoxDynamicValueIndexInfoSupport.indexScriptElement(PsiElement, Map) - 31.073s
-icu.windea.pls.lang.util.ParadoxExpressionManager.getExpressionReferences(ParadoxExpressionElement) - 30.573s
--icu.windea.pls.lang.util.ParadoxExpressionManager.doGetExpressionReferencesFromCache(ParadoxScriptExpressionElement) - 30.513s
---icu.windea.pls.lang.util.ParadoxExpressionManager.doGetExpressionReferences(ParadoxScriptExpressionElement) - 28.393s
----icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 24.693s
-----icu.windea.pls.lang.util.ParadoxExpressionManager.doGetConfigs(PsiElement, boolean, int) - 22.9933s
----icu.windea.pls.core.PlatformExtensionsKt.collectReferences(PsiReference) - 3.16s
# 结论：可能需要考虑更好的方式来在索引时收集动态值

icu.windea.pls.ep.index.ParadoxComplexEnumValueIndexInfoSupport.indexScriptElement(PsiElement, Map) - 2.8s
-icu.windea.pls.lang.util.ParadoxComplexEnumValueManager.getInfo(ParadoxScriptStringExpressionElement) - 2.6s
--icu.windea.pls.lang.util.ParadoxComplexEnumValueManager.doGetInfoFromCache(ParadoxScriptStringExpressionElement) - 2.58s
---icu.windea.pls.lang.util.ParadoxComplexEnumValueManager.doGetInfo(ParadoxScriptStringExpressionElement, PsiFile) - 0.86s
----icu.windea.pls.lang.util.ParadoxComplexEnumValueManager.getMatchedComplexEnumConfig(ParadoxScriptStringExpressionElement, CwtConfigGroup, ParadoxPath) - 0.54s
# 结论：无法进一步优化

icu.windea.pls.lang.util.ParadoxDefinitionManager.doGetInfo(ParadoxScriptDefinitionElement, PsiFile) -3.440s
-icu.windea.pls.script.psi.impl.ParadoxScriptPropertyImpl.getName - 0.9s
-icu.windea.pls.lang.util.ParadoxExpressionPathManager.get - 0.7s
-icu.windea.pls.lang.util.ParadoxDefinitionManager.getMatchedTypeConfig - 0.5s
# 结论：没有必要

icu.windea.pls.lang.util.ParadoxExpressionManager.doGetConfigs(PsiElement, boolean, int) - 24.393s
-icu.windea.pls.config.configContext.CwtConfigContext.getConfigs(int) - 11.753s
--icu.windea.pls.config.configContext.CwtConfigContext.doGetConfigs(int) - 8.173s
---icu.windea.pls.ep.configContext.InlineScriptCwtConfigContextProvider.getConfigs(CwtConfigContext, int) - 5.833s
----icu.windea.pls.lang.util.ParadoxInlineScriptManager.doGetInferredContextConfigsFromUsages(ParadoxScriptMemberElement, CwtConfigContext, String, int) - 5.513s # 无法避免
---icu.windea.pls.ep.configContext.BaseCwtConfigContextProvider.getConfigs(CwtConfigContext, int) - 2.340s
----icu.windea.pls.lang.util.ParadoxExpressionManager.lambda 'run' in doGetConfigsForConfigContext() - 1.94s
-----icu.windea.pls.lang.util.ParadoxExpressionManager.doInlineConfigForConfigContext(ParadoxScriptMemberElement, String, boolean, CwtPropertyConfig, int) - 0.72s
--icu.windea.pls.config.configContext.CwtConfigContext.doGetCacheKey(int) - 1.68s
---icu.windea.pls.ep.configContext.BaseCwtConfigContextProvider.getCacheKey(CwtConfigContext, int) - 1.62s
----icu.windea.pls.model.ParadoxDefinitionInfo.getDeclaration(int) 0.86s # 避免调用这个方法会更好，但目前没有必要
-icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigContext(PsiElement) - 6.360s
--icu.windea.pls.ep.configContext.CwtConfigContextProvider$INSTANCE.getContext(ParadoxScriptMemberElement) - 4.94s
---icu.windea.pls.ep.configContext.CwtConfigContextProvider$INSTANCE.lambda 'firstNotNullOfOrNull' in INSTANCE() - 3.24s
----icu.windea.pls.ep.configContext.BaseCwtConfigContextProvider.getContext(ParadoxScriptMemberElement, ParadoxExpressionPath, PsiFile) - 2.28s
-----icu.windea.pls.lang.util.ParadoxDefinitionManager.doGetInfo(ParadoxScriptDefinitionElement, PsiFile)
---icu.windea.pls.lang.util.ParadoxExpressionPathManager.get$default(ParadoxExpressionPathManager, PsiElement, int, int, Object) - 1.04s
# 结论：也许可以考虑使用 Caffeine，但这也无法避免调用 doGetInferredContextConfigsFromUsages 带来的性能开销

icu.windea.pls.config.configExpression.impl.CwtDataExpressionResolverImpl.resolve(String, boolean) - 4.56s
# 结论：也许可以把 CwtMemberConfig 的 keyExpression 和 valueExpression 缓存到 userData 中，但需要确认对内存占用的影响

icu.windea.pls.ep.expression.ParadoxScriptExpressionMatcher$INSTANCE.matches(PsiElement, ParadoxScriptExpression, CwtDataExpression, CwtConfig, CwtConfigGroup, int) - 2.8s
# 结论：没有必要
```

### 测试#5 2025/11/01 v2.0.6

#### 性能优化

```
icu.windea.pls.lang.index.ParadoxFileBasedIndex.buildFileData(PsiFile) - 105.601s
-icu.windea.pls.lang.index.ParadoxMergedIndex.indexDataForScriptFile(ParadoxScriptFile, Map) - 101.283s, 95.9% of root
--icu.windea.pls.ep.index.ParadoxDynamicValueIndexInfoSupport.indexScriptElement(PsiElement, Map) - 66.817s, 63.3% of root
---icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 58.662s
---icu.windea.pls.core.PlatformExtensionsKt.collectReferences(PsiReference) - 3.482s
--icu.windea.pls.lang.util.ParadoxDefinitionManager.getInfo(ParadoxScriptDefinitionElement) - 11.823s, 11.2% of root

icu.windea.pls.lang.util.ParadoxDefinitionManager.getInfo(ParadoxScriptDefinitionElement) - 13.771s
-icu.windea.pls.lang.util.ParadoxDefinitionManager.doGetInfo(ParadoxScriptDefinitionElement, PsiFile) - 6.445s
-icu.windea.pls.lang.util.ParadoxDefinitionManager.doGetInfoFromPsi(ParadoxScriptDefinitionElement, PsiFile, String) - 3.803s
-icu.windea.pls.script.psi.impl.ParadoxScriptPropertyImpl.getName() - 1.995s - runReadAction

icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 72.091s
-icu.windea.pls.config.configContext.CwtConfigContext.getConfigs(int) - 30.382s
--icu.windea.pls.lang.util.ParadoxExpressionManager.doInlineConfigForConfigContext(ParadoxScriptMember, String, CwtPropertyConfig, int) - 8.012s
---icu.windea.pls.config.util.manipulators.CwtConfigManipulator.inlineAlias(CwtPropertyConfig, Function1) - 6.392s
----icu.windea.pls.lang.util.ParadoxModifierManager.matchesModifier(String, PsiElement, CwtConfigGroup) - 3.746s
-----icu.windea.pls.lang.util.ParadoxEconomicCategoryManager.doGetInfo(ParadoxScriptProperty) - 2.396s
---icu.windea.pls.config.util.manipulators.CwtConfigManipulator.inlineSingleAlias(CwtPropertyConfig) - 1.404s
--icu.windea.pls.config.configContext.CwtConfigContext.doGetCacheKey(int) - 4.859s
---icu.windea.pls.ep.configContext.CwtBaseConfigContextProvider.getCacheKey(CwtConfigContext, int) - 4.667s
-icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigContext(PsiElement) - 15.248s
-icu.windea.pls.config.configContext.CwtConfigContext.doGetCacheKey(int)
-icu.windea.pls.lang.match.ParadoxMatchService.matchScriptExpression(PsiElement, ParadoxScriptExpression, CwtDataExpression, CwtConfig, CwtConfigGroup, int) - 9.417s
-icu.windea.pls.lang.util.ParadoxExpressionManager.optimizeMatchedConfigs(PsiElement, ParadoxScriptExpression, List, boolean, int) - 6.550s
--icu.windea.pls.lang.match.ParadoxMatchResult$LazyMatch.get(int) - 3.907s
--icu.windea.pls.lang.match.ParadoxMatchResultProvider.getPathReferenceMatchResult$lambda$17(Project, PsiElement, String, CwtDataExpression) - 2.289s
--icu.windea.pls.lang.match.ParadoxMatchResultProvider.getComplexEnumValueMatchResult$lambda$18(Project, PsiElement, String, String) - 1.591s

icu.windea.pls.lang._selectorsKt.selectFile(Object) - 9.815s
icu.windea.pls.lang._selectorsKt.selectGameType(Object) - 3.396s
```

结论：
- 如果在非必要时调用 `runReadAction`，会导致明显的耗时
  - 典型情况：获取各种领域信息时、调用 `selectFile` 和 `selectGameType` 时
- 考虑为定义类型 `resource` 和 `economic_category` 单独创建索引，或者在需要时添加缓存
- `CwtOptionDataAccessorProvider` 存在问题 - `get` 方法每次都会被调用

### 测试#6 2025/11/01 v2.0.6

#### 性能优化

```
icu.windea.pls.lang.index.ParadoxFileBasedIndex.buildFileData(PsiFile) - 110.182s
-icu.windea.pls.lang.index.ParadoxMergedIndex.indexDataForScriptFile(ParadoxScriptFile, Map) - 105.958s
--icu.windea.pls.ep.index.ParadoxDynamicValueIndexInfoSupport.indexScriptElement(PsiElement, Map) - 52.807s - 47.9% of root
---icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 45.803s
---icu.windea.pls.core.PlatformExtensionsKt.collectReferences(PsiReference) - 2.828s

icu.windea.pls.lang.util.ParadoxDefinitionManager.getInfo(ParadoxScriptDefinitionElement) - 10.283s
-icu.windea.pls.lang.util.ParadoxDefinitionManager.doGetInfo(ParadoxScriptDefinitionElement, PsiFile) - 5.780s
--icu.windea.pls.lang.util.ParadoxDefinitionManager.doGetInfoFromPsi(ParadoxScriptDefinitionElement, PsiFile, String) - 4.628s
---icu.windea.pls.lang.util.ParadoxScriptFileManager.getElementPath(PsiElement, int) - 1.942s

icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 85.762s (total time)
-icu.windea.pls.config.configContext.CwtConfigContext.getConfigs(int) - 31.719s
--icu.windea.pls.lang.util.ParadoxExpressionManager.doGetConfigsForConfigContext(ParadoxScriptMember, List, ParadoxElementPath, CwtConfigGroup, int) - 19.679s
---icu.windea.pls.lang.util.ParadoxExpressionManager.doInlineConfigForConfigContext(ParadoxScriptMember, String, CwtPropertyConfig, int) - 10.431s
----icu.windea.pls.config.util.manipulators.CwtConfigManipulator.inlineAlias(CwtPropertyConfig, Function1) - 6.449s *
----icu.windea.pls.config.util.manipulators.CwtConfigManipulator.inlineSingleAlias(CwtPropertyConfig) - 3.478s *
-icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigContext(PsiElement) - 17.209s
--icu.windea.pls.lang.util.ParadoxExpressionManager.doGetConfigContext(ParadoxScriptMember) - 12.464s
---icu.windea.pls.ep.configContext.CwtBaseConfigContextProvider.getContext(ParadoxScriptMember, ParadoxElementPath, PsiFile) - 5.918s
---icu.windea.pls.lang.util.ParadoxDefinitionManager.getInfo(ParadoxScriptDefinitionElement)
-icu.windea.pls.lang.util.ParadoxExpressionManager.optimizeMatchedConfigs(PsiElement, ParadoxScriptExpression, List, boolean, int) - 12.011s
--icu.windea.pls.lang.match.ParadoxMatchResultProvider.getComplexEnumValueMatchResult$lambda$18(Project, PsiElement, String, String) - 6.672s
---icu.windea.pls.lang.index.ParadoxFileBasedIndex.getFileData(VirtualFile, Project) - 6.073s
--icu.windea.pls.lang.match.ParadoxMatchResultProvider.getPathReferenceMatchResult$lambda$17(Project, PsiElement, String, CwtDataExpression) - 0.790s

icu.windea.pls.lang.match.ParadoxMatchService.matchScriptExpression(PsiElement, ParadoxScriptExpression, CwtDataExpression, CwtConfig, CwtConfigGroup, int) - 13.542s
-icu.windea.pls.ep.match.ParadoxCoreScriptExpressionMatcher.match(PsiElement, ParadoxScriptExpression, CwtDataExpression, CwtConfig, CwtConfigGroup, int) - 5.063s
--icu.windea.pls.lang.resolve.complexExpression.ParadoxScopeFieldExpression$Companion.resolve(String, TextRange, CwtConfigGroup) - 1.584s *
-icu.windea.pls.ep.match.ParadoxPredicateBasedScriptExpressionMatcher.match(PsiElement, ParadoxScriptExpression, CwtDataExpression, CwtConfig, CwtConfigGroup, int) - 4.355s
-icu.windea.pls.ep.match.ParadoxConstantScriptExpressionMatcher.match(PsiElement, ParadoxScriptExpression, CwtDataExpression, CwtConfig, CwtConfigGroup, int) - 1.775s

icu.windea.pls.ep.config.CwtInjectedConfigProvider$INSTANCE.injectConfigs(CwtMemberConfig, List) - 2.566s

icu.windea.pls.lang.index.ParadoxIndexInfoType.findInfos(VirtualFile, Project) - 6.76s
```

结论：
- 合并索引中的索引信息的读写不可避免地会导致一定的耗时，是否可以继续优化呢……（`ParadoxIndexInfoType.findInfos`）
- 规则的匹配与解析逻辑不可避免地会导致一定的耗时，也许可以通过更好的缓存方案来优化（`ParadoxExpressionManager.getConfigs`）
- 也许可以一定程度上缓存复杂表达式，但是这并非性能痛点
- 也许可以考虑优化规则注入的实现方式（`CwtInjectedConfigProvider`）

## 解析时

### 测试#1 2025/11/02 v2.0.6

#### 性能优化

```
(cpu time)

icu.windea.pls.lang.search.ParadoxParameterSearcher.processQuery(Object, Processor) - 9.786s
-icu.windea.pls.lang.index.ParadoxIndexInfoType.findInfos(VirtualFile, Project)
icu.windea.pls.lang.search.ParadoxComplexEnumValueSearcher.processQuery(Object, Processor) - 32.245s
-icu.windea.pls.lang.index.ParadoxIndexInfoType.findInfos(VirtualFile, Project)
icu.windea.pls.lang.index.ParadoxIndexInfoType.findInfos(VirtualFile, Project) - 42.031s
-icu.windea.pls.lang.index.ParadoxMergedIndex.readData(DataInput) - 17.011s *
--icu.windea.pls.ep.index.ParadoxInferredScopeContextAwareDefinitionIndexInfoSupport.readData(DataInput, ParadoxIndexInfo, ParadoxGameType) - 4.911s
--icu.windea.pls.ep.index.ParadoxDynamicValueIndexInfoSupport.readData(DataInput, ParadoxIndexInfo, ParadoxGameType) - 2.370s
--icu.windea.pls.ep.index.ParadoxEventInEventIndexInfoSupport.readData(DataInput, ParadoxIndexInfo, ParadoxGameType) - 0.975s

icu.windea.pls.lang.match.ParadoxMatchResult$LazyMatch.get(int) - 37.991s
-icu.windea.pls.lang.match.ParadoxMatchResultProvider.getComplexEnumValueMatchResult$lambda$18(Project, PsiElement, String, String) - 25.814s *
-icu.windea.pls.ep.match.ParadoxBaseScriptExpressionMatcher.match$lambda$2(CwtConfig, ParadoxScriptBlock) 6.600s *
-icu.windea.pls.lang.match.ParadoxMatchResultProvider.getDefinitionMatchResult$lambda$8(Set, String, Project, PsiElement, String) 2.220s

icu.windea.pls.lang.resolve.complexExpression.ParadoxScopeFieldExpression$Companion.resolve(String, TextRange, CwtConfigGroup) - 2.100s

icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 73.255s
-icu.windea.pls.lang.util.ParadoxExpressionManager.doGetConfigs(PsiElement, boolean, int) - 64.510s
--icu.windea.pls.lang.util.ParadoxExpressionManager.optimizeMatchedConfigs(PsiElement, ParadoxScriptExpression, List, boolean, int) - 30.356s
---icu.windea.pls.lang.match.ParadoxMatchResult$LazyMatch.get(int) - 25.556s *
----icu.windea.pls.lang.match.ParadoxMatchResultProvider.getComplexEnumValueMatchResult$lambda$18(Project, PsiElement, String, String) - 22.034s
--icu.windea.pls.config.configContext.CwtConfigContext.getConfigs(int) - 24.255s
---icu.windea.pls.config.configContext.CwtConfigContext.doGetConfigs(int) - 20.910s
----icu.windea.pls.ep.configContext.CwtBaseConfigContextProvider.getConfigs(CwtConfigContext, int) - 20.385s
-----icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigsForConfigContext(ParadoxScriptMember, List, ParadoxElementPath, CwtConfigGroup, int) - 20.355s
------icu.windea.pls.lang.util.ParadoxExpressionManager.doInlineConfigForConfigContext(ParadoxScriptMember, String, CwtPropertyConfig, int) - 8.265s *
------icu.windea.pls.lang.util.ParadoxExpressionManager.optimizeMatchedConfigs(PsiElement, ParadoxScriptExpression, List, boolean, int) - 5.820s *
---icu.windea.pls.config.configContext.CwtConfigContext.doGetCacheKey(int) - 1.275s
--icu.windea.pls.lang.match.ParadoxMatchService.matchScriptExpression(PsiElement, ParadoxScriptExpression, CwtDataExpression, CwtConfig, CwtConfigGroup, int) - 5.430s
--icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigContext(PsiElement) - 2.475s

icu.windea.pls.config.util.manipulators.CwtConfigManipulator.deepCopyConfigs(CwtMemberConfig, CwtMemberConfig) - 2.595s
-icu.windea.pls.ep.config.CwtInjectedConfigProvider$INSTANCE.injectConfigs(CwtMemberConfig, List) - 1.680s
```

结论：
- 基于合并索引的查询器，尤其是 `ParadoxComplexEnumValueSearcher`，不可避免地会导致一定的耗时，需要考虑进一步的优化方案，或者分离成多个索引
- 需要考虑优化规则注入的实现方式（`CwtInjectedConfigProvider`）
- `String.intern()` 也会导致一定的耗时，需要平衡时间开销和内存开销，但是这并非性能痛点

### 测试#2 2025/11/03 v2.0.6

#### 性能优化

```
(total time)

icu.windea.pls.lang.search.ParadoxDefinitionSearcher.processQuery(Object, Processor) - 78.444s
-[typeExpression != null && finalName != null] - 76.582s
--icu.windea.pls.lang.search.ParadoxDefinitionSearcher.matchesSubtypes(ParadoxScriptDefinitionElement, List) - 8.985s, synchronized
---icu.windea.pls.lang.util.ParadoxDefinitionManager.matchesSubtype(ParadoxScriptDefinitionElement, String, CwtSubtypeConfig, List, CwtConfigGroup, int) - 3.364s
----icu.windea.pls.lang.util.ParadoxDefinitionManager.doMatchDefinition(ParadoxScriptDefinitionElement, CwtPropertyConfig, CwtConfigGroup, int) - 3.364s
-----icu.windea.pls.script.psi.impl.ParadoxScriptPropertyImpl.getBlock() - 3.079s

icu.windea.pls.lang.search.ParadoxLocalisationSearcher.processQuery(Object, Processor) - 95.674s
-[finalName != null] - 95.351s

icu.windea.pls.lang.search.ParadoxParameterSearcher.processQuery(Object, Processor) - 5.315s
-icu.windea.pls.lang.index.PlsIndexService.processFilesWithKeys(ID, Collection, GlobalSearchScope, Processor)
icu.windea.pls.lang.search.ParadoxComplexEnumValueSearcher.processQuery(Object, Processor) - 116.196s
-icu.windea.pls.lang.index.PlsIndexService.processFilesWithKeys(ID, Collection, GlobalSearchScope, Processor)
icu.windea.pls.lang.index.PlsIndexService.processFilesWithKeys(ID, Collection, GlobalSearchScope, Processor) - 121.492s
-icu.windea.pls.lang.index.IndexInfoAwareFileBasedIndex.getFileDataWithKey(VirtualFile, Project, String) - 116.667s

icu.windea.pls.lang.match.ParadoxMatchResult$LazyMatch.get(int) - 144.228s
-icu.windea.pls.lang.match.ParadoxMatchResultProvider.getDefinitionMatchResult$lambda$8(Set, String, Project, PsiElement, String) - 71.372s
-icu.windea.pls.lang.match.ParadoxMatchResultProvider.getComplexEnumValueMatchResult$lambda$18(Project, PsiElement, String, String) - 25.095s
-icu.windea.pls.lang.match.ParadoxMatchResultProvider.getPathReferenceMatchResult$lambda$17(Project, PsiElement, String, CwtDataExpression) - 1.521s

icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 224.195s
-icu.windea.pls.lang.util.ParadoxExpressionManager.doGetConfigs(PsiElement, boolean, int) - 198.194s
--icu.windea.pls.lang.util.ParadoxExpressionManager.optimizeMatchedConfigs(PsiElement, ParadoxScriptExpression, List, boolean, int) - 143.526s
---icu.windea.pls.lang.match.ParadoxMatchResult$LazyMatch.get(int) - 140.121s
--icu.windea.pls.config.configContext.CwtConfigContext.getConfigs(int) - 33.767s
---icu.windea.pls.config.configContext.CwtConfigContext.doGetConfigs(int) - 28.542s
----icu.windea.pls.lang.util.ParadoxExpressionManager.doGetConfigsForConfigContext(ParadoxScriptMember, List, ParadoxElementPath, CwtConfigGroup, int) - 27.269s
-----icu.windea.pls.script.psi.ParadoxScriptPsiSearchExtensionsKt.findParentByPath$default(ParadoxScriptMember, String, boolean, String, int, Object) - 4.465s
------icu.windea.pls.script.psi.ParadoxScriptPsiSearchExtensionsKt.findParentProperty(PsiElement, String, boolean, boolean) - 4.199s
--icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigContext(PsiElement) - 10.375s
```

```
(cpu time)

icu.windea.pls.lang.search.ParadoxParameterSearcher.processQuery(Object, Processor) - 3.173ss
-icu.windea.pls.lang.index.PlsIndexService.processFilesWithKeys(ID, Collection, GlobalSearchScope, Processor)
icu.windea.pls.lang.search.ParadoxComplexEnumValueSearcher.processQuery(Object, Processor) - 9.975s
-icu.windea.pls.lang.index.PlsIndexService.processFilesWithKeys(ID, Collection, GlobalSearchScope, Processor)
icu.windea.pls.lang.index.PlsIndexService.processFilesWithKeys(ID, Collection, GlobalSearchScope, Processor) - 13.148s
-icu.windea.pls.lang.index.IndexInfoAwareFileBasedIndex.getFileDataWithKey(VirtualFile, Project, String) - 11.723s

icu.windea.pls.lang.match.ParadoxMatchResult$LazyMatch.get(int) - 8.740s
-icu.windea.pls.lang.match.ParadoxMatchResultProvider.getComplexEnumValueMatchResult$lambda$18(Project, PsiElement, String, String) - 4.427s
-icu.windea.pls.lang.match.ParadoxMatchResultProvider.getDefinitionMatchResult$lambda$8(Set, String, Project, PsiElement, String) - 2.280s
-icu.windea.pls.lang.match.ParadoxMatchResultProvider.getLocalisationMatchResult$lambda$12(Set, String, Project, PsiElement) - 1.349s

icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 39.331s
-icu.windea.pls.config.configContext.CwtConfigContext.getConfigs(int) - 15.847s
--icu.windea.pls.ep.configContext.CwtBaseConfigContextProvider.getConfigs(CwtConfigContext, int) - 12.313s
---icu.windea.pls.lang.util.ParadoxExpressionManager.doInlineConfigForConfigContext(ParadoxScriptMember, String, CwtPropertyConfig, int) - 6.214s
-icu.windea.pls.lang.util.ParadoxExpressionManager.optimizeMatchedConfigs(PsiElement, ParadoxScriptExpression, List, boolean, int) - 8.873s
--icu.windea.pls.lang.match.ParadoxMatchResult$LazyMatch.get(int) - 7.999s
-icu.windea.pls.lang.match.ParadoxMatchService.matchScriptExpression(PsiElement, ParadoxScriptExpression, CwtDataExpression, CwtConfig, CwtConfigGroup, int) - 2.527s
--icu.windea.pls.lang.resolve.complexExpression.impl.ParadoxScopeFieldExpressionResolverImpl.resolve(String, TextRange, CwtConfigGroup) - 0.969s
-icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigContext(PsiElement) - 2.527s

icu.windea.pls.lang.match.ParadoxMatchService.matchScriptExpression(PsiElement, ParadoxScriptExpression, CwtDataExpression, CwtConfig, CwtConfigGroup, int) - 5.472s

icu.windea.pls.lang.index.IndexInfoAwareFileBasedIndex.getFileDataWithKey(VirtualFile, Project, String) - 11.723s

icu.windea.pls.ep.config.CwtInjectedConfigProvider$INSTANCE.injectConfigs(CwtMemberConfig, List) - 1.045s
```

结论：
- 索引IO不可避免地会导致明显的耗时
- 一些复杂的匹配逻辑需要直接地、进一步地访问PSI，这也会导致一定的耗时
- 考虑优化 `ParadoxLocalisationSearcher` - 始终优先使用类型索引？

```
(total time, back trace)

icu.windea.pls.lang.search.ParadoxDefinitionSearcher.processQuery(Object, Processor) - 78.444s
↖icu.windea.pls.lang.search.ParadoxQuery.findFirst() - 71.277s
↖↖icu.windea.pls.lang.match.ParadoxMatchResultProvider.getDefinitionMatchResult$lambda$8(Set, String, Project, PsiElement, String) - 71.277s
↖icu.windea.pls.lang.search.ParadoxQuery.find() - 6.692s

icu.windea.pls.lang.search.ParadoxLocalisationSearcher.processQuery(Object, Processor) - 95.674s
↖icu.windea.pls.lang.search.ParadoxQuery.find() - 67.657s
↖↖icu.windea.pls.config.configExpression.CwtLocalisationLocationExpression$ResolveResult.getElement() - 36.873s
↖↖↖icu.windea.pls.lang.util.ParadoxDefinitionManager.doGetPrimaryLocalisation(ParadoxScriptDefinitionElement) - 35。391s
↖↖icu.windea.pls.ep.expression.ParadoxScriptLocalisationExpressionSupport.resolve(ParadoxExpressionElement, TextRange, String, CwtConfig, Boolean, boolean) - 17.174s
↖↖icu.windea.pls.lang.references.localisation.ParadoxLocalisationParameterPsiReference.doResolve() - 6.182s 
↖icu.windea.pls.lang.search.ParadoxQuery.findFirst() - 25.133s
↖↖icu.windea.pls.lang.match.ParadoxMatchResultProvider.getLocalisationMatchResult$lambda$12(Set, String, Project, PsiElement) - 25.038s

icu.windea.pls.lang.search.ParadoxComplexEnumValueSearcher.processQuery(Object, Processor) - 116.196s
↖icu.windea.pls.ep.expression.ParadoxScriptEnumValueExpressionSupport.resolve(ParadoxExpressionElement, TextRange, String, CwtConfig, Boolean, boolean) - 70.564s
↖icu.windea.pls.lang.match.ParadoxMatchResultProvider.getComplexEnumValueMatchResult$lambda$18(Project, PsiElement, String, String) - 45.632s
```

结论：
- 对于定义的索引
  - 需要评估“始终优先使用类型索引”的策略的效果
- 对于本地化的索引
  - 考虑进行更多的切片？
- 对于复杂枚举值的索引
  - 考虑预过滤枚举名？

```
com.intellij.psi.stubs.StubIndex.processElements(StubIndexKey, Object, Project, GlobalSearchScope, Class, Processor) - 172.902s
-com.intellij.psi.stubs.StubIndexEx.getContainingIds(StubIndexKey, Object, Project, IdFilter, GlobalSearchScope) - 89.718s - 这里会得到实际上用来遍历的 vFiles
--com.intellij.util.indexing.FileBasedIndexImpl.ensureUpToDate(ID, Project, GlobalSearchScope, VirtualFile) - 86.620s
---com.intellij.util.indexing.FileBasedIndexImpl.forceUpdate(Project, ProjectFilesCondition, VirtualFile) - 89.628s
---com.intellij.util.indexing.UpdateTask.processAll(Collection, Project) - 78.186s
----com.intellij.util.concurrency.Semaphore.waitFor(long) - 76.400s - 强制更新/锁/IO - 约束 `ProjectIndexableFilesFilter` 可能可以缩短耗时
-java.util.concurrent.ConcurrentHashMap.computeIfAbsent(Object, Function) - 49.263s
--com.intellij.psi.stubs.StubIndexEx.lambda$processElements$7(StubIndexKey, Object, VirtualFile, Project, boolean, StubIndexEx$KeyAndFileId) - 42.362s
---com.intellij.psi.stubs.StubProcessingHelper.retrieveStubIdList(StubIndexKey, Object, VirtualFile, Project, boolean) - 42.362s
----com.intellij.psi.stubs.SerializedStubTree.restoreIndexedStubs(StubIndexKey, Object) - 32.346s
-----com.intellij.psi.stubs.StubForwardIndexExternalizer.deserializeIndexValue - 32.308s
------com.intellij.openapi.progress.ProgressManager.checkCanceled() - 28.356s - `indexDis` 过大，循环了很多次，循环中的取消检查也进行了很多次
------it.unimi.dsi.fastutil.objects.Object2ObjectOpenCustomHashMap.put(Object, Object) 2.812s
----com.intellij.indexing.composite.CompositeInvertedIndexBase.getIndexedFileData(int) - 9.997s - 这里才是真正获取缓存的索引数据 - 取消检查/锁/IO/压缩
--java.util.concurrent.ConcurrentHashMap$ReservationNode.<init>() - 6.540s
-com.intellij.psi.stubs.StubIndexEx.lambda$processElements$6(Project, Processor, GlobalSearchScope, Class, Object, StubIndexKey, VirtualFile, StubIdList) - 33.313s
--com.intellij.psi.stubs.StubProcessingHelperBase.processStubsInFile(Project, VirtualFile, StubIdList, Processor, GlobalSearchScope, Class, Computable) - 33.294s
---icu.windea.pls.lang.index.PlsIndexService$sam$i$com_intellij_util_Processor$0.process(Object) - 20.035s - 后置的过滤逻辑 - 取消检查/获取存根/访问PSI
----icu.windea.pls.lang.util.ParadoxDefinitionManager.matchesSubtype(ParadoxScriptDefinitionElement, String, CwtSubtypeConfig, List, CwtConfigGroup, int) - 3.364s
-----icu.windea.pls.script.psi.impl.ParadoxScriptPropertyImpl.getBlock() - 3.079s
---com.intellij.psi.stubs.StubProcessingHelperBase.getAllSpines(PsiFile) - 10.219s - 构建存根树
```

结论：
- 约束最终查询索引时使用的 searchScope 可以降低耗时（`com.intellij.psi.stubs.StubIndexEx.processElements`，L199，125s -> ? / 173s）

#### 内存优化

打开了数个事件脚本文件后，再打开一个过大的事件脚本文件（>=2万行），能够明显感觉到性能问题。
- 存在明显的卡顿，分析需要很久或者反复重新开始
- 同样拥有很高的CPU占用
- 怀疑存在内存泄露？
- 怀疑完成完整的分析需要的内存超出上限？
- 怀疑存在无法完成，反复重新开始的读操作？
- 如果关闭此脚本文件，再打开其他脚本文件，影响仍然存在
- 如果只是打开这一个脚本文件，尽管分析明显需要更长的时间，但是并不会有明显的性能问题
- 需要分析代码中是否存在内存泄露，或者未及时失效的缓存

### 测试#3 2025/11/03 v2.0.6

```
(total time)

icu.windea.pls.lang.search.ParadoxDefinitionSearcher.processQuery(Object, Processor) - 88.728s
-icu.windea.pls.lang.search.ParadoxDefinitionSearcher.processQueryForStubDefinitions - 88.293s
--[typeExpression != null && finalName != null && constraint = null] - 87.942s, 99.114% - 似乎使用类型索引的话耗时更长了，并且在后置过滤上花了更多时间
--com.intellij.psi.stubs.StubIndexEx.lambda$processElements$6(Project, Processor, GlobalSearchScope, Class, Object, StubIndexKey, VirtualFile, StubIdList) - 59.270s, 66.8%
---icu.windea.pls.lang.index.PlsIndexService$sam$i$com_intellij_util_Processor$0.process(Object) - 31.857s
----icu.windea.pls.lang.search.ParadoxDefinitionSearcher.matchesName(ParadoxScriptDefinitionElement, String, boolean) - 17.222s, 19.4%
-----com.intellij.extapi.psi.StubBasedPsiElementBase.getGreenStub() - 12.231s
------com.intellij.openapi.progress.ProgressIndicatorProvider.checkCanceled() - 11.206s
----icu.windea.pls.lang.search.ParadoxDefinitionSearcher.matchesSubtypes(ParadoxScriptDefinitionElement, List) - 2.407s, 2.7%
---com.intellij.psi.stubs.StubProcessingHelperBase.getAllSpines(PsiFile) - 19.541s
--com.intellij.psi.stubs.StubIndexEx.getContainingIds(StubIndexKey, Object, Project, IdFilter, GlobalSearchScope) - 25.044s, 28.2%
---com.intellij.util.indexing.FileBasedIndexImpl.ensureUpToDate(ID, Project, GlobalSearchScope, VirtualFile) - 24.792, 27.9%
--java.util.concurrent.ConcurrentHashMap.computeIfAbsent(Object, Function) - 2.983s
---com.intellij.psi.stubs.StubProcessingHelper.retrieveStubIdList(StubIndexKey, Object, VirtualFile, Project, boolean) - 1.290s

icu.windea.pls.lang.search.ParadoxLocalisationSearcher.processQuery(Object, Processor) - 38.368s
-icu.windea.pls.lang.search.ParadoxLocalisationSearcher.processQueryForLocalisations(String, Project, GlobalSearchScope, ParadoxIndexConstraint, Processor) - 38.284s
--java.util.concurrent.ConcurrentHashMap.computeIfAbsent(Object, Function) - 26.327s
---com.intellij.psi.stubs.StubProcessingHelper.retrieveStubIdList(StubIndexKey, Object, VirtualFile, Project, boolean) - 22.327s, 58.2%
--com.intellij.psi.stubs.StubIndexEx.getContainingIds(StubIndexKey, Object, Project, IdFilter, GlobalSearchScope) - 8.530s, 22.2%
--com.intellij.psi.stubs.StubIndexEx.lambda$processElements$6(Project, Processor, GlobalSearchScope, Class, Object, StubIndexKey, VirtualFile, StubIdList) - 2.527s, 6.6%
---com.intellij.psi.stubs.StubProcessingHelperBase.getAllSpines(PsiFile) - 1.094s
---icu.windea.pls.lang.index.PlsIndexService$sam$i$com_intellij_util_Processor$0.process(Object) - 1.027s

icu.windea.pls.lang.search.ParadoxComplexEnumValueSearcher.processQuery(Object, Processor) - 15.315s
-icu.windea.pls.lang.index.PlsIndexService.processFilesWithKeys(ID, Collection, GlobalSearchScope, Processor) - 15.287s
--icu.windea.pls.lang.index.IndexInfoAwareFileBasedIndex.getFileDataWithKey(VirtualFile, Project, String) - 14.768s
---com.intellij.util.indexing.FileBasedIndexEx.processValuesInOneFile(ID, Object, VirtualFile, GlobalSearchScope, FileBasedIndex$ValueProcessor) - 14.586s - 考虑使用 fast-return-procssor，预计可以节省至少2s耗时（取消检查）
----com.intellij.util.indexing.FileBasedIndexEx.lambda$processValuesInOneFile$8(int, FileBasedIndex$ValueProcessor, VirtualFile, InvertedIndexValueIterator) - 13.618s
-----com.intellij.openapi.progress.ProgressManager.checkCanceled() - 11.429s
-----com.intellij.util.indexing.impl.MergedValueContainer$1.next() - 1.201s
```

### 测试#4 2025/11/03 v2.0.6

```
(total time)

icu.windea.pls.lang.search.ParadoxDefinitionSearcher.processQuery(Object, Processor) - 33.968s
-icu.windea.pls.lang.search.ParadoxDefinitionSearcher.processQueryForStubDefinitions - 32.586s, 95.9%
--[typeExpression != null && finalName != null] - 31.933s, 94.009%
--com.intellij.psi.stubs.StubIndexEx.getContainingIds(StubIndexKey, Object, Project, IdFilter, GlobalSearchScope) - 20.365s, 60.0%
---com.intellij.util.indexing.FileBasedIndexImpl.ensureUpToDate(ID, Project, GlobalSearchScope, VirtualFile) - 19.605s, 57.7%
--com.intellij.psi.stubs.StubIndexEx.lambda$processElements$6(Project, Processor, GlobalSearchScope, Class, Object, StubIndexKey, VirtualFile, StubIdList) - 9.636s, 28.4%
---icu.windea.pls.lang.index.PlsIndexService$sam$i$com_intellij_util_Processor$0.process(Object) - 7.333s, 21.6%
----icu.windea.pls.lang.search.ParadoxDefinitionSearcher.matchesSubtypes(ParadoxScriptDefinitionElement, List) - 5.911s, 17.4%
-----icu.windea.pls.model.ParadoxDefinitionInfo.getSubtypeConfigs() - 3.487s, 10.3%
------icu.windea.pls.lang.util.ParadoxDefinitionManager.doMatchDefinition(ParadoxScriptDefinitionElement, CwtPropertyConfig, CwtConfigGroup, int) - 3.484s
-------icu.windea.pls.script.psi.impl.ParadoxScriptPropertyImpl.getBlock() - 3.070s, 9.0% - 这会最终导致解析整个脚本文件的 PSI，考虑是否可以进一步优化？ - 直接通过 LighterAST 匹配子类型是可行的，但是相当复杂
---com.intellij.psi.stubs.StubProcessingHelperBase.getAllSpines(PsiFile) - 1.924s, 5.7%
--java.util.concurrent.ConcurrentHashMap.computeIfAbsent(Object, Function) - 2.243s, 6.6%

icu.windea.pls.lang.search.ParadoxLocalisationSearcher.processQuery(Object, Processor) - 55.940s
-icu.windea.pls.lang.search.ParadoxLocalisationSearcher.processQueryForLocalisations(String, Project, GlobalSearchScope, ParadoxIndexConstraint, Processor) - 55.389s, 99.0% 
--java.util.concurrent.ConcurrentHashMap.computeIfAbsent(Object, Function) - 30.289s, 54.1% - 索引数据相当多，IO耗时相当长
---com.intellij.psi.stubs.StubProcessingHelper.retrieveStubIdList(StubIndexKey, Object, VirtualFile, Project, boolean)
----com.intellij.psi.stubs.SerializedStubTree.restoreIndexedStubs(StubIndexKey, Object) - 19.501s, 34.9%
-----com.intellij.psi.stubs.StubForwardIndexExternalizer.deserializeIndexValue(DataInput, StubIndexKey, Object) - 19.444s, 34.8%
------com.intellij.openapi.progress.ProgressManager.checkCanceled() - 9.631s, 17.2% - 循环IO中的取消检查，这意味着循环了很多次
------it.unimi.dsi.fastutil.objects.Object2ObjectOpenCustomHashMap.put(Object, Object) - 9.053s, 16.2%
-------com.intellij.util.containers.CollectionFactory$1.equals(Object, Object) - 7.516s, 13.4% - 最终的耗时来自字符串相等性检查
----com.intellij.indexing.composite.CompositeInvertedIndexBase.getIndexedFileData(int) - 6.307s, 11.3%
-----com.intellij.util.io.PersistentMapImpl.get(Object) - 4.434s, 7.9%
--com.intellij.psi.stubs.StubIndexEx.getContainingIds(StubIndexKey, Object, Project, IdFilter, GlobalSearchScope) - 11.754s, 21.0%
---com.intellij.util.indexing.FileBasedIndexImpl.ensureUpToDate(ID, Project, GlobalSearchScope, VirtualFile) - 9.763s, 17.5%
--com.intellij.psi.stubs.StubIndexEx.lambda$processElements$6(Project, Processor, GlobalSearchScope, Class, Object, StubIndexKey, VirtualFile, StubIdList) - 10.812s, 19.3%
---icu.windea.pls.lang.index.PlsIndexService$sam$i$com_intellij_util_Processor$0.process(Object) - 4.558s - 取消检查/获取存根
---com.intellij.psi.stubs.StubProcessingHelperBase.getAllSpines(PsiFile) - 4.556s

icu.windea.pls.lang.search.ParadoxComplexEnumValueSearcher.processQuery(Object, Processor) - 166.742s
-icu.windea.pls.lang.index.PlsIndexService.processFilesWithKeys(ID, Collection, GlobalSearchScope, Processor) - 166.666s
--com.intellij.util.indexing.FileBasedIndexEx.processVirtualFiles(IntCollection, GlobalSearchScope, Processor) - 92.684s
---icu.windea.pls.lang.index.IndexInfoAwareFileBasedIndex.getFileDataWithKey(VirtualFile, Project, String) - 89.403s, 53.6%
----com.intellij.util.indexing.FileBasedIndexEx.processValuesInOneFile(ID, Object, VirtualFile, GlobalSearchScope, FileBasedIndex$ValueProcessor) - 86.651s, 52.0%
-----com.intellij.util.indexing.FileBasedIndexEx.lambda$processValuesInOneFile$8(int, FileBasedIndex$ValueProcessor, VirtualFile, InvertedIndexValueIterator) - 74.727s, 44.8%
------com.intellij.openapi.progress.ProgressManager.checkCanceled() - 51.544s, 30.9%
--com.intellij.util.indexing.FileBasedIndexEx.collectFileIdsContainingAnyKey(ID, Collection, GlobalSearchScope, Condition, IdFilter) - 73.982s, 44.4%
---com.intellij.util.indexing.FileBasedIndexImpl.ensureUpToDate(ID, Project, GlobalSearchScope, VirtualFile) - 72.146s, 43.3% - 更新索引的耗时
```

## 全局代码检查时

> 以下是启用插件提供的绝大部分代码检查的情况下对Stellaris游戏目录进行一次完整的全局代码检查之后的统计数据

### 测试#1 2024/8/29 V1.3.20

#### 性能优化

#### 内存优化

```
Class Count Shallow Retained
icu.windea.pls.config.configGroup.CwtConfigGroup 11 440B 44.51MB
icu.windea.pls.localisation.psi.ParadoxLocalisationFile 69 69 4.42KB 22.89MB
icu.windea.pls.model.elementInfo.ParadoxModifierInfo 4,612 147.58KB 11.32MB
icu.windea.pls.config.CwtConfigContext 23,043 921.72KB 10.15MB
icu.windea.pls.model.ParadoxFileInfo 32,696 1.05MB 9.46MB
```

## 文件解析

### CWT文件

#### 测试#1 2025/5/4 V1.4.0-PRE 

> - 重新打开Stellaris游戏目录（此后插件会在后台自动解析规则），等待1分钟，检查解析CWT文件的耗时
> - 使用优化后的parser和lexer
> - 懒解析选项注释

```
icu.windea.pls.cwt.parser.CwtParser.parse(IElementType, PsiBuilder) - 364ms, 5.6% of all
```

结论：

- 解析速度很快，不需要考虑进一步优化性能
- 经过初步测试，很快就能完成文件的重新解析
- 也许不需要懒解析选项注释？（但是懒解析应该能提高重新解析的性能）

## 兼容性

### 备注

```
since 223-EAP, call 'VfsUtil.findFile(Path, boolean)' may cause:
java.lang.Throwable: Slow operations are prohibited on EDT. See SlowOperations.assertSlowOperationsAreAllowed javadoc.
```