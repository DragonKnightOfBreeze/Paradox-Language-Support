# 优化笔记

## 索引时

> 以下是对Stellaris游戏目录进行一次完整的索引之后的统计数据

### 测试#1 2024/8/29 V1.3.20

#### 性能优化

```
icu.windea.pls.lang.index.ParadoxFileBasedIndex.buildFileData(PsiFile) - 300.941s
icu.windea.pls.lang.index.ParadoxExpressionIndex.indexData(PsiFile, Map) - 300.941s
icu.windea.pls.lang.index.ParadoxExpressionIndex.indexDataForScriptFile(ParadoxScriptFile, Map) - 296.040s
icu.windea.pls.script.psi.impl.ParadoxScriptPsiImplUtil.getReferences(PsiElement) - 188.480s
icu.windea.pls.ep.index.ParadoxDynamicValueIndexSupport.indexScriptElement(PsiElement, Map) - 185.980s
icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 163.636s
icu.windea.pls.script.references.ParadoxScriptExpressionReferenceProvider.getReferencesByElement(PsiElement, ProcessingContext) - 131.825s
icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigContext(PsiElement) - 57.743s
icu.windea.pls.lang.index.ParadoxExpressionIndex.indexDataForLocalisationFile(ParadoxLocalisationFile, Map) - 4.841s
```

#### 内存优化

```
Class Count Shallow Retained
icu.windea.pls.localisation.psi.ParadoxLocalisationFile 168 10.75KB 23.88MB
icu.windea.pls.config.configGroup.CwtConfigGroup 11 instances 11 440B 23.49MB
icu.windea.pls.script.psi.ParadoxScriptFile 33 instances 33 2.11KB 10.4MB
icu.windea.pls.model.ParadoxFileInfo 32,696 instances 32696 1.05MB 9.46MB
```

### 测试#2 2025/3/10 V1.3.31

#### 性能优化

```
icu.windea.pls.lang.index.ParadoxFileBasedIndex.buildFileData(PsiFile) - 170.987s, 56% of all
-icu.windea.pls.lang.index.ParadoxMergedIndex.indexData(PsiFile, Map) - 162.223s
--icu.windea.pls.lang.util.ParadoxDefinitionManager.doGetInfo(ParadoxScriptDefinitionElement, PsiFile) - 10.640s, 6% of all
---icu.windea.pls.lang.util.ParadoxDefinitionManager.getMatchedTypeConfig(ParadoxScriptDefinitionElement, CwtConfigGroup, ParadoxPath, String, ParadoxExpressionPath) - 14.938s, 80%
----icu.windea.pls.lang.util.ParadoxDefinitionManager.matchesType(ParadoxScriptDefinitionElement, CwtTypeConfig, CwtConfigGroup, ParadoxPath, String, ParadoxExpressionPath) - 11.580s, 62.1%
-----icu.windea.pls.config.util.CwtConfigManager.matchesFilePath(CwtPathMatchableConfig, ParadoxPath) - 9.888s, 53%
---icu.windea.pls.lang.util.ParadoxExpressionPathManager.get(PsiElement, int) - 2.310s, 12.4%
--icu.windea.pls.ep.index.ParadoxDynamicValueIndexInfoSupport.indexScriptElement(PsiElement, Map) - 91.551s, 30% of all
---icu.windea.pls.script.references.ParadoxScriptExpressionReferenceProvider.getReferencesByElement(PsiElement, ProcessingContext) - 58.020s, 63.4%
----icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 50.832s, 86.4%
icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 80.734s, 27% of all
```

关键点：

```
icu.windea.pls.ep.index.ParadoxDynamicValueIndexInfoSupport.indexScriptElement(PsiElement, Map) - 91.551s
-icu.windea.pls.script.references.ParadoxScriptExpressionReferenceProvider.getReferencesByElement(PsiElement, ProcessingContext) - 58.846s

icu.windea.pls.lang.util.ParadoxDefinitionManager.getMatchedTypeConfig(ParadoxScriptDefinitionElement, CwtConfigGroup, ParadoxPath, String, ParadoxExpressionPath) - 14.938s
icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 80.734s
icu.windea.pls.lang.util.ParadoxExpressionMatcher.matches(PsiElement, ParadoxDataExpression, CwtDataExpression, CwtConfig, CwtConfigGroup, int) - 16.314s
```

优化思路：

- 在`ParadoxScriptExpressionReferenceProvider`与`ParadoxLocalisationExpressionReferenceProvider`中使用缓存数据（`CachedValue`）
- 如果需要获取的仅是脚本或者本地化的表达式的引用列表，考虑使用`ParadoxExpressionManager.getExpressionReferences`，而非`PsiElement.references`
- 预计节省的索引时间：22s, 13% of all

### 测试#3 2025/3/11 V1.3.31

#### 性能优化

```
icu.windea.pls.lang.index.ParadoxFileBasedIndex.buildFileData(PsiFile) - 214.115s, 55% of all
-icu.windea.pls.lang.index.ParadoxMergedIndex.indexData(PsiFile, Map) - 202.028s, 94.4%
--icu.windea.pls.ep.index.ParadoxIndexInfoSupport.indexScriptElement(PsiElement) - 131.851s
---icu.windea.pls.ep.index.ParadoxDynamicValueIndexInfoSupport.indexScriptElement(PsiElement) - 73.066s
----icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int)
---icu.windea.pls.ep.index.ParadoxParameterIndexInfoSupport.indexScriptElement(PsiElement) - 45.655s
--icu.windea.pls.lang.util.ParadoxDefinitionManager.getInfo(ParadoxScriptDefinitionElement) - 28.205s, 13.2%
--icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 34.456s, 16.1%
-icu.windea.pls.lang.index.ParadoxInlineScriptUsageIndex.indexData(PsiFile, Map) - 12.070s, 5.6%
icu.windea.pls.lang.util.ParadoxDefinitionManager.createStub(LighterAST, LighterASTNode, StubElement<?>) - 21.441s, 5.49% of all
-icu.windea.pls.lang.util.ParadoxDefinitionManager.getMatchedTypeConfig(LighterASTNode, LighterAST, CwtConfigGroup, ParadoxPath, String, ParadoxExpressionPath) - 16.133%, 75.2%
--icu.windea.pls.config.util.CwtConfigManager.matchesFilePath(CwtPathMatchableConfig, ParadoxPath) - 10.459%, 48.8%
-icu.windea.pls.lang.util.ParadoxExpressionPathManager.get(LighterASTNode, LighterAST, VirtualFile, int) - 2.491s - 11.6%
icu.windea.pls.lang.index.ParadoxFileLocaleIndex.getIndexer$lambda$0(FileContent) - 9.746s, 2.49% of all
```

关键点：

```
icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 95.551s - 24% of all
-icu.windea.pls.ep.configContext.CwtBaseConfigContextProvider.getContext(ParadoxScriptMemberElement, ParadoxExpressionPath, PsiFile) - 7.594s
icu.windea.pls.lang.util.ParadoxDefinitionManager.getInfo(ParadoxScriptDefinitionElement) - 32.059s, 8% of all
-icu.windea.pls.lang.util.ParadoxDefinitionManager.doGetInfo(ParadoxScriptDefinitionElement, PsiFile) - 24.878s, 77.6%
--icu.windea.pls.lang.util.ParadoxDefinitionManager.getMatchedTypeConfig(ParadoxScriptDefinitionElement, CwtConfigGroup, ParadoxPath, String, ParadoxExpressionPath) - 19.369s, 60.4%
---icu.windea.pls.config.util.CwtConfigManager.matchesFilePath(CwtPathMatchableConfig, ParadoxPath)
--icu.windea.pls.lang.util.ParadoxExpressionPathManager.get(PsiElement, int) - 3.440s, 10.7%
icu.windea.pls.config.util.CwtConfigManager.matchesFilePath(CwtPathMatchableConfig, ParadoxPath) - 26.130s, 7% of all
```

最终需要考虑优化的地方：

```
icu.windea.pls.config.util.CwtConfigManager.matchesFilePath(CwtPathMatchableConfig, ParadoxPath)
```

优化思路：

- 考虑如何更快速地匹配规则（定义或者复杂枚举的）与文件路径
- 考虑把`CwtPathMatchableConfig`中的`Set<String>`替换成`Array<String>`，预计节省的时间：7s, 30%

### 测试#4 2025/9/2 V2.0.2

#### 性能优化

```
icu.windea.pls.lang.index.ParadoxFileBasedIndex.buildFileData(PsiFile) - 49.153s
-icu.windea.pls.ep.index.ParadoxDynamicValueIndexInfoSupport.indexScriptElement(PsiElement, Map) - 31.073s, 63.22% of root
-icu.windea.pls.ep.index.ParadoxComplexEnumValueIndexInfoSupport.indexScriptElement(PsiElement, Map) - 2.8s 
-icu.windea.pls.lang.util.ParadoxDefinitionManager.doGetInfo(ParadoxScriptDefinitionElement, PsiFile) - 3.440s, 7% of root
# 结论：索引动态值太过耗时

icu.windea.pls.ep.index.ParadoxDynamicValueIndexInfoSupport.indexScriptElement(PsiElement, Map) - 31.073s
-icu.windea.pls.lang.util.ParadoxExpressionManager.getExpressionReferences(ParadoxExpressionElement) - 30.573s
--icu.windea.pls.lang.util.ParadoxExpressionManager.doGetExpressionReferencesFromCache(ParadoxScriptExpressionElement) - 30.513s
---icu.windea.pls.lang.util.ParadoxExpressionManager.doGetExpressionReferences(ParadoxScriptExpressionElement) - 28.393s
----icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 24.693s
-----icu.windea.pls.lang.util.ParadoxExpressionManager.doGetConfigs(PsiElement, boolean, int) - 22.9933s
----icu.windea.pls.core.PlatformExtensionsKt.collectReferences(PsiReference) - 3.16s
# 结论：可能需要考虑更好的方式来在索引时收集动态值

icu.windea.pls.ep.index.ParadoxComplexEnumValueIndexInfoSupport.indexScriptElement(PsiElement, Map) - 2.8s
-icu.windea.pls.lang.util.ParadoxComplexEnumValueManager.getInfo(ParadoxScriptStringExpressionElement) - 2.6s
--icu.windea.pls.lang.util.ParadoxComplexEnumValueManager.doGetInfoFromCache(ParadoxScriptStringExpressionElement) - 2.58s
---icu.windea.pls.lang.util.ParadoxComplexEnumValueManager.doGetInfo(ParadoxScriptStringExpressionElement, PsiFile) - 0.86s
----icu.windea.pls.lang.util.ParadoxComplexEnumValueManager.getMatchedComplexEnumConfig(ParadoxScriptStringExpressionElement, CwtConfigGroup, ParadoxPath) - 0.54s
# 结论：无法进一步优化

icu.windea.pls.lang.util.ParadoxDefinitionManager.doGetInfo(ParadoxScriptDefinitionElement, PsiFile) -3.440s
-icu.windea.pls.script.psi.impl.ParadoxScriptPropertyImpl.getName - 0.9s
-icu.windea.pls.lang.util.ParadoxExpressionPathManager.get - 0.7s
-icu.windea.pls.lang.util.ParadoxDefinitionManager.getMatchedTypeConfig - 0.5s
# 结论：没有必要

icu.windea.pls.lang.util.ParadoxExpressionManager.doGetConfigs(PsiElement, boolean, int) - 24.393s
-icu.windea.pls.config.configContext.CwtConfigContext.getConfigs(int) - 11.753s
--icu.windea.pls.config.configContext.CwtConfigContext.doGetConfigs(int) - 8.173s
---icu.windea.pls.ep.configContext.InlineScriptCwtConfigContextProvider.getConfigs(CwtConfigContext, int) - 5.833s
----icu.windea.pls.lang.util.ParadoxInlineScriptManager.doGetInferredContextConfigsFromUsages(ParadoxScriptMemberElement, CwtConfigContext, String, int) - 5.513s # 无法避免
---icu.windea.pls.ep.configContext.BaseCwtConfigContextProvider.getConfigs(CwtConfigContext, int) - 2.340s
----icu.windea.pls.lang.util.ParadoxExpressionManager.lambda 'run' in doGetConfigsForConfigContext() - 1.94s
-----icu.windea.pls.lang.util.ParadoxExpressionManager.doInlineConfigForConfigContext(ParadoxScriptMemberElement, String, boolean, CwtPropertyConfig, int) - 0.72s
--icu.windea.pls.config.configContext.CwtConfigContext.doGetCacheKey(int) - 1.68s
---icu.windea.pls.ep.configContext.BaseCwtConfigContextProvider.getCacheKey(CwtConfigContext, int) - 1.62s
----icu.windea.pls.model.ParadoxDefinitionInfo.getDeclaration(int) 0.86s # 避免调用这个方法会更好，但目前没有必要
-icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigContext(PsiElement) - 6.360s
--icu.windea.pls.ep.configContext.CwtConfigContextProvider$INSTANCE.getContext(ParadoxScriptMemberElement) - 4.94s
---icu.windea.pls.ep.configContext.CwtConfigContextProvider$INSTANCE.lambda 'firstNotNullOfOrNull' in INSTANCE() - 3.24s
----icu.windea.pls.ep.configContext.BaseCwtConfigContextProvider.getContext(ParadoxScriptMemberElement, ParadoxExpressionPath, PsiFile) - 2.28s
-----icu.windea.pls.lang.util.ParadoxDefinitionManager.doGetInfo(ParadoxScriptDefinitionElement, PsiFile)
---icu.windea.pls.lang.util.ParadoxExpressionPathManager.get$default(ParadoxExpressionPathManager, PsiElement, int, int, Object) - 1.04s
# 结论：也许可以考虑使用 Caffeine，但这也无法避免调用 doGetInferredContextConfigsFromUsages 带来的性能开销

icu.windea.pls.config.configExpression.impl.CwtDataExpressionResolverImpl.resolve(String, boolean) - 4.56s
# 结论：也许可以把 CwtMemberConfig 的 keyExpression 和 valueExpression 缓存到 userData 中，但需要确认对内存占用的影响

icu.windea.pls.ep.expression.ParadoxScriptExpressionMatcher$INSTANCE.matches(PsiElement, ParadoxScriptExpression, CwtDataExpression, CwtConfig, CwtConfigGroup, int) - 2.8s
# 结论：没有必要
```

### 测试#5 2025/11/01 v2.0.6

#### 性能优化

```
icu.windea.pls.lang.index.ParadoxFileBasedIndex.buildFileData(PsiFile) - 105.601s
-icu.windea.pls.lang.index.ParadoxMergedIndex.indexDataForScriptFile(ParadoxScriptFile, Map) - 101.283s, 95.9% of root
--icu.windea.pls.ep.index.ParadoxDynamicValueIndexInfoSupport.indexScriptElement(PsiElement, Map) - 66.817s, 63.3% of root
---icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 58.662s
---icu.windea.pls.core.PlatformExtensionsKt.collectReferences(PsiReference) - 3.482s
--icu.windea.pls.lang.util.ParadoxDefinitionManager.getInfo(ParadoxScriptDefinitionElement) - 11.823s, 11.2% of root

icu.windea.pls.lang.util.ParadoxDefinitionManager.getInfo(ParadoxScriptDefinitionElement) - 13.771s
-icu.windea.pls.lang.util.ParadoxDefinitionManager.doGetInfo(ParadoxScriptDefinitionElement, PsiFile) - 6.445s
-icu.windea.pls.lang.util.ParadoxDefinitionManager.doGetInfoFromPsi(ParadoxScriptDefinitionElement, PsiFile, String) - 3.803s
-icu.windea.pls.script.psi.impl.ParadoxScriptPropertyImpl.getName() - 1.995s - runReadAction

icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 72.091s
-icu.windea.pls.config.configContext.CwtConfigContext.getConfigs(int) - 30.382s
--icu.windea.pls.lang.util.ParadoxExpressionManager.doInlineConfigForConfigContext(ParadoxScriptMember, String, CwtPropertyConfig, int) - 8.012s
---icu.windea.pls.config.util.manipulators.CwtConfigManipulator.inlineAlias(CwtPropertyConfig, Function1) - 6.392s
----icu.windea.pls.lang.util.ParadoxModifierManager.matchesModifier(String, PsiElement, CwtConfigGroup) - 3.746s
-----icu.windea.pls.lang.util.ParadoxEconomicCategoryManager.doGetInfo(ParadoxScriptProperty) - 2.396s
---icu.windea.pls.config.util.manipulators.CwtConfigManipulator.inlineSingleAlias(CwtPropertyConfig) - 1.404s
--icu.windea.pls.config.configContext.CwtConfigContext.doGetCacheKey(int) - 4.859s
---icu.windea.pls.ep.configContext.CwtBaseConfigContextProvider.getCacheKey(CwtConfigContext, int) - 4.667s
-icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigContext(PsiElement) - 15.248s
-icu.windea.pls.config.configContext.CwtConfigContext.doGetCacheKey(int)
-icu.windea.pls.lang.match.ParadoxMatchService.matchScriptExpression(PsiElement, ParadoxScriptExpression, CwtDataExpression, CwtConfig, CwtConfigGroup, int) - 9.417s
-icu.windea.pls.lang.util.ParadoxExpressionManager.optimizeMatchedConfigs(PsiElement, ParadoxScriptExpression, List, boolean, int) - 6.550s
--icu.windea.pls.lang.match.ParadoxMatchResult$LazyMatch.get(int) - 3.907s
--icu.windea.pls.lang.match.ParadoxMatchResultProvider.getPathReferenceMatchResult$lambda$17(Project, PsiElement, String, CwtDataExpression) - 2.289s
--icu.windea.pls.lang.match.ParadoxMatchResultProvider.getComplexEnumValueMatchResult$lambda$18(Project, PsiElement, String, String) - 1.591s

icu.windea.pls.lang._selectorsKt.selectFile(Object) - 9.815s
icu.windea.pls.lang._selectorsKt.selectGameType(Object) - 3.396s
```

结论：
- 如果在非必要时调用 `runReadAction`，会导致明显的耗时
  - 典型情况：获取各种领域信息时、调用 `selectFile` 和 `selectGameType` 时
- 考虑为定义类型 `resource` 和 `economic_category` 单独创建索引，或者在需要时添加缓存
- `CwtOptionDataAccessorProvider` 存在问题 - `get` 方法每次都会被调用

### 测试#6 2025/11/01 v2.0.6

#### 性能优化

```
icu.windea.pls.lang.index.ParadoxFileBasedIndex.buildFileData(PsiFile) - 110.182s
-icu.windea.pls.lang.index.ParadoxMergedIndex.indexDataForScriptFile(ParadoxScriptFile, Map) - 105.958s
--icu.windea.pls.ep.index.ParadoxDynamicValueIndexInfoSupport.indexScriptElement(PsiElement, Map) - 52.807s - 47.9% of root
---icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 45.803s
---icu.windea.pls.core.PlatformExtensionsKt.collectReferences(PsiReference) - 2.828s

icu.windea.pls.lang.util.ParadoxDefinitionManager.getInfo(ParadoxScriptDefinitionElement) - 10.283s
-icu.windea.pls.lang.util.ParadoxDefinitionManager.doGetInfo(ParadoxScriptDefinitionElement, PsiFile) - 5.780s
--icu.windea.pls.lang.util.ParadoxDefinitionManager.doGetInfoFromPsi(ParadoxScriptDefinitionElement, PsiFile, String) - 4.628s
---icu.windea.pls.lang.util.ParadoxScriptFileManager.getMemberPath(PsiElement, int) - 1.942s

icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 85.762s (total time)
-icu.windea.pls.config.configContext.CwtConfigContext.getConfigs(int) - 31.719s
--icu.windea.pls.lang.util.ParadoxExpressionManager.doGetConfigsForConfigContext(ParadoxScriptMember, List, ParadoxMemberPath, CwtConfigGroup, int) - 19.679s
---icu.windea.pls.lang.util.ParadoxExpressionManager.doInlineConfigForConfigContext(ParadoxScriptMember, String, CwtPropertyConfig, int) - 10.431s
----icu.windea.pls.config.util.manipulators.CwtConfigManipulator.inlineAlias(CwtPropertyConfig, Function1) - 6.449s *
----icu.windea.pls.config.util.manipulators.CwtConfigManipulator.inlineSingleAlias(CwtPropertyConfig) - 3.478s *
-icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigContext(PsiElement) - 17.209s
--icu.windea.pls.lang.util.ParadoxExpressionManager.doGetConfigContext(ParadoxScriptMember) - 12.464s
---icu.windea.pls.ep.configContext.CwtBaseConfigContextProvider.getContext(ParadoxScriptMember, ParadoxMemberPath, PsiFile) - 5.918s
---icu.windea.pls.lang.util.ParadoxDefinitionManager.getInfo(ParadoxScriptDefinitionElement)
-icu.windea.pls.lang.util.ParadoxExpressionManager.optimizeMatchedConfigs(PsiElement, ParadoxScriptExpression, List, boolean, int) - 12.011s
--icu.windea.pls.lang.match.ParadoxMatchResultProvider.getComplexEnumValueMatchResult$lambda$18(Project, PsiElement, String, String) - 6.672s
---icu.windea.pls.lang.index.ParadoxFileBasedIndex.getFileData(VirtualFile, Project) - 6.073s
--icu.windea.pls.lang.match.ParadoxMatchResultProvider.getPathReferenceMatchResult$lambda$17(Project, PsiElement, String, CwtDataExpression) - 0.790s

icu.windea.pls.lang.match.ParadoxMatchService.matchScriptExpression(PsiElement, ParadoxScriptExpression, CwtDataExpression, CwtConfig, CwtConfigGroup, int) - 13.542s
-icu.windea.pls.ep.match.ParadoxCoreScriptExpressionMatcher.match(PsiElement, ParadoxScriptExpression, CwtDataExpression, CwtConfig, CwtConfigGroup, int) - 5.063s
--icu.windea.pls.lang.resolve.complexExpression.ParadoxScopeFieldExpression$Companion.resolve(String, TextRange, CwtConfigGroup) - 1.584s *
-icu.windea.pls.ep.match.ParadoxPredicateBasedScriptExpressionMatcher.match(PsiElement, ParadoxScriptExpression, CwtDataExpression, CwtConfig, CwtConfigGroup, int) - 4.355s
-icu.windea.pls.ep.match.ParadoxConstantScriptExpressionMatcher.match(PsiElement, ParadoxScriptExpression, CwtDataExpression, CwtConfig, CwtConfigGroup, int) - 1.775s

icu.windea.pls.ep.config.CwtInjectedConfigProvider$INSTANCE.injectConfigs(CwtMemberConfig, List) - 2.566s

icu.windea.pls.lang.index.ParadoxIndexInfoType.findInfos(VirtualFile, Project) - 6.76s
```

结论：
- 合并索引中的索引信息的读写不可避免地会导致一定的耗时，是否可以继续优化呢……（`ParadoxIndexInfoType.findInfos`）
- 规则的匹配与解析逻辑不可避免地会导致一定的耗时，也许可以通过更好的缓存方案来优化（`ParadoxExpressionManager.getConfigs`）
- 也许可以一定程度上缓存复杂表达式，但是这并非性能痛点
- 也许可以考虑优化规则注入的实现方式（`CwtInjectedConfigProvider`）

### 测试#7 2025/11/05 v2.0.6 发布前

#### 性能优化

```
(cpu time)

icu.windea.pls.lang.index.ParadoxMergedIndex.indexData(PsiFile) - 147.793s
-icu.windea.pls.lang.index.ParadoxMergedIndex.indexDataForScriptFile(ParadoxScriptFile, Map) - 135.833s, 91.9%
--icu.windea.pls.lang.index.ParadoxMergedIndex$indexDataForScriptFile$1.lambda 'forEach' in indexDataForScriptFile() - 97.947s, 74.7%
---icu.windea.pls.ep.index.ParadoxDynamicValueIndexInfoSupport.indexScriptElement(PsiElement, Map) - 97.747s
--icu.windea.pls.lang.util.ParadoxDefinitionManager.getInfo(ParadoxScriptDefinitionElement) - 9.857s, 6.7%
-icu.windea.pls.lang.index.ParadoxMergedIndex.indexDataForLocalisationFile(ParadoxLocalisationFile, Map) - 11.830s, 8.0%

icu.windea.pls.ep.index.ParadoxDynamicValueIndexInfoSupport.indexScriptElement(PsiElement, Map) - 97.947s
-icu.windea.pls.lang.util.ParadoxExpressionManager.getExpressionReferences(ParadoxExpressionElement) - 96.881s, 98.9%
--icu.windea.pls.lang.util.ParadoxExpressionManager.doGetExpressionReferences(ParadoxScriptExpressionElement) - 73.974s, 75.5%
---icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 68.514s, 70.4%
----icu.windea.pls.lang.util.ParadoxExpressionManager.doGetConfigs(ParadoxScriptMember, boolean, int) - 64.250s, 65.6% - 耗时来自获取上下文规则
-----icu.windea.pls.config.configContext.CwtConfigContext.getConfigs(int) - 30.967s, 31.6%
-----icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigContext(PsiElement) - 16.773s, 17.1% - 耗时来自解析 memberPath，以及获取定义信息
-----icu.windea.pls.lang.match.ParadoxMatchPipeline.collectCandidates() - 9.984s, 10.2% - 耗时来自匹配脚本表达式
------icu.windea.pls.lang.match.ParadoxMatchService.matchScriptExpression - 7.488s, 7.6%
-----icu.windea.pls.lang.match.ParadoxMatchPipeline.optimize(PsiElement, ParadoxScriptExpression, List, int) - 2.054s, 2.1%
---icu.windea.pls.core.PlatformExtensionsKt.collectReferences(PsiReference) - 4.264s, 4.4%

icu.windea.pls.lang.match.ParadoxMatchService.matchScriptExpression(PsiElement, ParadoxScriptExpression, CwtDataExpression, CwtConfig, CwtConfigGroup, int) - 15.366s
-icu.windea.pls.ep.match.ParadoxCoreScriptExpressionMatcher.match(ParadoxScriptExpressionMatcher$Context) - 6.838s, 44.5%
--icu.windea.pls.ep.match.ParadoxCoreScriptExpressionMatcher.matchScopeFieldExpression(ParadoxScriptExpressionMatcher$Context) - 2.704s, 17.6% - 耗时主要来自解析 ParadoxDynamicScopeLinkNode 时的 filter
--icu.windea.pls.ep.match.ParadoxCoreScriptExpressionMatcher.matchDefinition(ParadoxScriptExpressionMatcher$Context) - 1.898s, 12.4%
-icu.windea.pls.ep.match.ParadoxPredicateBasedScriptExpressionMatcher.match(ParadoxScriptExpressionMatcher$Context) - 3.770s, 24.5%
--icu.windea.pls.lang.match.ParadoxMatchProvider.matchesByPredicate(PsiElement, CwtMemberConfig) - 2.548s (total: 2.392s), 16.6% - 耗时来自读取选项数据
-icu.windea.pls.ep.match.ParadoxConstantScriptExpressionMatcher.match(ParadoxScriptExpressionMatcher$Context) - 2.002s, 13.0%
--icu.windea.pls.lang._extensionsKt.isParameterized(String, boolean, boolean) - 0.598s (total: 1.430s)

icu.windea.pls.lang.util.ParadoxExpressionManager.doGetConfigContext(ParadoxScriptMember) - 14.303s
-icu.windea.pls.ep.configContext.CwtConfigContextProvider$INSTANCE.lambda 'firstNotNullOfOrNull' in INSTANCE() - 8.348s, 58.4%
--icu.windea.pls.ep.configContext.CwtBaseConfigContextProvider.getContext(ParadoxScriptMember, ParadoxMemberPath, PsiFile) - 5.618s, 39.3% #
---icu.windea.pls.script.psi.ParadoxScriptPsiSearchExtensionsKt.findParentDefinition(PsiElement) - 2.496s, 17.5% - 耗时来自获取定义信息，匹配子类型时可能需要加载PSI
---icu.windea.pls.model.paths.ParadoxMemberPathKt.relativeTo(ParadoxMemberPath, ParadoxMemberPath) - 1.978s, 13.8% - 耗时来自解析 memberPath
--icu.windea.pls.ep.configContext.CwtInlineScriptConfigContextProvider.getContext(ParadoxScriptMember, ParadoxMemberPath, PsiFile) - 1.482s, 10.4%
-icu.windea.pls.lang.util.ParadoxScriptFileManager.getMemberPath$default(ParadoxScriptFileManager, PsiElement, int, int, Object) - 4.213s, 29.5%

icu.windea.pls.config.configContext.CwtConfigContext.doGetConfigs(int) - 36.609s
-icu.windea.pls.ep.configContext.CwtBaseConfigContextProvider.getConfigs(CwtConfigContext, int) - 19.656S, 53.7%
--icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigsForConfigContext(ParadoxScriptMember, List, ParadoxMemberPath, CwtConfigGroup, int)
-icu.windea.pls.ep.configContext.CwtInlineScriptConfigContextProvider.getConfigs(CwtConfigContext, int) - 16.901s, 46.2%
--icu.windea.pls.lang.util.ParadoxInlineScriptManager.getInferredContextConfigs(String, ParadoxScriptMember, CwtConfigContext, int) - 10.660s, 29.1%
---icu.windea.pls.lang.util.ParadoxInlineScriptManager.doGetInferredContextConfigsFromUsages$lambda$11(int, boolean, Ref, CwtConfigContext, ParadoxScriptProperty) - 4.810s, 47.4%
----icu.windea.pls.config.configContext.CwtConfigContext.getConfigs(int) - 2.522s, 24.9%
-----icu.windea.pls.ep.configContext.CwtBaseConfigContextProvider.getCacheKey(CwtConfigContext, int) - 1.664s (total: 6.604s) - 耗时来自 getDeclaration，匹配子类型时可能需要加载PSI
----com.intellij.psi.util.PsiTreeUtilKt.parentOfType() - 2.002s, 19.7%
--icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigsForConfigContext(ParadoxScriptMember, List, ParadoxMemberPath, CwtConfigGroup, int)
---icu.windea.pls.lang.search.ParadoxInlineScriptUsageSearcher.processQuery(Object, Processor) - 10.140s

icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigsForConfigContext(ParadoxScriptMember, List, ParadoxMemberPath, CwtConfigGroup, int) - 25.871s
-icu.windea.pls.lang.util.ParadoxExpressionManager.doGetConfigsForConfigContext(ParadoxScriptMember, List, ParadoxMemberPath, CwtConfigGroup, int) - 24.519s, 94.8%
--icu.windea.pls.lang.util.ParadoxExpressionManager.inlineConfigForConfigContext(ParadoxScriptMember, String, CwtPropertyConfig, int) - 9.802s, 37.9% - 在深拷贝规则时的 intern 是必要的
-icu.windea.pls.config.CwtConfigExtensionsKt.sortedByPriority() - 1.352s, 5.2%

---icu.windea.pls.ep.config.CwtInjectedConfigProvider$INSTANCE.injectConfigs(CwtMemberConfig, List) - 3.224s (total)
```

结论：
- 考虑将 linksModel 缓存到规则数据中 ✔
- 在创建时不要 intern memberPath ✔
- 考虑仅在需要加入缓存时才 intern memberPath ✔
- 考虑优化 `CwtBaseConfigContextProvider.getCacheKey` - 是否可以不用解析子类型？
- 考虑优化 `CwtInjectedConfigProvider.injectConfigs` - 尽可能地快速返回

### 测试#8 2025/11/10 v2.0.7

#### 性能优化

## 解析时

### 测试#1 2025/11/02 v2.0.6

#### 性能优化

```
(cpu time)

icu.windea.pls.lang.search.ParadoxParameterSearcher.processQuery(Object, Processor) - 9.786s
-icu.windea.pls.lang.index.ParadoxIndexInfoType.findInfos(VirtualFile, Project)
icu.windea.pls.lang.search.ParadoxComplexEnumValueSearcher.processQuery(Object, Processor) - 32.245s
-icu.windea.pls.lang.index.ParadoxIndexInfoType.findInfos(VirtualFile, Project)
icu.windea.pls.lang.index.ParadoxIndexInfoType.findInfos(VirtualFile, Project) - 42.031s
-icu.windea.pls.lang.index.ParadoxMergedIndex.readData(DataInput) - 17.011s *
--icu.windea.pls.ep.index.ParadoxInferredScopeContextAwareDefinitionIndexInfoSupport.readData(DataInput, ParadoxIndexInfo, ParadoxGameType) - 4.911s
--icu.windea.pls.ep.index.ParadoxDynamicValueIndexInfoSupport.readData(DataInput, ParadoxIndexInfo, ParadoxGameType) - 2.370s
--icu.windea.pls.ep.index.ParadoxEventInEventIndexInfoSupport.readData(DataInput, ParadoxIndexInfo, ParadoxGameType) - 0.975s

icu.windea.pls.lang.match.ParadoxMatchResult$LazyMatch.get(int) - 37.991s
-icu.windea.pls.lang.match.ParadoxMatchResultProvider.getComplexEnumValueMatchResult$lambda$18(Project, PsiElement, String, String) - 25.814s *
-icu.windea.pls.ep.match.ParadoxBaseScriptExpressionMatcher.match$lambda$2(CwtConfig, ParadoxScriptBlock) 6.600s *
-icu.windea.pls.lang.match.ParadoxMatchResultProvider.getDefinitionMatchResult$lambda$8(Set, String, Project, PsiElement, String) 2.220s

icu.windea.pls.lang.resolve.complexExpression.ParadoxScopeFieldExpression$Companion.resolve(String, TextRange, CwtConfigGroup) - 2.100s

icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 73.255s
-icu.windea.pls.lang.util.ParadoxExpressionManager.doGetConfigs(PsiElement, boolean, int) - 64.510s
--icu.windea.pls.lang.util.ParadoxExpressionManager.optimizeMatchedConfigs(PsiElement, ParadoxScriptExpression, List, boolean, int) - 30.356s
---icu.windea.pls.lang.match.ParadoxMatchResult$LazyMatch.get(int) - 25.556s *
----icu.windea.pls.lang.match.ParadoxMatchResultProvider.getComplexEnumValueMatchResult$lambda$18(Project, PsiElement, String, String) - 22.034s
--icu.windea.pls.config.configContext.CwtConfigContext.getConfigs(int) - 24.255s
---icu.windea.pls.config.configContext.CwtConfigContext.doGetConfigs(int) - 20.910s
----icu.windea.pls.ep.configContext.CwtBaseConfigContextProvider.getConfigs(CwtConfigContext, int) - 20.385s
-----icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigsForConfigContext(ParadoxScriptMember, List, ParadoxMemberPath, CwtConfigGroup, int) - 20.355s
------icu.windea.pls.lang.util.ParadoxExpressionManager.doInlineConfigForConfigContext(ParadoxScriptMember, String, CwtPropertyConfig, int) - 8.265s *
------icu.windea.pls.lang.util.ParadoxExpressionManager.optimizeMatchedConfigs(PsiElement, ParadoxScriptExpression, List, boolean, int) - 5.820s *
---icu.windea.pls.config.configContext.CwtConfigContext.doGetCacheKey(int) - 1.275s
--icu.windea.pls.lang.match.ParadoxMatchService.matchScriptExpression(PsiElement, ParadoxScriptExpression, CwtDataExpression, CwtConfig, CwtConfigGroup, int) - 5.430s
--icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigContext(PsiElement) - 2.475s

icu.windea.pls.config.util.manipulators.CwtConfigManipulator.deepCopyConfigs(CwtMemberConfig, CwtMemberConfig) - 2.595s
-icu.windea.pls.ep.config.CwtInjectedConfigProvider$INSTANCE.injectConfigs(CwtMemberConfig, List) - 1.680s
```

结论：
- 基于合并索引的查询器，尤其是 `ParadoxComplexEnumValueSearcher`，不可避免地会导致一定的耗时，需要考虑进一步的优化方案，或者分离成多个索引
- 需要考虑优化规则注入的实现方式（`CwtInjectedConfigProvider`）
- intern 也会导致一定的耗时，需要平衡时间开销和内存开销，但是这并非性能痛点

### 测试#2 2025/11/03 v2.0.6

#### 性能优化

```
(total time)

icu.windea.pls.lang.search.ParadoxDefinitionSearcher.processQuery(Object, Processor) - 78.444s
-[typeExpression != null && finalName != null] - 76.582s
--icu.windea.pls.lang.search.ParadoxDefinitionSearcher.matchesSubtypes(ParadoxScriptDefinitionElement, List) - 8.985s, synchronized
---icu.windea.pls.lang.util.ParadoxDefinitionManager.matchesSubtype(ParadoxScriptDefinitionElement, String, CwtSubtypeConfig, List, CwtConfigGroup, int) - 3.364s
----icu.windea.pls.lang.util.ParadoxDefinitionManager.doMatchDefinition(ParadoxScriptDefinitionElement, CwtPropertyConfig, CwtConfigGroup, int) - 3.364s
-----icu.windea.pls.script.psi.impl.ParadoxScriptPropertyImpl.getBlock() - 3.079s

icu.windea.pls.lang.search.ParadoxLocalisationSearcher.processQuery(Object, Processor) - 95.674s
-[finalName != null] - 95.351s

icu.windea.pls.lang.search.ParadoxParameterSearcher.processQuery(Object, Processor) - 5.315s
-icu.windea.pls.lang.index.PlsIndexService.processFilesWithKeys(ID, Collection, GlobalSearchScope, Processor)
icu.windea.pls.lang.search.ParadoxComplexEnumValueSearcher.processQuery(Object, Processor) - 116.196s
-icu.windea.pls.lang.index.PlsIndexService.processFilesWithKeys(ID, Collection, GlobalSearchScope, Processor)
icu.windea.pls.lang.index.PlsIndexService.processFilesWithKeys(ID, Collection, GlobalSearchScope, Processor) - 121.492s
-icu.windea.pls.lang.index.IndexInfoAwareFileBasedIndex.getFileDataWithKey(VirtualFile, Project, String) - 116.667s

icu.windea.pls.lang.match.ParadoxMatchResult$LazyMatch.get(int) - 144.228s
-icu.windea.pls.lang.match.ParadoxMatchResultProvider.getDefinitionMatchResult$lambda$8(Set, String, Project, PsiElement, String) - 71.372s
-icu.windea.pls.lang.match.ParadoxMatchResultProvider.getComplexEnumValueMatchResult$lambda$18(Project, PsiElement, String, String) - 25.095s
-icu.windea.pls.lang.match.ParadoxMatchResultProvider.getPathReferenceMatchResult$lambda$17(Project, PsiElement, String, CwtDataExpression) - 1.521s

icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 224.195s
-icu.windea.pls.lang.util.ParadoxExpressionManager.doGetConfigs(PsiElement, boolean, int) - 198.194s
--icu.windea.pls.lang.util.ParadoxExpressionManager.optimizeMatchedConfigs(PsiElement, ParadoxScriptExpression, List, boolean, int) - 143.526s
---icu.windea.pls.lang.match.ParadoxMatchResult$LazyMatch.get(int) - 140.121s
--icu.windea.pls.config.configContext.CwtConfigContext.getConfigs(int) - 33.767s
---icu.windea.pls.config.configContext.CwtConfigContext.doGetConfigs(int) - 28.542s
----icu.windea.pls.lang.util.ParadoxExpressionManager.doGetConfigsForConfigContext(ParadoxScriptMember, List, ParadoxMemberPath, CwtConfigGroup, int) - 27.269s
-----icu.windea.pls.script.psi.ParadoxScriptPsiSearchExtensionsKt.findParentByPath$default(ParadoxScriptMember, String, boolean, String, int, Object) - 4.465s
------icu.windea.pls.script.psi.ParadoxScriptPsiSearchExtensionsKt.findParentProperty(PsiElement, String, boolean, boolean) - 4.199s
--icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigContext(PsiElement) - 10.375s
```

```
(cpu time)

icu.windea.pls.lang.search.ParadoxParameterSearcher.processQuery(Object, Processor) - 3.173ss
-icu.windea.pls.lang.index.PlsIndexService.processFilesWithKeys(ID, Collection, GlobalSearchScope, Processor)
icu.windea.pls.lang.search.ParadoxComplexEnumValueSearcher.processQuery(Object, Processor) - 9.975s
-icu.windea.pls.lang.index.PlsIndexService.processFilesWithKeys(ID, Collection, GlobalSearchScope, Processor)
icu.windea.pls.lang.index.PlsIndexService.processFilesWithKeys(ID, Collection, GlobalSearchScope, Processor) - 13.148s
-icu.windea.pls.lang.index.IndexInfoAwareFileBasedIndex.getFileDataWithKey(VirtualFile, Project, String) - 11.723s

icu.windea.pls.lang.match.ParadoxMatchResult$LazyMatch.get(int) - 8.740s
-icu.windea.pls.lang.match.ParadoxMatchResultProvider.getComplexEnumValueMatchResult$lambda$18(Project, PsiElement, String, String) - 4.427s
-icu.windea.pls.lang.match.ParadoxMatchResultProvider.getDefinitionMatchResult$lambda$8(Set, String, Project, PsiElement, String) - 2.280s
-icu.windea.pls.lang.match.ParadoxMatchResultProvider.getLocalisationMatchResult$lambda$12(Set, String, Project, PsiElement) - 1.349s

icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 39.331s
-icu.windea.pls.config.configContext.CwtConfigContext.getConfigs(int) - 15.847s
--icu.windea.pls.ep.configContext.CwtBaseConfigContextProvider.getConfigs(CwtConfigContext, int) - 12.313s
---icu.windea.pls.lang.util.ParadoxExpressionManager.doInlineConfigForConfigContext(ParadoxScriptMember, String, CwtPropertyConfig, int) - 6.214s
-icu.windea.pls.lang.util.ParadoxExpressionManager.optimizeMatchedConfigs(PsiElement, ParadoxScriptExpression, List, boolean, int) - 8.873s
--icu.windea.pls.lang.match.ParadoxMatchResult$LazyMatch.get(int) - 7.999s
-icu.windea.pls.lang.match.ParadoxMatchService.matchScriptExpression(PsiElement, ParadoxScriptExpression, CwtDataExpression, CwtConfig, CwtConfigGroup, int) - 2.527s
--icu.windea.pls.lang.resolve.complexExpression.impl.ParadoxScopeFieldExpressionResolverImpl.resolve(String, TextRange, CwtConfigGroup) - 0.969s
-icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigContext(PsiElement) - 2.527s

icu.windea.pls.lang.match.ParadoxMatchService.matchScriptExpression(PsiElement, ParadoxScriptExpression, CwtDataExpression, CwtConfig, CwtConfigGroup, int) - 5.472s

icu.windea.pls.lang.index.IndexInfoAwareFileBasedIndex.getFileDataWithKey(VirtualFile, Project, String) - 11.723s

icu.windea.pls.ep.config.CwtInjectedConfigProvider$INSTANCE.injectConfigs(CwtMemberConfig, List) - 1.045s
```

结论：
- 索引IO不可避免地会导致明显的耗时
- 一些复杂的匹配逻辑需要直接地、进一步地访问PSI，这也会导致一定的耗时
- 考虑优化 `ParadoxLocalisationSearcher` - 始终优先使用类型索引？

```
(total time, back trace)

icu.windea.pls.lang.search.ParadoxDefinitionSearcher.processQuery(Object, Processor) - 78.444s
↖icu.windea.pls.lang.search.ParadoxQuery.findFirst() - 71.277s
↖↖icu.windea.pls.lang.match.ParadoxMatchResultProvider.getDefinitionMatchResult$lambda$8(Set, String, Project, PsiElement, String) - 71.277s
↖icu.windea.pls.lang.search.ParadoxQuery.find() - 6.692s

icu.windea.pls.lang.search.ParadoxLocalisationSearcher.processQuery(Object, Processor) - 95.674s
↖icu.windea.pls.lang.search.ParadoxQuery.find() - 67.657s
↖↖icu.windea.pls.config.configExpression.CwtLocalisationLocationExpression$ResolveResult.getElement() - 36.873s
↖↖↖icu.windea.pls.lang.util.ParadoxDefinitionManager.doGetPrimaryLocalisation(ParadoxScriptDefinitionElement) - 35。391s
↖↖icu.windea.pls.ep.expression.ParadoxScriptLocalisationExpressionSupport.resolve(ParadoxExpressionElement, TextRange, String, CwtConfig, Boolean, boolean) - 17.174s
↖↖icu.windea.pls.lang.references.localisation.ParadoxLocalisationParameterPsiReference.doResolve() - 6.182s 
↖icu.windea.pls.lang.search.ParadoxQuery.findFirst() - 25.133s
↖↖icu.windea.pls.lang.match.ParadoxMatchResultProvider.getLocalisationMatchResult$lambda$12(Set, String, Project, PsiElement) - 25.038s

icu.windea.pls.lang.search.ParadoxComplexEnumValueSearcher.processQuery(Object, Processor) - 116.196s
↖icu.windea.pls.ep.expression.ParadoxScriptEnumValueExpressionSupport.resolve(ParadoxExpressionElement, TextRange, String, CwtConfig, Boolean, boolean) - 70.564s
↖icu.windea.pls.lang.match.ParadoxMatchResultProvider.getComplexEnumValueMatchResult$lambda$18(Project, PsiElement, String, String) - 45.632s
```

结论：
- 对于定义的索引
  - 需要评估“始终优先使用类型索引”的策略的效果
- 对于本地化的索引
  - 考虑进行更多的切片？
- 对于复杂枚举值的索引
  - 考虑预过滤枚举名？

```
com.intellij.psi.stubs.StubIndex.processElements(StubIndexKey, Object, Project, GlobalSearchScope, Class, Processor) - 172.902s
-com.intellij.psi.stubs.StubIndexEx.getContainingIds(StubIndexKey, Object, Project, IdFilter, GlobalSearchScope) - 89.718s - 这里会得到实际上用来遍历的 vFiles
--com.intellij.util.indexing.FileBasedIndexImpl.ensureUpToDate(ID, Project, GlobalSearchScope, VirtualFile) - 86.620s
---com.intellij.util.indexing.FileBasedIndexImpl.forceUpdate(Project, ProjectFilesCondition, VirtualFile) - 89.628s
---com.intellij.util.indexing.UpdateTask.processAll(Collection, Project) - 78.186s
----com.intellij.util.concurrency.Semaphore.waitFor(long) - 76.400s - 强制更新/锁/IO - 约束 `ProjectIndexableFilesFilter` 可能可以缩短耗时
-java.util.concurrent.ConcurrentHashMap.computeIfAbsent(Object, Function) - 49.263s
--com.intellij.psi.stubs.StubIndexEx.lambda$processElements$7(StubIndexKey, Object, VirtualFile, Project, boolean, StubIndexEx$KeyAndFileId) - 42.362s
---com.intellij.psi.stubs.StubProcessingHelper.retrieveStubIdList(StubIndexKey, Object, VirtualFile, Project, boolean) - 42.362s
----com.intellij.psi.stubs.SerializedStubTree.restoreIndexedStubs(StubIndexKey, Object) - 32.346s
-----com.intellij.psi.stubs.StubForwardIndexExternalizer.deserializeIndexValue - 32.308s
------com.intellij.openapi.progress.ProgressManager.checkCanceled() - 28.356s - `indexDis` 过大，循环了很多次，循环中的取消检查也进行了很多次
------it.unimi.dsi.fastutil.objects.Object2ObjectOpenCustomHashMap.put(Object, Object) 2.812s
----com.intellij.indexing.composite.CompositeInvertedIndexBase.getIndexedFileData(int) - 9.997s - 这里才是真正获取缓存的索引数据 - 取消检查/锁/IO/压缩
--java.util.concurrent.ConcurrentHashMap$ReservationNode.<init>() - 6.540s
-com.intellij.psi.stubs.StubIndexEx.lambda$processElements$6(Project, Processor, GlobalSearchScope, Class, Object, StubIndexKey, VirtualFile, StubIdList) - 33.313s
--com.intellij.psi.stubs.StubProcessingHelperBase.processStubsInFile(Project, VirtualFile, StubIdList, Processor, GlobalSearchScope, Class, Computable) - 33.294s
---icu.windea.pls.lang.index.PlsIndexService$sam$i$com_intellij_util_Processor$0.process(Object) - 20.035s - 后置的过滤逻辑 - 取消检查/获取存根/访问PSI
----icu.windea.pls.lang.util.ParadoxDefinitionManager.matchesSubtype(ParadoxScriptDefinitionElement, String, CwtSubtypeConfig, List, CwtConfigGroup, int) - 3.364s
-----icu.windea.pls.script.psi.impl.ParadoxScriptPropertyImpl.getBlock() - 3.079s
---com.intellij.psi.stubs.StubProcessingHelperBase.getAllSpines(PsiFile) - 10.219s - 构建存根树
```

结论：
- 约束最终查询索引时使用的 searchScope 可以降低耗时（`com.intellij.psi.stubs.StubIndexEx.processElements`，L199，125s -> ? / 173s）

打开了数个事件脚本文件后，再打开一个过大的事件脚本文件（>=2万行），能够明显感觉到性能问题。
- 存在明显的卡顿，分析需要很久或者反复重新开始
- 同样拥有很高的CPU占用
- 怀疑存在内存泄露？
- 怀疑完成完整的分析需要的内存超出上限？
- 怀疑存在无法完成，反复重新开始的读操作？
- 如果关闭此脚本文件，再打开其他脚本文件，影响仍然存在
- 如果只是打开这一个脚本文件，尽管分析明显需要更长的时间，但是并不会有明显的性能问题
- 需要分析代码中是否存在内存泄露，或者未及时失效的缓存

### 测试#3 2025/11/03 v2.0.6

#### 性能优化

```
(total time)

icu.windea.pls.lang.search.ParadoxDefinitionSearcher.processQuery(Object, Processor) - 88.728s
-icu.windea.pls.lang.search.ParadoxDefinitionSearcher.processQueryForStubDefinitions - 88.293s
--[typeExpression != null && finalName != null && constraint = null] - 87.942s, 99.114% - 似乎使用类型索引的话耗时更长了，并且在后置过滤上花了更多时间
--com.intellij.psi.stubs.StubIndexEx.lambda$processElements$6(Project, Processor, GlobalSearchScope, Class, Object, StubIndexKey, VirtualFile, StubIdList) - 59.270s, 66.8%
---icu.windea.pls.lang.index.PlsIndexService$sam$i$com_intellij_util_Processor$0.process(Object) - 31.857s
----icu.windea.pls.lang.search.ParadoxDefinitionSearcher.matchesName(ParadoxScriptDefinitionElement, String, boolean) - 17.222s, 19.4%
-----com.intellij.extapi.psi.StubBasedPsiElementBase.getGreenStub() - 12.231s
------com.intellij.openapi.progress.ProgressIndicatorProvider.checkCanceled() - 11.206s
----icu.windea.pls.lang.search.ParadoxDefinitionSearcher.matchesSubtypes(ParadoxScriptDefinitionElement, List) - 2.407s, 2.7%
---com.intellij.psi.stubs.StubProcessingHelperBase.getAllSpines(PsiFile) - 19.541s
--com.intellij.psi.stubs.StubIndexEx.getContainingIds(StubIndexKey, Object, Project, IdFilter, GlobalSearchScope) - 25.044s, 28.2%
---com.intellij.util.indexing.FileBasedIndexImpl.ensureUpToDate(ID, Project, GlobalSearchScope, VirtualFile) - 24.792, 27.9%
--java.util.concurrent.ConcurrentHashMap.computeIfAbsent(Object, Function) - 2.983s
---com.intellij.psi.stubs.StubProcessingHelper.retrieveStubIdList(StubIndexKey, Object, VirtualFile, Project, boolean) - 1.290s

icu.windea.pls.lang.search.ParadoxLocalisationSearcher.processQuery(Object, Processor) - 38.368s
-icu.windea.pls.lang.search.ParadoxLocalisationSearcher.processQueryForLocalisations(String, Project, GlobalSearchScope, ParadoxIndexConstraint, Processor) - 38.284s
--java.util.concurrent.ConcurrentHashMap.computeIfAbsent(Object, Function) - 26.327s
---com.intellij.psi.stubs.StubProcessingHelper.retrieveStubIdList(StubIndexKey, Object, VirtualFile, Project, boolean) - 22.327s, 58.2%
--com.intellij.psi.stubs.StubIndexEx.getContainingIds(StubIndexKey, Object, Project, IdFilter, GlobalSearchScope) - 8.530s, 22.2%
--com.intellij.psi.stubs.StubIndexEx.lambda$processElements$6(Project, Processor, GlobalSearchScope, Class, Object, StubIndexKey, VirtualFile, StubIdList) - 2.527s, 6.6%
---com.intellij.psi.stubs.StubProcessingHelperBase.getAllSpines(PsiFile) - 1.094s
---icu.windea.pls.lang.index.PlsIndexService$sam$i$com_intellij_util_Processor$0.process(Object) - 1.027s

icu.windea.pls.lang.search.ParadoxComplexEnumValueSearcher.processQuery(Object, Processor) - 15.315s
-icu.windea.pls.lang.index.PlsIndexService.processFilesWithKeys(ID, Collection, GlobalSearchScope, Processor) - 15.287s
--icu.windea.pls.lang.index.IndexInfoAwareFileBasedIndex.getFileDataWithKey(VirtualFile, Project, String) - 14.768s
---com.intellij.util.indexing.FileBasedIndexEx.processValuesInOneFile(ID, Object, VirtualFile, GlobalSearchScope, FileBasedIndex$ValueProcessor) - 14.586s - 考虑使用 fast-return-procssor，预计可以节省至少2s耗时（取消检查）
----com.intellij.util.indexing.FileBasedIndexEx.lambda$processValuesInOneFile$8(int, FileBasedIndex$ValueProcessor, VirtualFile, InvertedIndexValueIterator) - 13.618s
-----com.intellij.openapi.progress.ProgressManager.checkCanceled() - 11.429s
-----com.intellij.util.indexing.impl.MergedValueContainer$1.next() - 1.201s
```

### 测试#4 2025/11/03 v2.0.6

#### 性能优化

```
(total time)

icu.windea.pls.lang.search.ParadoxDefinitionSearcher.processQuery(Object, Processor) - 33.968s
-icu.windea.pls.lang.search.ParadoxDefinitionSearcher.processQueryForStubDefinitions - 32.586s, 95.9%
--[typeExpression != null && finalName != null] - 31.933s, 94.009%
--com.intellij.psi.stubs.StubIndexEx.getContainingIds(StubIndexKey, Object, Project, IdFilter, GlobalSearchScope) - 20.365s, 60.0%
---com.intellij.util.indexing.FileBasedIndexImpl.ensureUpToDate(ID, Project, GlobalSearchScope, VirtualFile) - 19.605s, 57.7%
--com.intellij.psi.stubs.StubIndexEx.lambda$processElements$6(Project, Processor, GlobalSearchScope, Class, Object, StubIndexKey, VirtualFile, StubIdList) - 9.636s, 28.4%
---icu.windea.pls.lang.index.PlsIndexService$sam$i$com_intellij_util_Processor$0.process(Object) - 7.333s, 21.6%
----icu.windea.pls.lang.search.ParadoxDefinitionSearcher.matchesSubtypes(ParadoxScriptDefinitionElement, List) - 5.911s, 17.4%
-----icu.windea.pls.model.ParadoxDefinitionInfo.getSubtypeConfigs() - 3.487s, 10.3%
------icu.windea.pls.lang.util.ParadoxDefinitionManager.doMatchDefinition(ParadoxScriptDefinitionElement, CwtPropertyConfig, CwtConfigGroup, int) - 3.484s
-------icu.windea.pls.script.psi.impl.ParadoxScriptPropertyImpl.getBlock() - 3.070s, 9.0% - 这会最终导致解析整个脚本文件的 PSI，考虑是否可以进一步优化？ - 直接通过 LighterAST 匹配子类型是可行的，但是相当复杂
---com.intellij.psi.stubs.StubProcessingHelperBase.getAllSpines(PsiFile) - 1.924s, 5.7%
--java.util.concurrent.ConcurrentHashMap.computeIfAbsent(Object, Function) - 2.243s, 6.6%

icu.windea.pls.lang.search.ParadoxLocalisationSearcher.processQuery(Object, Processor) - 55.940s
-icu.windea.pls.lang.search.ParadoxLocalisationSearcher.processQueryForLocalisations(String, Project, GlobalSearchScope, ParadoxIndexConstraint, Processor) - 55.389s, 99.0% 
--java.util.concurrent.ConcurrentHashMap.computeIfAbsent(Object, Function) - 30.289s, 54.1% - 索引数据相当多，IO耗时相当长
---com.intellij.psi.stubs.StubProcessingHelper.retrieveStubIdList(StubIndexKey, Object, VirtualFile, Project, boolean)
----com.intellij.psi.stubs.SerializedStubTree.restoreIndexedStubs(StubIndexKey, Object) - 19.501s, 34.9%
-----com.intellij.psi.stubs.StubForwardIndexExternalizer.deserializeIndexValue(DataInput, StubIndexKey, Object) - 19.444s, 34.8%
------com.intellij.openapi.progress.ProgressManager.checkCanceled() - 9.631s, 17.2% - 循环IO中的取消检查，这意味着循环了很多次
------it.unimi.dsi.fastutil.objects.Object2ObjectOpenCustomHashMap.put(Object, Object) - 9.053s, 16.2%
-------com.intellij.util.containers.CollectionFactory$1.equals(Object, Object) - 7.516s, 13.4% - 最终的耗时来自字符串相等性检查
----com.intellij.indexing.composite.CompositeInvertedIndexBase.getIndexedFileData(int) - 6.307s, 11.3%
-----com.intellij.util.io.PersistentMapImpl.get(Object) - 4.434s, 7.9%
--com.intellij.psi.stubs.StubIndexEx.getContainingIds(StubIndexKey, Object, Project, IdFilter, GlobalSearchScope) - 11.754s, 21.0%
---com.intellij.util.indexing.FileBasedIndexImpl.ensureUpToDate(ID, Project, GlobalSearchScope, VirtualFile) - 9.763s, 17.5%
--com.intellij.psi.stubs.StubIndexEx.lambda$processElements$6(Project, Processor, GlobalSearchScope, Class, Object, StubIndexKey, VirtualFile, StubIdList) - 10.812s, 19.3%
---icu.windea.pls.lang.index.PlsIndexService$sam$i$com_intellij_util_Processor$0.process(Object) - 4.558s - 取消检查/获取存根
---com.intellij.psi.stubs.StubProcessingHelperBase.getAllSpines(PsiFile) - 4.556s

icu.windea.pls.lang.search.ParadoxComplexEnumValueSearcher.processQuery(Object, Processor) - 166.742s
-icu.windea.pls.lang.index.PlsIndexService.processFilesWithKeys(ID, Collection, GlobalSearchScope, Processor) - 166.666s
--com.intellij.util.indexing.FileBasedIndexEx.processVirtualFiles(IntCollection, GlobalSearchScope, Processor) - 92.684s
---icu.windea.pls.lang.index.IndexInfoAwareFileBasedIndex.getFileDataWithKey(VirtualFile, Project, String) - 89.403s, 53.6%
----com.intellij.util.indexing.FileBasedIndexEx.processValuesInOneFile(ID, Object, VirtualFile, GlobalSearchScope, FileBasedIndex$ValueProcessor) - 86.651s, 52.0%
-----com.intellij.util.indexing.FileBasedIndexEx.lambda$processValuesInOneFile$8(int, FileBasedIndex$ValueProcessor, VirtualFile, InvertedIndexValueIterator) - 74.727s, 44.8%
------com.intellij.openapi.progress.ProgressManager.checkCanceled() - 51.544s, 30.9%
--com.intellij.util.indexing.FileBasedIndexEx.collectFileIdsContainingAnyKey(ID, Collection, GlobalSearchScope, Condition, IdFilter) - 73.982s, 44.4%
---com.intellij.util.indexing.FileBasedIndexImpl.ensureUpToDate(ID, Project, GlobalSearchScope, VirtualFile) - 72.146s, 43.3% - 更新索引的耗时
```

### 测试#5 2025/11/04 v2.0.6

> 预先固定并依次打开游戏目录中的以下文件，等到分析完毕后再打开下一个
> - `localisation/simp_chinese/wilderness_l_simp_chinese.yml`
> - `common/armies/00_defense_armies.txt`
> - `common/buildings/00_capital_buildings.txt`
> - `events/first_contact_events.txt`
> - `events/machine_age_crisis_events.txt`
> - `events/shroud_events.txt`
> - ...

#### 性能优化

```
(total time)

icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 78.912s
-icu.windea.pls.lang.util.ParadoxExpressionManager.doGetConfigs(PsiElement, boolean, int) - 63.132s, 80.0%
--icu.windea.pls.lang.util.ParadoxExpressionManager.optimizeMatchedConfigs(PsiElement, ParadoxScriptExpression, List, boolean, int)
---icu.windea.pls.lang.match.ParadoxMatchResult$LazyMatch.get(int) - 33.236s, 52.6%
--icu.windea.pls.config.configContext.CwtConfigContext.getConfigs(int) - 15.456s, 24.5%
---icu.windea.pls.lang.util.ParadoxExpressionManager.doGetConfigsForConfigContext(ParadoxScriptMember, List, ParadoxMemberPath, CwtConfigGroup, int) - 11.830s, ~16.8%
----icu.windea.pls.ep.config.CwtInjectedConfigProvider$INSTANCE.injectConfigs(CwtMemberConfig, List) - 0.773s - 实际造成的耗时会更多
---icu.windea.pls.ep.configContext.CwtBaseConfigContextProvider.getCacheKey(CwtConfigContext, int) - 2.472s, 3.9%
----icu.windea.pls.model.ParadoxDefinitionInfo.getDeclaration(int) - 1.752s, 2.8%
--icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigContext(PsiElement) - 5.923s, 9.4%
-icu.windea.pls.lang.util.ParadoxExpressionManager.doGetConfigsCacheFromCache(PsiElement) - 9.100s, 11.5%

icu.windea.pls.config.configGroup.CwtConfigGroup.init(Continuation) - 12.365s
-icu.windea.pls.ep.configGroup.CwtFileBasedConfigGroupDataProvider.process(CwtConfigGroup, Continuation) - 12.311s
--icu.windea.pls.ep.configGroup.CwtFileBasedConfigGroupDataProvider.resolveAndProcessFile(VirtualFile, CwtConfigGroup, String) - 11.231s
--icu.windea.pls.ep.configGroup.CwtFileBasedConfigGroupDataProvider.resolveAndProcessInternalFile(String, VirtualFile, CwtConfigGroup) 

icu.windea.pls.ep.configGroup.CwtFileBasedConfigGroupDataProvider.lambda 'forEach' in process() - 37.951s
-icu.windea.pls.ep.configGroup.CwtFileBasedConfigGroupDataProvider.resolveAndProcessFile(VirtualFile, CwtConfigGroup, String) - 36.511s
--icu.windea.pls.config.util.CwtConfigResolverUtil.getOptionConfigs(CwtMember) - 6.831s
---icu.windea.pls.cwt.psi.impl.CwtOptionImpl.getOptionValue() - 0.981s - 反向遍历子节点可以降低耗时
-icu.windea.pls.ep.configGroup.CwtFileBasedConfigGroupDataProvider.resolveAndProcessInternalFile(String, VirtualFile, CwtConfigGroup) - 1.422s

icu.windea.pls.lang.match.ParadoxMatchResult$LazyMatch.get(int) - 34.195s
-icu.windea.pls.lang.match.ParadoxMatchResultProvider.getComplexEnumValueMatchResult$lambda$18(Project, PsiElement, String, String) - 13.856s, 40.5%
-icu.windea.pls.lang.match.ParadoxMatchResultProvider.getPathReferenceMatchResult$lambda$17(Project, PsiElement, String, CwtDataExpression) - 10.297s, 30.1%
-icu.windea.pls.lang.match.ParadoxMatchResultProvider.getDefinitionMatchResult$lambda$8(Set, String, Project, PsiElement, String) - 7.258s, 21.2%
-icu.windea.pls.lang.match.ParadoxMatchResultProvider.getLocalisationMatchResult$lambda$12(Set, String, Project, PsiElement) - 2.496s, 7.3%

icu.windea.pls.lang.search.ParadoxDefinitionSearcher.processQuery(Object, Processor) - 10.431s
-icu.windea.pls.lang.search.ParadoxDefinitionSearcher.matchesSubtypes(ParadoxScriptDefinitionElement, List) - 1.920s, 18.4%
--icu.windea.pls.script.psi.impl.ParadoxScriptPropertyImpl.getBlock() - 0.966s, 9.3%
↖icu.windea.pls.lang.search.ParadoxQuery.findFirst() - 7.222s, 69.2%
↖icu.windea.pls.lang.match.ParadoxMatchResultProvider.lambda 'any' in getDefinitionMatchResult() - 7.222s, 69.2%
↖icu.windea.pls.lang.search.ParadoxQuery.find() - 2.654s, 25.4%
↖↖icu.windea.pls.ep.expression.ParadoxScriptDefinitionExpressionSupport.resolve(ParadoxExpressionElement, TextRange, String, CwtConfig, Boolean, boolean) - 1.293s, 12.4%
↖↖icu.windea.pls.lang.util.ParadoxGameConceptManager.get(String, Project, PsiElement) - 0.731s, 7.0%

icu.windea.pls.lang.search.ParadoxLocalisationSearcher.processQuery(Object, Processor) - 34.734s
↖icu.windea.pls.lang.search.ParadoxQuery.find() - 31.470s, 90.6%
↖↖icu.windea.pls.lang.util.CwtLocationExpressionManager.createLocalisationResolveResult$lambda$2(ParadoxDefinitionInfo, Project, ParadoxScriptDefinitionElement, Function1, String) - 16.023s, 46.1%
↖↖icu.windea.pls.ep.expression.ParadoxScriptLocalisationExpressionSupport.resolve(ParadoxExpressionElement, TextRange, String, CwtConfig, Boolean, boolean) - 10.342s, 29.8%
↖↖icu.windea.pls.lang.references.localisation.ParadoxLocalisationParameterPsiReference.doResolve() - 3.481s, 10.0%
↖↖icu.windea.pls.lang.util.ParadoxComplexEnumValueManager.getNameLocalisation(String, PsiElement, CwtLocaleConfig) - 0.907s, 2.6%
↖icu.windea.pls.lang.search.ParadoxQuery.findFirst() - 2.707s, 7.8%
↖↖icu.windea.pls.lang.match.ParadoxMatchResultProvider.lambda 'any' in getLocalisationMatchResult() - 2.388s, 6.9%

icu.windea.pls.lang.search.ParadoxComplexEnumValueSearcher.processQuery(Object, Processor) - 24.605s
↖icu.windea.pls.lang.search.ParadoxQuery.findFirst() - 24.605s, 100%
↖↖icu.windea.pls.lang.match.ParadoxMatchResultProvider.getComplexEnumValueMatchResult$lambda$18(Project, PsiElement, String, String) - 13.856s, 56.3%
↖↖icu.windea.pls.ep.expression.ParadoxScriptEnumValueExpressionSupport.resolve(ParadoxExpressionElement, TextRange, String, CwtConfig, Boolean, boolean) - 10.749s, 43.7%

icu.windea.pls.lang.search.ParadoxFilePathSearcher.processQuery(Object, Processor) - 17.547s
-com.intellij.psi.search.FilenameIndex.processFilesByNames(Set, boolean, GlobalSearchScope, IdFilter, Processor) - 17.241s, 98.3%
```

结论：
- 考虑切分 `ParadoxMatchResultProvider.configMatchResultCache` 并分别使用更合适的 modificationTracker ✔

#### 内存优化

| Class                                                        | Count   | Shallow   | Retained  |
|--------------------------------------------------------------|---------|-----------|-----------|
| icu.windea.pls.script.psi.impl.ParadoxScriptPropertyKeyImpl  | 103,345 | 3.31 MB   | 144.01 MB |
| icu.windea.pls.script.psi.impl.ParadoxScriptStringImpl       | 39,396  | 1.26 MB   | 121.04 MB |
| icu.windea.pls.script.psi.impl.ParadoxScriptBlockImpl        | 42,871  | 1.03 MB   | 105.39 MB |
| icu.windea.pls.script.psi.impl.ParadoxScriptPropertyImpl     | 163,259 | 6.53 MB   | 97.88 MB  |
| icu.windea.pls.config.configContext.CwtConfigContext         | 108,680 | 4.35 MB   | 66.6 MB   |
| icu.windea.pls.config.configGroup.CwtConfigGroup             | 40      | 1.6 kB    | 58.12 MB  |
| icu.windea.pls.config.config.impl.CwtPropertyConfigImpl1     | 123,716 | 6.93 MB   | 53.75 MB  |
| icu.windea.pls.model.paths.impl.ParadoxMemberPathImpl       | 220,372 | 5.29 MB   | 53.68 MB  |
| icu.windea.pls.config.config.impl.CwtPropertyConfigImpl2     | 60,236  | 2.89 MB   | 36.33 MB  |
| icu.windea.pls.config.config.impl.CwtPropertyConfigDelegate2 | 332,926 | 10.65 MB  | 23.2 MB   |
| icu.windea.pls.script.psi.impl.ParadoxScriptBooleanImpl      | 11,209  | 269.02 kB | 20.75 MB  |

结论：
- 规则对象仍然占用了一些内存
- 优化 `PsiCodeInjectors` - 仅缓存必要的字段 ✔ + 考虑适用 intern
- 优化 `ParadoxMemberPath`（以及其他路径模型） - 考虑适用 intern ✔ + 考虑适用有上限的缓存
- 在解析规则时，考虑为仅有一个规则的列表适用 `SmartList(e)` 或 `listOf(e)` ✔

**Duplicated Strings**

| Value                                                        | Duplicates | Wasted (Bytes) |
| ------------------------------------------------------------ | --------- | -------------- |
| #1#16                                                        | 113529    | 2724696        |
| #1#0                                                         | 112876    | 2709024        |
| #0#0                                                         | 112230    | 2693520        |
| option                                                       | 43327     | 1039848        |
| immediate                                                    | 24804     | 595296         |
| trigger                                                      | 19717     | 473208         |
| if                                                           | 15106     | 362544         |
| (property) alias_name[trigger] = alias_match_left[trigger]   | 14991     | 359784         |
| owner                                                        | 11814     | 283536         |
| limit                                                        | 11277     | 270648         |
| hidden_effect                                                | 11034     | 264816         |
| desc                                                         | 10636     | 255264         |
| (property) alias_name[effect] = alias_match_left[effect]     | 7693      | 184632         |
| country_event                                                | 6787      | 162888         |
| name                                                         | 5943      | 142632         |
| modifier                                                     | 4932      | 118368         |
| id                                                           | 4471      | 107304         |
|                                                              | 4327      | 103848         |
| random_list                                                  | 4235      | 101640         |
| NOT                                                          | 4187      | 100488         |
| OR                                                           | 3957      | 94968          |
| option/name                                                  | 3784      | 90816          |
| add_monthly_resource_mult                                    | 3212      | 77088          |
| : country_flag                                               | 3152      | 75648          |
| : event_target                                               | 3046      | 73104          |
| after                                                        | 3007      | 72168          |
| from                                                         | 3006      | 72144          |
| else                                                         | 2995      | 71880          |
| else_if                                                      | 2811      | 67464          |
| NOR                                                          | 2659      | 63816          |
| country_event/option/name                                    | 2591      | 62184          |
| has_country_flag                                             | 2584      | 62016          |
| country_event/option                                         | 2552      | 61248          |
| (property) name = localisation (property) name = {...} (property) name = {...} (property) icon = {...} (property) sound = scalar (property) trigger = single_alias_right[trigger_clause] (property) allow = single_alias_right[trigger_clause] (property) exclusive_trigger = single_alias_right[trigger_clause] (property) ai_chance = {...} (property) response_text = localisation (property) is_dialog_only = bool (property) hide_option_if_not_allowed = bool (property) default_hide_option = bool (property) custom_gui = scalar (property) tag = value_set[event_option_tag] (property) alias_name[effect] = alias_match_left[effect] | 2504      | 60096          |
| text                                                         | 2435      | 58440          |
| value                                                        | 2400      | 57600          |
| picture                                                      | 2362      | 56688          |
| is_triggered_only                                            | 2278      | 54672          |
| (property) limit = single_alias_right[trigger_clause] (property) alias_name[effect] = alias_match_left[effect] | 2167      | 52008          |
| .                                                            | 2069      | 49656          |
| add_modifier                                                 | 2053      | 49272          |
| show_sound                                                   | 1989      | 47736          |
| title                                                        | 1955      | 46920          |
| custom_tooltip                                               | 1848      | 44352          |
| allow                                                        | 1816      | 43584          |
| ai_chance                                                    | 1805      | 43320          |
| controller                                                   | 1681      | 40344          |
| country_event/desc                                           | 1635      | 39240          |
| country_event/id                                             | 1601      | 38424          |
| gfx                                                          | 1571      | 37704          |
| GetName                                                      | 1534      | 36816          |

结论：
- 缓存键需要 intern ✔
- `immediate` - 高频出现的脚本属性的 key/value 也需要考虑 intern
- `GetName` - 高频出现的其他标识符字符串（这里是本地化命令）也需要考虑 intern
- `: event_target` - 高频出现的提示字符串也需要 intern ✔
- `(property) alias_name[trigger] = alias_match_left[trigger]` - 来自 `ParadoxExpressionManager.getChildOccurrenceMap` 需要定位并优化 ✔

### 测试#6 2025/11/06 v2.0.6 发布前

> 测试方法同上

#### 性能优化

```
(total time)

icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 108.205s
↖icu.windea.pls.lang.util.ParadoxExpressionManager.doGetExpressionReferences(ParadoxScriptExpressionElement) - 50.255s, 46.4%
↖↖icu.windea.pls.lang.references.script.ParadoxScriptExpressionPsiReferenceProvider.getReferencesByElement(PsiElement, ProcessingContext) - 解析脚本表达式的PSI引用
↖↖↖icu.windea.pls.script.psi.impl.ParadoxScriptPropertyKeyImpl.getReferences() - 45.078s
↖↖↖icu.windea.pls.script.psi.impl.ParadoxScriptStringImpl.getReferences() - 15.254s
-icu.windea.pls.lang.util.ParadoxExpressionManager.doGetConfigs(ParadoxScriptMember, boolean, int) - 92.578s, 85.6%
--icu.windea.pls.lang.match.ParadoxMatchPipeline.filter(List, int) - 64.482s, 59.6%
---icu.windea.pls.lang.match.ParadoxMatchResult$LazyMatch.get(int) - 64.226s, 59.4% - 耗时来自访问索引
--icu.windea.pls.config.configContext.CwtConfigContext.getConfigs(int) - 15.442s, 14.3%
---icu.windea.pls.lang.match.ParadoxMatchPipeline.optimize(PsiElement, ParadoxScriptExpression, List, int) - 3.572s
----icu.windea.pls.ep.match.ParadoxScriptExpressionOverriddenMatchOptimizer.optimize(List, ParadoxScriptExpressionMatchOptimizer$Context) - 3.412s
----icu.windea.pls.lang.util.ParadoxExpressionManager.inlineConfigForConfigContext(ParadoxScriptMember, String, CwtPropertyConfig, int) - 1.840s - 耗时来自深拷贝规则时的 intern（这是必要的）
-----icu.windea.pls.lang.match.ParadoxMatchProvider.matchesDefinition(PsiElement, Project, String, String) - 2.951s
---icu.windea.pls.script.psi.ParadoxScriptPsiSearchExtensionsKt.findParentByPath(ParadoxScriptMember, String, boolean, String) - 2.142s
--icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigContext(PsiElement) - 6.047s, 5.6% - 耗时来自查找父定义、获取 memberPath
--icu.windea.pls.lang.match.ParadoxMatchPipeline.collectCandidates() - 3.344s, 3.1%

icu.windea.pls.lang.util.ParadoxExpressionManager.inlineConfigForConfigContext(ParadoxScriptMember, String, CwtPropertyConfig, int) - 1.840s
icu.windea.pls.lang.match.ParadoxMatchPipeline.collectCandidates() - 4.848s

icu.windea.pls.lang.match.ParadoxMatchResult$LazyMatch.get(int) - 67.734s
↖icu.windea.pls.lang.match.ParadoxMatchPipeline.filter(List, int) - 64.354s, 95.0%
↖↖icu.windea.pls.lang.util.ParadoxExpressionManager.getConfigs(PsiElement, boolean, int) - 64.354s, 95.0%
↖icu.windea.pls.ep.match.ParadoxScriptExpressionOverriddenMatchOptimizer.optimize(List, ParadoxScriptExpressionMatchOptimizer$Context) - 3.204s, 4.7%
-icu.windea.pls.lang.match.ParadoxMatchResultProvider.forDefinition$lambda$8(Set, PsiElement, Project, String, String) - 28.184s, 41.6%
-icu.windea.pls.lang.match.ParadoxMatchResultProvider.forLocalisation$lambda$10(Set, PsiElement, Project, String) - 21.426s, 31.6%
-icu.windea.pls.lang.match.ParadoxMatchResultProvider.forComplexEnumValue$lambda$15(PsiElement, Project, String, String) - 17.086s, 25.2%

icu.windea.pls.lang.search.ParadoxDefinitionSearcher.processQuery(Object, Processor) - 31.112s
↖icu.windea.pls.lang.match.ParadoxMatchProvider.matchesDefinition(PsiElement, Project, String, String) - 28.184, 90.6%
↖icu.windea.pls.ep.expression.ParadoxScriptDefinitionExpressionSupport.resolve(ParadoxExpressionElement, TextRange, String, CwtConfig, Boolean, boolean) - 1.056s, 3.4%

icu.windea.pls.lang.search.ParadoxLocalisationSearcher.processQuery(Object, Processor) - 36.766s
icu.windea.pls.lang.match.ParadoxMatchProvider.matchesLocalisation(PsiElement, Project, String) - 21.394s， 58.2%
↖icu.windea.pls.lang.util.CwtLocationExpressionManager.createLocalisationResolveResult$lambda$2(ParadoxDefinitionInfo, Project, ParadoxScriptDefinitionElement, Function1, String) - 8.697s, 23.7%
↖↖icu.windea.pls.lang.codeInsight.hints.script.ParadoxDefinitionReferenceHintTextHintsProvider.doCollect(PresentationFactory, ParadoxScriptDefinitionElement, Editor, ParadoxDefinitionReferenceHintTextHintsProvider$Settings) - 5.946s, 16.2%
↖↖icu.windea.pls.script.structureView.ParadoxScriptTreeElement.getLocationString() - 0.944s, 2.6%
↖icu.windea.pls.ep.expression.ParadoxScriptLocalisationExpressionSupport.resolve(ParadoxExpressionElement, TextRange, String, CwtConfig, Boolean, boolean) - 2.840s, 7.7%
↖↖icu.windea.pls.lang.codeInsight.hints.script.ParadoxLocalisationReferenceHintsProvider.collect(PresentationFactory, PsiElement, PsiFile, Editor, ParadoxLocalisationReferenceHintsProvider$Settings, InlayHintsSink) - 2.840s, 7.7% - 这里可以走解析PSI引用

icu.windea.pls.lang.search.ParadoxComplexEnumValueSearcher.processQuery(Object, Processor) - 33.611s
↖icu.windea.pls.lang.match.ParadoxMatchProvider.matchesComplexEnumValue(PsiElement, Project, String, String, String) - 17.070s
↖icu.windea.pls.ep.expression.ParadoxScriptEnumValueExpressionSupport.resolve(ParadoxExpressionElement, TextRange, String, CwtConfig, Boolean, boolean) - 16.541s
-com.intellij.util.indexing.FileBasedIndexEx.lambda$processValuesInOneFile$8(int, FileBasedIndex$ValueProcessor, VirtualFile, InvertedIndexValueIterator) - 28.475s
--com.intellij.openapi.progress.ProgressManager.checkCanceled() - 25.020s

icu.windea.pls.lang.search.ParadoxFilePathSearcher.processQuery(Object, Processor) - 3.252s
↖icu.windea.pls.lang.codeInsight.hints.script.ParadoxModifierIconHintsProvider.lambda 'firstNotNullOfOrNull' in collect() - 1.083s, 33.3%
↖icu.windea.pls.ep.resolve.ImageFileBasedParadoxLocalisationIconSupport.resolve(String, ParadoxLocalisationIcon, Project) - 0.860s, 26.4%
↖icu.windea.pls.ep.expression.ParadoxScriptPathReferenceExpressionSupport.resolve(ParadoxExpressionElement, TextRange, String, CwtConfig, Boolean, boolean) - 0.192s, 5.9%
↖icu.windea.pls.lang.match.ParadoxMatchProvider.matchesPathReference(PsiElement, Project, String, CwtDataExpression) - 0.814s, 25.0% 
-com.intellij.psi.search.FilenameIndex.processFilesByNames(Set, boolean, GlobalSearchScope, IdFilter, Processor) - 2.820s, 86.7%

icu.windea.pls.ep.expression.ParadoxScriptExpressionSupport$INSTANCE.resolve(ParadoxExpressionElement, TextRange, String, CwtConfig, Boolean, boolean) - 20.056s
↖icu.windea.pls.lang.references.script.ParadoxScriptExpressionPsiReference.doResolve() - 16.720s, 83.4%
↖icu.windea.pls.lang.codeInsight.hints.script.ParadoxLocalisationReferenceHintsProvider.collect(PresentationFactory, PsiElement, PsiFile, Editor, Object, InlayHintsSink) - 2.952s, 14.7%
↖icu.windea.pls.lang.util.CwtLocationExpressionManager.resolve(CwtImageLocationExpression, ParadoxScriptDefinitionElement, ParadoxDefinitionInfo, ImageFrameInfo, boolean) - 0.336s, 1.7%
-icu.windea.pls.ep.expression.ParadoxScriptEnumValueExpressionSupport.resolve(ParadoxExpressionElement, TextRange, String, CwtConfig, Boolean, boolean) - 15.648s, 78.0%
-icu.windea.pls.ep.expression.ParadoxScriptLocalisationExpressionSupport.resolve(ParadoxExpressionElement, TextRange, String, CwtConfig, Boolean, boolean) - 2.936s, 14.6%
-icu.windea.pls.ep.expression.ParadoxScriptDefinitionExpressionSupport.resolve(ParadoxExpressionElement, TextRange, String, CwtConfig, Boolean, boolean) - 1.152s, 5.7%

Misc:
icu.windea.pls.ep.expression.ParadoxScriptExpressionSupport$INSTANCE.annotate(ParadoxExpressionElement, TextRange, String, AnnotationHolder, CwtConfig) - 3.036s
icu.windea.pls.lang.util.ParadoxScriptFileManager.getMemberPath(PsiElement, int) - 2.176s
icu.windea.pls.model.paths.impl.ParadoxMemberPathImpl.<init>(List) - 1.264s
icu.windea.pls.ep.config.CwtInjectedConfigProvider$INSTANCE.injectConfigs(CwtMemberConfig, List) - 0.352s
```

结论：
- 考虑优化 `ParadoxLocalisationReferenceHintsProvider`，直接在适用约束后解析PSI引用 ✔

#### 内存优化

| Class                                                                     | Count   | Shallow   | Retained |
|---------------------------------------------------------------------------|---------|-----------|----------|
| icu.windea.pls.config.configGroup.CwtConfigGroup                          | 61      | 2.44 kB   | 82.03 MB |
| icu.windea.pls.config.config.impl.CwtPropertyConfigImpl1                  | 151,977 | 8.51 MB   | 61.67 MB |
| icu.windea.pls.config.config.impl.CwtPropertyConfigImpl2                  | 84,167  | 4.04 MB   | 46.11 MB |
| icu.windea.pls.config.configContext.CwtConfigContext                      | 104,919 | 4.2 MB    | 33.45 MB |
| icu.windea.pls.config.config.impl.CwtPropertyConfigImpl3                  | 98,437  | 4.72 MB   | 27.93 MB |
| icu.windea.pls.config.config.impl.CwtPropertyConfigDelegate2              | 372,145 | 11.91 MB  | 25.43 MB |
| icu.windea.pls.config.config.delegated.impl.CwtAliasConfigImpl 0x8a8a8190 | 56,178  | 1.8 MB    | 24.19 MB |
| icu.windea.pls.model.paths.impl.ParadoxMemberPathImpl                    | 217,903 | 5.23 MB   | 21.1 MB  |
| icu.windea.pls.config.config.impl.CwtValueConfigFromPropertyConfig        | 21,927  | 701.66 MB | 21.01 MB |
| icu.windea.pls.config.config.impl.CwtPropertyConfigImpl4                  | 128,467 | 6.17 MB   | 16.47 MB |
| icu.windea.pls.config.configExpression.impl.CwtDataExpressionImpl         | 196,973 | 6.3 MB    | 14.14 MB |
| icu.windea.pls.model.paths.impl.ParadoxPathImpl1                          | 40,339  | 968.14 kB | 21.31 MB |
| icu.windea.pls.model.ParadoxDefinitionInfo                                | 6,488   | 622.85 kB | 7.92 MB  |

```
All - 1.76 GB
icu.windea.pls - 130.57 MB
``` 

结论：
- 相当一部分内存占用来自已加载的PSI和内嵌提示 
- 考虑仅在需要加入缓存时才 intern memberPath 和 filePath（使用自定义的 `optimized()`） ✔
- 即使是在深拷贝规则后，也要考虑优化子规则列表（使用 `List.optimized()`） ✔

### 测试#7 2025/11/10 v2.0.7

> 测试方法同上（依次打开后，再重新打开项目，循环先前的步骤，数次后会出现明显的卡顿和内存不足的警告）

#### 性能优化

#### 内存优化

```markdown
(count, shallow, retained)

java.lang.Object[] 2,989,547 instances - 141.85 MB, 1.41 GB
-com.intellij.util.CachedValueBase$DefaultData 931,790 instances
-java.util.ArrayList 927,631 instances
-com.intellij.util.keyFMap.ArrayBackedFMap 296,359 instances
-com.google.common.collect.RegularImmutableList 255,869 instances
-com.github.benmanes.caffeine.cache.MpscGrowableArrayQueue 122,210 instances
-com.intellij.util.keyFMap.MapBackedFMap 120,065 instances
-com.github.benmanes.caffeine.cache.BoundedBuffer$RingBuffer 112,339 instances

java.util.ArrayList 1,020,703 instances - 24.5 MB, 448.2 MB
-icu.windea.pls.model.paths.impl.NormalizedParadoxMemberPath 582,198 instances - 多多级路径的缓存可能是不必要的？
-icu.windea.pls.model.paths.impl.NormalizedCwtConfigPath 65,195 instances - 多多级路径的缓存可能是不必要的？
-icu.windea.pls.model.paths.impl.NormalizedParadoxPath 40,535 instances - 多多级路径的缓存可能是不必要的？
-icu.windea.pls.config.configExpression.impl.CwtTemplateExpressionImpl 32,383 instances
-com.intellij.codeInsight.daemon.impl.HighlightInfo 20,389 instances
-icu.windea.pls.config.config.delegated.impl.CwtLinkConfigImpl 17,463 instances
-com.intellij.codeInsight.hints.presentation.SequencePresentation 9,003 instances
-icu.windea.pls.config.config.delegated.impl.CwtTypeConfigImpl 8,207 instances

java.util.concurrent.ConcurrentHashMap 148,820 instances, 9.52 MB, 350.49 MB
-<java.util.concurrent.ConcurrentHashMap 0x8ac25b90 69.41 MB
 data of com.github.benmanes.caffeine.cache.UnboundedLocalCache 0x8ac25b60 69.41 MB
 cache of com.github.benmanes.caffeine.cache.UnboundedLocalCache$UnboundedLocalLoadingCache 0x8ac25b40 69.41 MB
 cache of icu.windea.pls.model.paths.impl.ParadoxMemberPathResolverImplKt 0x8ac25120 183.4 MB
-<java.util.concurrent.ConcurrentHashMap 0x8ac26158 53.49 MB
 data of com.github.benmanes.caffeine.cache.WS 0x8ac25e60 53.49 MB
 cache of com.github.benmanes.caffeine.cache.WeakInterner 0x8ac25e50 53.49 MB
 interner of icu.windea.pls.model.paths.impl.ParadoxMemberPathResolverImplKt 0x8ac25120 183.4 MB
 referent of java.lang.ref.WeakReference 0x8ac263c8 32 B
-<java.util.concurrent.ConcurrentHashMap 0xc3c1bd28 17.01 MB - project user data - 似乎规则分组数据没有被正确地卸载
-<java.util.concurrent.ConcurrentHashMap 0x87ebd708 16.89 MB - application user data

com.google.common.collect.RegularImmutableList 255,869 instances
-icu.windea.pls.config.config.impl.CwtPropertyConfigImplWithPropertyConfigsAndOptionConfigs 80,588 instances
-icu.windea.pls.config.config.impl.CwtPropertyConfigImplWithPropertyConfigs 54,870 instances
-com.intellij.codeInsight.hints.presentation.SequencePresentation 37,258 instances
-icu.windea.pls.config.config.impl.CwtOptionConfigImplNested 28,437 instances
-icu.windea.pls.config.config.impl.CwtPropertyConfigDelegateWithConfigs 10,601 instances
-icu.windea.pls.config.config.impl.CwtPropertyConfigImplWithOptionConfigs 10,444 instances
-icu.windea.pls.config.config.impl.CwtPropertyConfigImplWithValueConfigs 9,068 instances
-kotlin.SynchronizedLazyImpl 8,512 instances
-icu.windea.pls.config.config.impl.CwtValueConfigImplWithOptionConfigs 6,275 instances
-java.util.concurrent.ConcurrentHashMap$Node 4,951 instances
-com.github.benmanes.caffeine.cache.References$SoftValueReference 1,316 instances
-icu.windea.pls.config.config.impl.CwtPropertyConfigImplWithValueConfigsAndOptionConfigs 802 instances
-icu.windea.pls.config.config.impl.CwtPropertyConfigImplWithConfigs 607 instances
-icu.windea.pls.config.config.delegated.impl.CwtLinkConfigImpl 479 instances
-icu.windea.pls.config.config.impl.CwtPropertyConfigImplWithConfigsAndOptionConfigs 442 instances
-java.lang.Object[] 250 instances
-icu.windea.pls.config.config.impl.CwtValueConfigImplWithPropertyConfigsAndOptionConfigs 154 instances
-icu.windea.pls.config.config.impl.CwtFileConfigImplWithPropertyConfigs 87 instances
-icu.windea.pls.config.config.delegated.impl.CwtLocaleConfigImpl 75 instances
-icu.windea.pls.config.config.impl.CwtValueConfigImplWithPropertyConfigs 51 instances
-icu.windea.pls.config.config.impl.CwtValueConfigImplWithValueConfigs 45 instances
-com.google.common.collect.RegularImmutableSortedSet 42 instances
-com.google.common.collect.ImmutableSortedMap 38 instances
-icu.windea.pls.config.config.impl.CwtValueConfigImplWithValueConfigsAndOptionConfigs 21 instances
-icu.windea.pls.config.config.impl.CwtValueConfigDelegateWithConfigs 6 instances

com.github.benmanes.caffeine.cache.BoundedLocalCache$BoundedLocalManualCache 122,196 instances - 2.93 MB, 207.87 MB - 多为被嵌套的缓存

com.github.benmanes.caffeine.cache.UnboundedLocalCache$UnboundedLocalLoadingCache 23 instances - 736 B, 83.26 MB
-<com.github.benmanes.caffeine.cache.UnboundedLocalCache$UnboundedLocalLoadingCache 0x8ac25b40 69.41 MB - size=1048576
 cache of icu.windea.pls.model.paths.impl.ParadoxMemberPathResolverImplKt 0x8ac25120 183.4 MB
-<com.github.benmanes.caffeine.cache.UnboundedLocalCache$UnboundedLocalLoadingCache 0x92b333b8 7.56 MB
 cache of icu.windea.pls.model.paths.impl.CwtConfigPathResolverImplKt 0x8fad0050 26.06 MB
-<com.github.benmanes.caffeine.cache.UnboundedLocalCache$UnboundedLocalLoadingCache 0x89205ee0 1.56 MB
 cache of icu.windea.pls.model.paths.impl.ParadoxPathResolverImplKt 0x89204dc0 8.4 MB

com.github.benmanes.caffeine.cache.WeakInterner 4 instances - 64 B, 74.65 B
-<com.github.benmanes.caffeine.cache.WeakInterner 0x8ac25e50 53.49 MB - size=1048576
 interner of icu.windea.pls.model.paths.impl.ParadoxMemberPathResolverImplKt 0x8ac25120 183.4 MB
-<com.github.benmanes.caffeine.cache.WeakInterner 0x92b335b8 9.07 MB - size=262144
 interner of icu.windea.pls.model.paths.impl.CwtConfigPathResolverImplKt 0x8fad0050 26.06 MB
-<com.github.benmanes.caffeine.cache.WeakInterner 0x89206020 6.84 MB - size=131072
 interner of icu.windea.pls.model.paths.impl.ParadoxPathResolverImplKt 0x89204dc0 8.4 MB
-<com.github.benmanes.caffeine.cache.WeakInterner 0x88b0ddf0 5.24 MB - size=131072
 stringInterner of icu.windea.pls.core.optimizer.OptimizersKt 0x88b0dcc0 5.24 MB

com.intellij.openapi.editor.impl.InlayModelImpl 43 instances - 2.06 kB, 153.25 MB

com.intellij.codeInsight.hints.presentation.WithAttributesPresentation 238,977 instances - 7.65 MB, 169.37 MB
-java.lang.Object[] 84,666 instances
-com.intellij.codeInsight.hints.presentation.OnClickPresentation 80,012 instances
-com.intellij.codeInsight.hints.presentation.DynamicInsetPresentation 54,228 instances
-com.intellij.codeInsight.hints.presentation.InsetPresentation 19,135 instances
-com.intellij.codeInsight.hints.presentation.WithAttributesPresentation 936 instances

icu.windea.pls.config.configGroup.CwtConfigGroup 145 instances - 5.8 kB, 115.02 MB - 应当只有20个，可能存在内存泄露？

icu.windea.pls.config.configContext.CwtConfigContext 94,672 instances - 3.79 MB, 12.18 MB - 主要来自 userData，比如 definitionInfo 和 memberPath

icu.windea.pls.config.config.impl.CwtPropertyConfigImpl 289,598 instances - 13.9 MB, 21.5 MB
icu.windea.pls.config.config.impl.CwtPropertyConfigImplWithOptionConfigs 228,545 instances - 10.97 MB, 30.87 MB
icu.windea.pls.config.config.impl.CwtPropertyConfigImplWithConfigs 2,345 instances - 112.56 kB, 1.38 MB
icu.windea.pls.config.config.impl.CwtPropertyConfigImplWithPropertyConfigs 102,437 instances - 4.92 MB, 46.36 MB
icu.windea.pls.config.config.impl.CwtPropertyConfigImplWithPropertyConfigsAndOptionConfigs 144,562 instances - 6.94 MB, 50.15 MB
icu.windea.pls.config.config.impl.CwtPropertyConfigImplWithValueConfigs 32,472 instances - 1.56 MB, 5.35 MB
icu.windea.pls.config.config.impl.CwtPropertyConfigImplWithValueConfigsAndOptionConfigs 8,500 instances - 408 kB, 1.76 MB
icu.windea.pls.config.config.impl.CwtPropertyConfigDelegate 259,555 instances - 8.31 MB, 19.31 MB
icu.windea.pls.config.config.impl.CwtPropertyConfigDelegateWithConfigs 18,981 instances - 607.39 kB, 5.55 MB
icu.windea.pls.config.config.impl.CwtValueConfigImpl 106,210 instances - 4.25 MB, 4.26 MB
icu.windea.pls.config.config.impl.CwtValueConfigImplWithOptionConfigs 19,055 instances - 914.64 kB, 1.98 MB
icu.windea.pls.config.config.impl.CwtValueConfigFromPropertyConfig 30,320 instances - 970.24 kB, 10.89 MB
icu.windea.pls.config.config.impl.CwtValueConfigDelegate 2,931 instances - 70.34 kB, 172.46 kB
icu.windea.pls.config.config.impl.CwtOptionConfigImpl 946 instances - 22.7 kB, 22.7 kB
icu.windea.pls.config.config.impl.CwtOptionConfigImplNested 58,348 instances - 1.4 MB, 3.37 MB
icu.windea.pls.config.config.impl.CwtOptionValueConfigImpl 317 instances - 7.61 kB, 7.61 kB

icu.windea.pls.config.configExpression.impl.CwtDataExpressionImpl 93,131 instances - 2.98 MB, 5.41 MB

icu.windea.pls.model.paths.impl.NormalizedParadoxMemberPath 610,721 instances - 14.66 MB, 49.15 MB
icu.windea.pls.model.paths.impl.NormalizedCwtConfigPath 79,957 instances - 1.92 MB, 5.65 MB
icu.windea.pls.model.paths.impl.NormalizedParadoxPath 40,586 instances - 974.06 kB, 3.43 MB
```

结论：
- 对于路径信息的缓存，可能是不必要的，或者考虑限制上限或超时✔（改为不再缓存路径信息自身）
- 被嵌套的缓存应当只使用 `ConcurrentHashMap`，避免占用过多内存 ✔
- 优化器中使用的不可变的单例集合，改为使用 Guava 的（32b -> 24b） ✔

**Duplicated Strings**

| Value                                            | Duplicates | Wasted (Bytes) |
|--------------------------------------------------|------------|----------------|
| {...}	                                           | 7817	      | 187608         |
|                                                  | 4892	      | 117408         |
| true	                                            | 2030	      | 48720          |
| .	                                               | 1995	      | 47880          |
| name	                                            | 1991	      | 47784          |
| filePath	                                        | 1945	      | 46680          |
| com.intellij	                                    | 1915	      | 45960          |
| id                                               | 	1648      | 	39552         |
| has_country_flag	                                | 1619	      | 38856          |
| trigger	                                         | 1525	      | 36600          |
| <init>	                                          | 1415	      | 33960          |
| limit	                                           | 1383	      | 33192          |
| GetName	                                         | 1355	      | 32520          |
| country_event	                                   | 1308	      | 31392          |
| yes	                                             | 1265	      | 30360          |
| option	                                          | 1256	      | 30144          |
| jar:file:...!/icons/expui/gutter/definition.svg	 | 1175	      | 28200          |
| value	                                           | 1151	      | 27624          |
| ab9368bb:PsiFileNode	                            | 1125	      | 27000          |
| false	                                           | 1005	      | 24120          |

- `{...}` - 不知道是从哪里来的，看起来插件中已经去重了。
- `GetName` - 可能主要来自内嵌提示？
- `yes` - 布尔值，之后再评估是否有必要去重。
- `jar:file:...!/icons/expui/gutter/definition.svg` - 待分析和评估。

#### 内存优化 2

```
com.google.common.collect.RegularImmutableList 454,217 instances - 7.27 MB, 225.46 MB

com.intellij.openapi.editor.impl.InlayModelImpl 38 instances - 1.82 kB, 184.59 MB
com.intellij.codeInsight.hints.InlineInlayRenderer 82,614 instances - 2.64 MB, 267.62 MB
com.intellij.openapi.editor.impl.InlineInlayImpl 82,614 instances - 4.63 MB, 274.22 MB

com.intellij.codeInsight.daemon.RelatedItemLineMarkerInfo 12,393 instances - 892.3 kB, 18.26 MB

icu.windea.pls.script.psi.impl.ParadoxScriptPropertyImpl 153,059 instances - 4.9 MB, 103.03 MB
icu.windea.pls.script.psi.impl.ParadoxScriptPropertyKeyImpl 143,803 instances - 4.6 MB, 225.56 MB
icu.windea.pls.script.psi.impl.ParadoxScriptBooleanImpl 17,062 instances - 409.49 kB, 27.28 MB
icu.windea.pls.script.psi.impl.ParadoxScriptIntImpl 5,984 instances - 143.62 kB, 15.33 MB
icu.windea.pls.script.psi.impl.ParadoxScriptFloatImpl 747 instances - 17.93 kB, 1.93 MB
icu.windea.pls.script.psi.impl.ParadoxScriptStringImpl 58,505 instances - 1.87 MB, 162.62 MB
icu.windea.pls.script.psi.impl.ParadoxScriptBlockImpl 61,149 instances - 1.47 MB, 111.45 MB
icu.windea.pls.script.psi.impl.ParadoxScriptScriptedVariableReferenceImpl 2,302 instances - 55.25 kB, 3.32 MB

icu.windea.pls.localisation.psi.impl.ParadoxLocalisationPropertyImpl 228,591 instances - 7.31 MB, 18.41 MB

icu.windea.pls.model.paths.impl.NormalizedParadoxMemberPath 289,838 instances - 6.96 MB, 19.76 MB
icu.windea.pls.model.paths.impl.NormalizedParadoxPath 4,252 instances - 102.05 kB, 307.12 kB

icu.windea.pls.config.configGroup.CwtConfigGroup 33 instances - 1.32 kB, 36.11 MB - 20个有数据的规则分组（这是符合预期的），以及一些未被回收的临时规则分组
icu.windea.pls.config.configGroup.CwtConfigGroupService 5 instances - 120 B, 15.56 MB
icu.windea.pls.config.configContext.CwtConfigContext 145,759 instances - 5.83 MB, 38.12 MB
icu.windea.pls.model.ParadoxDefinitionInfo 4,108 instances - 394.37 kB, 4.47 MB

total: ~=130 MB for member configs and option member configs
icu.windea.pls.config.config.impl.CwtPropertyConfigImplWithPropertyConfigsAndOptionConfigs 132,198 instances - 6.35 MB, 36.88 MB
icu.windea.pls.config.config.impl.CwtPropertyConfigDelegate 374,965 instances - 12 MB, 24.79 MB
icu.windea.pls.config.config.impl.CwtPropertyConfigImplWithPropertyConfigs 57,708 instances - 2.77 MB, 21.49 MB
icu.windea.pls.config.config.impl.CwtPropertyConfigImplWithOptionConfigs 78,553 instances - 3.77 MB, 16.09 MB
```

## 全局代码检查时

> 以下是启用插件提供的绝大部分代码检查的情况下对Stellaris游戏目录进行一次完整的全局代码检查之后的统计数据

### 测试#1 2024/8/29 V1.3.20

#### 性能优化

#### 内存优化

```
Class Count Shallow Retained
icu.windea.pls.config.configGroup.CwtConfigGroup 11 440B 44.51MB
icu.windea.pls.localisation.psi.ParadoxLocalisationFile 69 69 4.42KB 22.89MB
icu.windea.pls.model.elementInfo.ParadoxModifierInfo 4,612 147.58KB 11.32MB
icu.windea.pls.config.CwtConfigContext 23,043 921.72KB 10.15MB
icu.windea.pls.model.ParadoxFileInfo 32,696 1.05MB 9.46MB
```

## 文件解析

### CWT文件

#### 测试#1 2025/5/4 V1.4.0-PRE 

> - 重新打开Stellaris游戏目录（此后插件会在后台自动解析规则），等待1分钟，检查解析CWT文件的耗时
> - 使用优化后的parser和lexer
> - 懒解析选项注释

```
icu.windea.pls.cwt.parser.CwtParser.parse(IElementType, PsiBuilder) - 364ms, 5.6% of all
```

结论：

- 解析速度很快，不需要考虑进一步优化性能
- 经过初步测试，很快就能完成文件的重新解析
- 也许不需要懒解析选项注释？（但是懒解析应该能提高重新解析的性能）

## 兼容性

### 备注

```
since 223-EAP, call 'VfsUtil.findFile(Path, boolean)' may cause:
java.lang.Throwable: Slow operations are prohibited on EDT. See SlowOperations.assertSlowOperationsAreAllowed javadoc.
```