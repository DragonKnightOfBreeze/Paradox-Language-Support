# 笔记：问题记录

## 问题记录

### 来自调试

- [X] 需要兼容整行或多行参数值中对双引号的特别转义
- [X] 需要兼容本地化文本中对左方括号的转义（`[[`）
- [ ] 在`PARAM = xxx`后面输入回车会产生不正确的自动缩进（应当与语言注入有关）
- [ ] `QuoteIdentifierIntention`和`UnquoteIdentifierIntention`不直接适用于用引号括起的参数值中的那些字面量（例如，`p = "\"v\""`中的`\"v\"`）
- [ ] 对于用引号括起的参数值中的那些字面量（例如，`p = "\"v\""`中的`\"v\"`），如果用引号括起，由于已被转义一次，会导致中断规则匹配 - IDEA自身BUG？
- [ ] 进行代码补全时，考虑优先补全那些不需要访问索引的，能够比较快速地计算出结果的项
- [ ] 有时脚本文件中的路径引用会无法解析，不知为何？

### 来自 Github 仓库

- [X] 无法及时检测项目本地的规则文件的更改？ - 基本修复？
- [ ] 无法正确注入`on_action`中事件引用的事件类型？ - 未复现，很神奇
- [ ] 重新打开项目后，IDE无法完成对脚本文件的解析？ - 可能是内存不足导致
- [ ] `scope[species]`应当始终可以匹配`this` - 如果无法准确匹配，需要直接匹配同类型的第一个规则 - 待验证
- [X] 作用域上下文的内嵌提示显示有问题 - 应当显示在`possible = {`后面，且要求`{`之后不存在空白以外的字符
- [X] `some_trigger = value`中的`value`不应当被特别高亮

### 来自 CWTools 的 Github 仓库

- [X] [The tool cannot recognize in-script flag variables (Vic3) · Issue #76 · cwtools/cwtools-vscode (github.com)](https://github.com/cwtools/cwtools-vscode/issues/76)
- [X] [[Stellaris\] Could support tech@level grammar? · Issue #58 · cwtools/cwtools-vscode (github.com)](https://github.com/cwtools/cwtools-vscode/issues/58)
- [X] [Parsing issues in Vic3 · Issue #53 · cwtools/cwtools (github.com)](https://github.com/cwtools/cwtools/issues/53)

## 问题分析

### （已解决）索引时报错 `Indexing process should not rely on non-indexed file data.`

堆栈：[stack_trace_1](assets/stack_trace_1.txt)

推测：

索引文件时使用到了未索引的数据。即使使用懒加载的数据，仍然可能无法避免。需要持续追踪与优化。

### （不再复现）`ParadoxExpressionManager.getExpressionReferences` 中使用的缓存可能不一致的问题

堆栈：[stack_trace_2](assets/stack_trace_2.txt)

推测：

不好复现，可能是因为正在索引，不同线程中得到的来自索引的数据不同，因而最终解析得到的引用（`PsiReference`）列表不一致。

### （不再复现）涉及内联脚本与适用语言注入的参数时，IDE可能卡死的问题

堆栈：[stack_trace_3](assets/stack_trace_3.txt)

```
is@stellaris:0#0#astral_rift/unlock_from_pool_if_relic_not_owned:if/limit/prev/NOT

WAITING
< icu.windea.pls.config.CwtConfigContext.getConfigs
 < icu.windea.pls.lang.index.ParadoxDynamicValueIndexSupport.indexScriptElement
 < icu.windea.pls.lang.index.ParadoxParameterIndexSupport.indexScriptElement
 < icu.windea.pls.lang.index.ParadoxLocalisationParameterParameterIndexSupport.indexScriptElement
```

结论：

应当是调用`LoadingCache.get`或者`ConcurrentMap.computeIfAbsent`导致，尝试改为调用`ConcurrentMap.getOrPut`，避免改变锁行为

### （应当已解决）进行全局代码检查时，偶发误判的 *无法解析的值表达式* 报错

全局代码检查的结果中，可能会报错 *无法解析值表达式 '20'，期望 '{...}'*。
如果重新打开项目，或者更改文件，则报错消失。

```paradox_script
size = 20
```

```cwt
## cardinality = 0..inf
size = int
## cardinality = 0..inf
size = { min = int max = int }
```

2025.11.08
- 可能来自 `ParadoxScriptExpressionBlockMatchOptimizer.optimize` 的实现或调用
- 涉及这种情况的匹配结果有时是不稳定的

2025.11.10
- 在执行后续优化后，`PlsStates.dynamicContextConfigs` 未正确设置导致的
- 需要考虑执行后续优化的时机

### 索引时的偶发报错，涉及解析定义的子类型和内联脚本

堆栈：[stack_trace_4](assets/stack_trace_4.txt)

### （已解决）来自的 `ParadoxTextBasedTargetSearcher` 和 fastutil 的索引越界异常

堆栈：[stack_trace_5](assets/stack_trace_5.txt)

结论：

需要使用并发集合，避免在 IntelliJ 并发检索过程中发生非线程安全的 rehash 异常。

### （已解决）`Indexing process should not rely on non-indexed file data.` 对于子定义

堆栈：[stack_trace_6](assets/stack_trace_6.txt)

```
	at icu.windea.pls.lang.resolve.ParadoxDefinitionService.resolveSubtypeConfigs(ParadoxDefinitionService.kt:74) <- 可能需要访问尚未索引的父定义
	at icu.windea.pls.lang.resolve.ParadoxDefinitionService.resolveDeclaration(ParadoxDefinitionService.kt:80)
	at icu.windea.pls.model.ParadoxDefinitionInfo.doGetDeclaration(ParadoxDefinitionInfo.kt:96)
	at icu.windea.pls.model.ParadoxDefinitionInfo.getDeclaration(ParadoxDefinitionInfo.kt:67)
	at icu.windea.pls.ep.configContext.CwtBaseConfigContextProvider.getCacheKey(CwtConfigContextProviders.kt:79)
```

结论：

`ParadoxDefinitionService.resolveSubtypeConfigs` 中需要检查 `ParadoxMatchOptions.SkipIndex`，如果已设置则需要避免访问其他索引

### 定义信息的缓存不一致的问题

堆栈：[stack_trace_7](assets/stack_trace_7.txt)

需要研究，但并不紧急。

### 涉及定义引用的脚本表达式的用法高亮不正确的问题

```
# {link} = {link}:{definition}
religion = religion:catholic
```

分析：
- 光标放到 `religion:` 上时，可能会错误地高亮 `catholic`
- 光标放到 `catholic` 上时，可能会错误地高亮 `religion:`
- 光标放到 `religion:catholic` 的结尾时，可以正确地高亮 `catholic`
- 似乎仅在涉及到对定义的引用时，才可能出现这个问题
- 可能与 `PsiReference.isReferenceTo` 有关？
- 可能与 `referencesSearch` 有关？