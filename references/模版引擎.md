# 模版引擎（Prompt Template Engine）

> 面向插件作者、协作者与用户的说明文档。

PLS 内置的模版引擎用于渲染用于 AI 提示（prompt）的 Markdown 模版，支持占位符替换与少量注释指令，具备轻量、可读、可组合的特性。

- **入口类**：`icu.windea.pls.ai.prompts.PromptTemplateEngine`
- **模版接口**：`icu.windea.pls.ai.prompts.PromptTemplate`
- **实现类**：`icu.windea.pls.ai.prompts.PromptTemplateImpl`
- **加载器**：`icu.windea.pls.ai.prompts.PromptTemplateLoader`
  - `ClasspathPromptTemplateLoader`
  - `FilePromptTemplateLoader`

## 语法概览

- **占位符**：`{{ var }}`
  - 在最终渲染阶段一次性替换。
  - 未提供变量时保留原样，便于发现遗漏。
- **指令**（位于 HTML 注释中）：`<!-- @directive args... -->`
  - 指令名严格匹配正则：`[a-z-]+`
  - 目前内置：
    - `@include path`（内联型）
    - `@if expr`、`@elseif expr`、`@else`、`@endif`（块级）

## include 指令

- 语法：`<!-- @include path -->`
- 行为：在当前位置插入目标文件渲染后的内容。
- 路径：相对于当前模版文件路径解析（支持 `.`/`..`）。
- 循环检测：基于 include 栈进行循环检测，检测到循环时跳过并告警。
- 深度限制：`PromptTemplateEngine.maxIncludeDepth`（默认 16）。
- 失败场景（会告警，移除指令）：
  - 缺少路径参数；
  - 目标文件不存在；
  - 发生循环；
  - 深度超限（此时不保留指令后的换行）。
- 换行规则：
  - 若指令位于行尾且下一个片段不是“行首指令”，则在成功包含后按需补一个换行；
  - 对于缺参/循环/文件不存在，保留一个空行；
  - 对于深度超限，不保留空行。

示例：
```md
Before
<!-- @include parts/header.md -->
After
```

## 条件指令：if / elseif / else / endif

- 语法：
  - `<!-- @if expr --> ... <!-- @endif -->`
  - `<!-- @elseif expr -->`、`<!-- @else -->` 可用作 `@if` 的顶层分支。
- 表达式：
  - 支持 `var` 与 `!var` 两种形式。
  - 真值规则：
    - `null`/`false` 为假；
    - 数字 `0` 为假，非 0 为真；
    - 字符串：去首尾空白后，空串、`"0"`、`"false"`（大小写不敏感）为假，其他为真；
    - 集合/映射：空为假，非空为真；
    - 其他类型：为真。
- 嵌套：支持任意嵌套。`elseif`/`else` 的切分仅在当前 `if` 的顶层生效。
- 错误处理：
  - `@if` 缺表达式：移除指令并告警；
  - 未匹配的 `@if`：移除指令并告警，块内容保留为普通文本；
  - 未识别的/悬挂的 `@elseif`/`@else`/`@endif`：移除指令并告警；
  - `@else`/`@endif` 带多余参数：忽略多余参数并告警。
- 换行规则（简述）：
  - 指令位于行首时，渲染前会为“前一行”补一个换行（若已存在则不重复），以确保语义上的独立行；
  - 分支渲染完后，若 `@endif` 处于行首，会在块尾按需补一个换行（避免重复换行）。

示例：
```md
A
<!-- @if flag -->
T
<!-- @else -->
F
<!-- @endif -->
B
```

## 未知指令与严格匹配

- 若注释以 `@` 开头但未匹配任何内置指令，则：
  - 原样输出该注释；
  - 在日志中给出警告（带路径与索引）。
- 指令名需严格匹配正则 `[a-z-]+`，否则按“未知指令”。

## 日志与定位

- 为每条指令分配唯一索引并在日志中输出，格式：`[path@index#Lline]`。
- 常见告警：
  - `Invalid directive`（参数缺失/表达式非法）；
  - `Ignore extra args for directive`（多余参数被忽略）；
  - `Detected include cycle`（包含循环）；
  - `Max include depth exceeded`（深度超限）；
  - `Danging directive`（悬挂指令）；
  - `Unmatched @if without @endif`（未配对的 if）；
  - `Invalid or unknown directive`（未知指令）。

## 占位符替换

- 语法：`{{ var }}`
- 替换时机：在所有指令处理完成后，一次性替换。
- 未提供变量时保留原样。

示例：
```md
Hello, {{ name }}!
```

## 与行尾换行相关的行为（总结）

为了保证可读性与与既有内容的一致性，本引擎对“指令所在行的尾部换行”采取统一处理策略：

- 在内部统一计算是否需要追加换行（Always / IfMissing / None），并在指令处理结束后统一应用；
- 这使得在不同指令处理路径（成功/失败、分支/非分支）下的换行一致且可预测；
- 关键要点：
  - include 成功：若在行尾且后面不是行首指令，则“缺失才补”；
  - include 失败（缺参/循环/文件不存在）：若在行尾且后面不是行首指令，则“总是补”；
  - include 深度超限：不补；
  - if 块收束（`@endif` 行首且有分支输出）：若后面不是行首指令，则“缺失才补”；
  - 未知指令：若后面不是行首指令，则补一个换行。

## 示例

include 链与循环检测：

```md
Start
<!-- @include a.md -->
End
```

嵌套分支：

```md
Start
<!-- @if a -->
A1
<!-- @if b -->
AB
<!-- @elseif c -->
AC
<!-- @else -->
AE
<!-- @endif -->
<!-- @elseif d -->
D1
<!-- @else -->
E1
<!-- @endif -->
End
```

## 约束与最佳实践

- 指令请独占一行，便于读写与换行控制；
- include 使用相对路径，避免跨层过深；
- 条件表达式保持原子，复杂条件由调用方计算好变量再传入；
- 合理设置 `maxIncludeDepth` 以防止递归包含导致的性能问题。

## 版本与兼容性

- 单测覆盖：占位符、条件、include、多余参数、未知指令、深度限制、复杂嵌套、换行策略；
- 如需扩展指令，可在 `PromptTemplateDirectiveRegistry` 中注册新指令并实现解析与渲染规则。